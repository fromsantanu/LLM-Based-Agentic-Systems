# ğŸ“˜ Chapter 9: Creating a Vector Search Function (`match_documents`)

So far, we **understand vector search**.
Now we make it **easy and reusable** by creating a **SQL function**.

Think of a function like a **remote control button**:

* One press
* Complex work happens inside

---

## 1. Why Do We Need a Search Function?

If we write long SQL every time:

* It becomes messy
* Hard to reuse
* Easy to make mistakes

A function lets us:

* Call vector search with **one simple command**
* Use it from **Python, JavaScript, n8n**
* Keep logic in one place

---

## 2. What Is a SQL Function? (Very Simple)

A SQL function is:

> A **named set of instructions** stored in the database.

Example idea:

* Input â†’ search text embedding
* Output â†’ best matching documents

---

## 3. What Will `match_documents` Do?

Our function will:

1. Take a **query embedding**
2. Compare it with stored embeddings
3. Use **cosine similarity**
4. Return the **top matches**
5. Optionally filter using metadata

All inside **Supabase**, powered by **PostgreSQL**.

---

## 4. Function Inputs (Parameters)

We will pass **three simple things**:

1. `query_embedding`

   * The embedding of search text

2. `match_count`

   * How many results we want (e.g., 5)

3. `filter`

   * Metadata filter (optional)

---

## 5. The Complete SQL Function (Standard Version)

Copy this **slowly and carefully** into the **SQL Editor**.

```sql
create or replace function match_documents (
  query_embedding vector(384),
  match_count int,
  filter jsonb default '{}'
)
returns table (
  id bigint,
  content text,
  metadata jsonb,
  similarity float
)
language sql
as $$
  select
    d.id,
    d.content,
    d.metadata,
    1 - (d.embedding <=> query_embedding) as similarity
  from documents d
  where d.metadata @> filter
  order by d.embedding <=> query_embedding
  limit match_count;
$$;
```

---

## 6. Line-by-Line Explanation (Very Important)

Letâ€™s explain this **like teaching a beginner clerk**.

---

### `create or replace function match_documents`

* Creates a function named `match_documents`
* If it already exists â†’ replace it safely

---

### `query_embedding vector(384)`

* Input: search embedding
* Must be **same size as table embedding**

---

### `match_count int`

* How many results you want
* Example: 5 or 10

---

### `filter jsonb default '{}'`

* Metadata filter
* Empty `{}` means â€œno filteringâ€

---

### `returns table (...)`

The function will return:

* `id` â†’ row ID
* `content` â†’ text chunk
* `metadata` â†’ extra info
* `similarity` â†’ how close the meaning is

---

### `1 - (embedding <=> query_embedding)`

* `<=>` calculates cosine distance
* `1 - distance` converts it to **similarity score**
* Higher score = better match

---

### `metadata @> filter`

* Applies metadata filtering
* Example:

```json
{"topic":"cardiology"}
```

---

### `order by embedding <=> query_embedding`

* Sort by closest meaning first

---

### `limit match_count`

* Return only top results

---

## 7. How to Call the Function (Conceptual)

Imagine you already have a query embedding.

```sql
select * from match_documents(
  '[0.12, 0.67, 0.45, ...]',
  5,
  '{"topic":"cardiology"}'
);
```

This means:

* Find 5 most similar cardiology documents

---

## 8. Why This Function Is So Important

Because:

* n8n expects a function
* Supabase client expects a function
* Chatbots need a clean interface
* You avoid raw SQL everywhere

ğŸ“Œ Almost all Supabase vector apps use this pattern.

---

## 9. Common Errors and Fixes

### âŒ Function not found

ğŸ‘‰ You didnâ€™t run the SQL
ğŸ‘‰ Or schema mismatch

---

### âŒ Dimension mismatch

ğŸ‘‰ Query embedding size â‰  384

---

### âŒ Empty results

ğŸ‘‰ Metadata filter too strict
ğŸ‘‰ Try `{}` first

---

## 10. Mental Picture to Remember

ğŸ§  Query text
ğŸ”¢ Query embedding
ğŸ› `match_documents()`
ğŸ“‹ Best results

---

## âœ… Chapter 9 Summary

* SQL functions simplify vector search
* `match_documents` is a reusable search function
* It uses cosine similarity
* Supports metadata filtering
* Required for Supabase + n8n + chatbots
* One function = many use cases

---



