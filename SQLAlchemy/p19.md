# **Chapter 19: Advanced Projects**

In this chapter, we will bring together everything learned so far in the SQLAlchemy tutorial to build **real-world, end-to-end applications**. These projects integrate **SQLAlchemy ORM**, **Alembic migrations**, and **FastAPI** for API development â€” representing production-grade use cases.

---

## **1. Healthcare Patient Record System (Multi-table ORM)**

### **Overview**

A healthcare application that manages patients, doctors, appointments, and prescriptions.
This example demonstrates **multi-table relationships**, **foreign keys**, and **cascade behavior**.

---

### **1.1. Database Schema**

| Table           | Description                                     |
| --------------- | ----------------------------------------------- |
| `patients`      | Stores patient information                      |
| `doctors`       | Stores doctor details                           |
| `appointments`  | Links patients with doctors                     |
| `prescriptions` | Stores medicines prescribed during appointments |

---

### **1.2. ORM Models**

```python
from sqlalchemy import Column, Integer, String, ForeignKey, DateTime, Text
from sqlalchemy.orm import relationship, declarative_base
from datetime import datetime

Base = declarative_base()

class Patient(Base):
    __tablename__ = "patients"
    id = Column(Integer, primary_key=True)
    name = Column(String(100))
    age = Column(Integer)
    gender = Column(String(10))
    appointments = relationship("Appointment", back_populates="patient", cascade="all, delete")

class Doctor(Base):
    __tablename__ = "doctors"
    id = Column(Integer, primary_key=True)
    name = Column(String(100))
    specialization = Column(String(100))
    appointments = relationship("Appointment", back_populates="doctor")

class Appointment(Base):
    __tablename__ = "appointments"
    id = Column(Integer, primary_key=True)
    date = Column(DateTime, default=datetime.utcnow)
    patient_id = Column(Integer, ForeignKey("patients.id"))
    doctor_id = Column(Integer, ForeignKey("doctors.id"))
    prescriptions = relationship("Prescription", back_populates="appointment", cascade="all, delete")
    
    patient = relationship("Patient", back_populates="appointments")
    doctor = relationship("Doctor", back_populates="appointments")

class Prescription(Base):
    __tablename__ = "prescriptions"
    id = Column(Integer, primary_key=True)
    appointment_id = Column(Integer, ForeignKey("appointments.id"))
    medicine_name = Column(String(100))
    dosage = Column(String(50))
    instructions = Column(Text)
    appointment = relationship("Appointment", back_populates="prescriptions")
```

---

### **1.3. Example CRUD Operations**

```python
from sqlalchemy.orm import Session
from sqlalchemy import create_engine

engine = create_engine("sqlite:///healthcare.db")
Base.metadata.create_all(engine)

session = Session(engine)

# Add patient and doctor
patient = Patient(name="John Doe", age=34, gender="Male")
doctor = Doctor(name="Dr. Smith", specialization="Cardiology")

appointment = Appointment(patient=patient, doctor=doctor)
prescription = Prescription(
    appointment=appointment,
    medicine_name="Aspirin",
    dosage="75 mg",
    instructions="Take one daily after food"
)

session.add_all([patient, doctor, appointment, prescription])
session.commit()
```

---

### **1.4. Key Concepts Demonstrated**

* One-to-many and many-to-one relationships.
* Cascading deletes.
* Multi-table querying with joins.
* Real-world healthcare data schema design.

---

## **2. E-commerce Order Management System**

### **Overview**

A simplified backend for an e-commerce platform managing users, products, orders, and payments.

---

### **2.1. Database Schema**

| Table         | Description                              |
| ------------- | ---------------------------------------- |
| `users`       | Customer details                         |
| `products`    | Product catalog                          |
| `orders`      | Customer orders                          |
| `order_items` | Individual product entries within orders |
| `payments`    | Payment details linked to orders         |

---

### **2.2. ORM Models**

```python
from sqlalchemy import Column, Integer, String, Float, ForeignKey, DateTime
from sqlalchemy.orm import relationship
from datetime import datetime

class User(Base):
    __tablename__ = "users"
    id = Column(Integer, primary_key=True)
    name = Column(String(100))
    email = Column(String(100), unique=True)
    orders = relationship("Order", back_populates="user", cascade="all, delete")

class Product(Base):
    __tablename__ = "products"
    id = Column(Integer, primary_key=True)
    name = Column(String(100))
    price = Column(Float)
    stock = Column(Integer)
    order_items = relationship("OrderItem", back_populates="product")

class Order(Base):
    __tablename__ = "orders"
    id = Column(Integer, primary_key=True)
    user_id = Column(Integer, ForeignKey("users.id"))
    order_date = Column(DateTime, default=datetime.utcnow)
    total_amount = Column(Float)
    
    user = relationship("User", back_populates="orders")
    items = relationship("OrderItem", back_populates="order", cascade="all, delete")
    payment = relationship("Payment", uselist=False, back_populates="order")

class OrderItem(Base):
    __tablename__ = "order_items"
    id = Column(Integer, primary_key=True)
    order_id = Column(Integer, ForeignKey("orders.id"))
    product_id = Column(Integer, ForeignKey("products.id"))
    quantity = Column(Integer)
    price = Column(Float)

    order = relationship("Order", back_populates="items")
    product = relationship("Product", back_populates="order_items")

class Payment(Base):
    __tablename__ = "payments"
    id = Column(Integer, primary_key=True)
    order_id = Column(Integer, ForeignKey("orders.id"))
    status = Column(String(20))
    payment_method = Column(String(50))
    order = relationship("Order", back_populates="payment")
```

---

### **2.3. Creating Orders**

```python
u1 = User(name="Alice", email="alice@example.com")
p1 = Product(name="Laptop", price=80000, stock=5)
p2 = Product(name="Mouse", price=1200, stock=15)

order = Order(user=u1, total_amount=81200)
item1 = OrderItem(order=order, product=p1, quantity=1, price=p1.price)
item2 = OrderItem(order=order, product=p2, quantity=1, price=p2.price)
payment = Payment(order=order, status="Completed", payment_method="Credit Card")

session.add_all([u1, p1, p2, order, item1, item2, payment])
session.commit()
```

---

### **2.4. Key Concepts Demonstrated**

* Nested relationships and one-to-one (Order â†’ Payment).
* Transactional inserts.
* Handling stock and product relations.
* Enforcing data integrity and cascading relationships.

---

## **3. FastAPI + SQLAlchemy + Alembic Full-Stack App**

### **Overview**

We will now integrate everything into a full-stack REST API setup.

**Key Technologies**

* **FastAPI** â€” web framework for building APIs
* **SQLAlchemy ORM** â€” for database models
* **Alembic** â€” for database migrations
* **Pydantic** â€” for request/response models

---

### **3.1. Folder Structure**

```
health_api/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ main.py
â”‚   â”œâ”€â”€ db/
â”‚   â”‚   â”œâ”€â”€ base.py
â”‚   â”‚   â”œâ”€â”€ session.py
â”‚   â”‚   â””â”€â”€ models/
â”‚   â”‚       â”œâ”€â”€ patient.py
â”‚   â”‚       â””â”€â”€ doctor.py
â”‚   â”œâ”€â”€ routers/
â”‚   â”‚   â”œâ”€â”€ patients.py
â”‚   â”‚   â””â”€â”€ doctors.py
â”‚   â”œâ”€â”€ schemas/
â”‚   â”‚   â”œâ”€â”€ patient_schema.py
â”‚   â”‚   â””â”€â”€ doctor_schema.py
â”‚   â”œâ”€â”€ repositories/
â”‚   â”‚   â”œâ”€â”€ patient_repo.py
â”‚   â”‚   â””â”€â”€ doctor_repo.py
â”‚   â””â”€â”€ services/
â”‚       â”œâ”€â”€ patient_service.py
â”‚       â””â”€â”€ doctor_service.py
â””â”€â”€ alembic/
    â”œâ”€â”€ versions/
    â””â”€â”€ env.py
```

---

### **3.2. Example FastAPI Route**

```python
# app/routers/patients.py
from fastapi import APIRouter, Depends
from sqlalchemy.orm import Session
from app.db.session import get_db
from app.db.models.patient import Patient
from app.schemas.patient_schema import PatientCreate, PatientOut

router = APIRouter(prefix="/patients", tags=["Patients"])

@router.post("/", response_model=PatientOut)
def create_patient(patient: PatientCreate, db: Session = Depends(get_db)):
    new_patient = Patient(name=patient.name, age=patient.age, gender=patient.gender)
    db.add(new_patient)
    db.commit()
    db.refresh(new_patient)
    return new_patient
```

---

### **3.3. Example Pydantic Schema**

```python
# app/schemas/patient_schema.py
from pydantic import BaseModel

class PatientCreate(BaseModel):
    name: str
    age: int
    gender: str

class PatientOut(PatientCreate):
    id: int
    class Config:
        orm_mode = True
```

---

### **3.4. Running the Application**

```bash
# Create database and tables
alembic init alembic
alembic revision --autogenerate -m "Initial migration"
alembic upgrade head

# Start FastAPI app
uvicorn app.main:app --reload
```

**Access API Docs:**
ðŸ‘‰ [http://127.0.0.1:8000/docs](http://127.0.0.1:8000/docs)

---

### **3.5. Key Concepts Demonstrated**

* Full CRUD API with SQLAlchemy ORM.
* Automatic migrations with Alembic.
* Modular app architecture for scalability.
* API validation using Pydantic.
* Database session dependency injection.

---

## **Summary**

| Project               | Highlights                                             |
| --------------------- | ------------------------------------------------------ |
| **Healthcare System** | Multi-table ORM, cascade, relationships                |
| **E-commerce System** | One-to-one & many-to-many, transactional integrity     |
| **Full-Stack API**    | FastAPI integration, Alembic migration, modular design |

---


