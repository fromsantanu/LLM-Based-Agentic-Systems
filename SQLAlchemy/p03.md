# **Chapter 3: SQLAlchemy Core Basics**

---

## **3.1 Introduction to SQLAlchemy Core**

SQLAlchemy provides two major layers for database interaction:

1. **Core** — focuses on **SQL Expression Language** (manual control using SQL-like Python code).
2. **ORM (Object Relational Mapper)** — focuses on working with **Python classes mapped to tables**.

In this chapter, we’ll focus on the **Core layer**, which provides powerful tools to:

* Define tables and columns
* Execute raw SQL or SQL-like expressions
* Insert, update, and delete data

---

## **3.2 Understanding MetaData and Table Objects**

### **MetaData**

`MetaData` is a container object that stores information about tables, their columns, and relationships.
It acts as a catalog of your database structure.

```python
from sqlalchemy import MetaData

metadata = MetaData()
```

Think of `MetaData` as a **blueprint manager** for your database schema.

---

### **Table Object**

A `Table` represents an actual database table.
You define it using:

* A **table name**
* The **metadata** object
* One or more **Column** objects

```python
from sqlalchemy import Table, Column, Integer, String

users = Table(
    "users",
    metadata,
    Column("id", Integer, primary_key=True),
    Column("name", String(50)),
    Column("email", String(100))
)
```

This does **not** create the table in the database yet — it just defines its structure in Python.

---

## **3.3 Creating Tables in the Database**

To create the tables physically in your database, you need to bind the metadata to an engine and call `create_all()`.

```python
from sqlalchemy import create_engine

engine = create_engine("sqlite:///example.db")

# Create all tables defined in metadata
metadata.create_all(engine)
```

This generates and executes SQL equivalent to:

```sql
CREATE TABLE users (
    id INTEGER NOT NULL, 
    name VARCHAR(50), 
    email VARCHAR(100), 
    PRIMARY KEY (id)
);
```

---

## **3.4 Data Types in SQLAlchemy**

SQLAlchemy supports most SQL data types. Here are some commonly used ones:

| **Type**         | **Description**             |
| ---------------- | --------------------------- |
| `Integer`        | Whole numbers               |
| `String(length)` | Text of variable length     |
| `Text`           | Large text data             |
| `Date`           | Stores only date            |
| `DateTime`       | Stores both date and time   |
| `Float`          | Floating-point numbers      |
| `Boolean`        | True or False               |
| `LargeBinary`    | Binary data (files, images) |

**Example:**

```python
from sqlalchemy import DateTime, Boolean

logs = Table(
    "logs",
    metadata,
    Column("id", Integer, primary_key=True),
    Column("message", String(200)),
    Column("created_at", DateTime),
    Column("is_error", Boolean)
)
```

---

## **3.5 Inserting Data (INSERT)**

There are two main ways to insert data using Core.

### **Method 1: Using the insert() construct**

```python
from sqlalchemy import insert

stmt = insert(users).values(name="Alice", email="alice@example.com")

with engine.connect() as conn:
    conn.execute(stmt)
    conn.commit()
```

### **Method 2: Inserting multiple rows**

```python
stmt = insert(users)
rows = [
    {"name": "Bob", "email": "bob@example.com"},
    {"name": "Charlie", "email": "charlie@example.com"}
]

with engine.connect() as conn:
    conn.execute(stmt, rows)
    conn.commit()
```

---

## **3.6 Selecting Data (SELECT)**

### **Basic SELECT query**

```python
from sqlalchemy import select

stmt = select(users)
with engine.connect() as conn:
    results = conn.execute(stmt)
    for row in results:
        print(row)
```

### **Selecting specific columns**

```python
stmt = select(users.c.name, users.c.email)
```

### **Filtering (WHERE clause)**

```python
stmt = select(users).where(users.c.name == "Alice")
```

### **Sorting (ORDER BY)**

```python
stmt = select(users).order_by(users.c.name)
```

---

## **3.7 Updating Data (UPDATE)**

You can use the `update()` construct to modify existing rows.

```python
from sqlalchemy import update

stmt = (
    update(users)
    .where(users.c.name == "Alice")
    .values(email="alice@newdomain.com")
)

with engine.connect() as conn:
    conn.execute(stmt)
    conn.commit()
```

This generates SQL like:

```sql
UPDATE users SET email = 'alice@newdomain.com' WHERE name = 'Alice';
```

---

## **3.8 Deleting Data (DELETE)**

Use the `delete()` construct to remove records.

```python
from sqlalchemy import delete

stmt = delete(users).where(users.c.name == "Bob")

with engine.connect() as conn:
    conn.execute(stmt)
    conn.commit()
```

---

## **3.9 Executing Textual SQL (text())**

Sometimes, you may want to execute **raw SQL statements** directly.
You can use the `text()` function for that.

```python
from sqlalchemy import text

with engine.connect() as conn:
    result = conn.execute(text("SELECT * FROM users WHERE name=:name"), {"name": "Alice"})
    for row in result:
        print(row)
```

This allows mixing **SQLAlchemy expressions** with **pure SQL**, giving maximum flexibility.

---

## **3.10 Summary**

| **Concept**                                    | **Description**               |
| ---------------------------------------------- | ----------------------------- |
| `MetaData()`                                   | Manages table definitions     |
| `Table()`                                      | Defines table structure       |
| `Column()`                                     | Defines individual fields     |
| `create_all()`                                 | Creates physical tables in DB |
| `insert()`, `select()`, `update()`, `delete()` | Perform CRUD operations       |
| `text()`                                       | Execute raw SQL strings       |

---

## **3.11 Practice Exercise**

1. Create a database named `school.db`.
2. Define a table `students` with columns:

   * `id` (Integer, primary key)
   * `name` (String)
   * `age` (Integer)
   * `grade` (String)
3. Insert three sample students.
4. Write queries to:

   * Retrieve all students
   * Retrieve students above 15 years old
   * Update a student's grade
   * Delete a student record

---
