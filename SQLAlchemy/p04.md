# **Chapter 4: Declarative Base and ORM Mapping**

In this chapter, we move from SQLAlchemy Core to **Object Relational Mapping (ORM)**.
The ORM layer allows you to represent database tables as **Python classes**, making it easier to work with data using **Python objects** instead of writing SQL manually.

---

## **4.1 What is Declarative Mapping?**

Declarative mapping is a way to define database tables and their relationships by creating **Python classes** that inherit from a **base class**.
Each class corresponds to a table, and each attribute corresponds to a column.

For example:

```python
from sqlalchemy import Column, Integer, String
from sqlalchemy.orm import declarative_base

Base = declarative_base()

class User(Base):
    __tablename__ = "users"  # Table name in the database

    id = Column(Integer, primary_key=True)
    name = Column(String)
    email = Column(String)
```

Here:

* The class **User** maps to a table called `users`.
* The attributes `id`, `name`, and `email` are columns.
* `primary_key=True` makes `id` the unique identifier for each row.

---

## **4.2 Understanding `declarative_base()`**

The `declarative_base()` function creates a base class for all ORM models to inherit from.
It keeps metadata about all the tables you define.

Example:

```python
from sqlalchemy.orm import declarative_base

Base = declarative_base()
print(Base.metadata)
```

* `Base.metadata` stores table definitions and relationships.
* Later, we use it to **create** or **drop** tables in the database.

---

## **4.3 Defining ORM Models**

Each ORM model represents a table.
Here’s a full example:

```python
from sqlalchemy import Column, Integer, String, DateTime
from sqlalchemy.orm import declarative_base
from datetime import datetime

Base = declarative_base()

class Employee(Base):
    __tablename__ = "employees"

    id = Column(Integer, primary_key=True)
    name = Column(String(50), nullable=False)
    department = Column(String(50))
    join_date = Column(DateTime, default=datetime.utcnow)

    def __repr__(self):
        return f"<Employee(name={self.name}, department={self.department})>"
```

**Explanation:**

* `__tablename__`: the table name in the database.
* `nullable=False`: ensures the column cannot be NULL.
* `default=datetime.utcnow`: automatically sets the current time on record creation.
* `__repr__`: defines how the object appears when printed (for debugging).

---

## **4.4 Primary Keys and Unique Constraints**

Every ORM-mapped table must have **at least one primary key column**.

```python
id = Column(Integer, primary_key=True)
```

You can also add **unique constraints** to ensure no duplicate entries.

Example:

```python
from sqlalchemy import UniqueConstraint

class User(Base):
    __tablename__ = "users"

    id = Column(Integer, primary_key=True)
    username = Column(String, unique=True)
    email = Column(String)

    __table_args__ = (
        UniqueConstraint('email', name='uix_1'),
    )
```

Here:

* `unique=True` ensures all usernames are unique.
* `UniqueConstraint('email')` ensures no two users have the same email.

---

## **4.5 Column Attributes and Relationships**

### **4.5.1 Column Attributes**

Columns can have additional parameters:

| Parameter          | Meaning                           |
| ------------------ | --------------------------------- |
| `primary_key=True` | Sets as table’s unique identifier |
| `unique=True`      | Ensures no duplicates             |
| `nullable=False`   | Prevents NULL values              |
| `default=value`    | Sets default value                |
| `index=True`       | Adds index for faster searching   |

Example:

```python
age = Column(Integer, nullable=False, default=18)
```

---

### **4.5.2 Relationships Between Tables**

You can define relationships using **Foreign Keys** and `relationship()`.

Example with `User` and `Address` tables:

```python
from sqlalchemy import ForeignKey
from sqlalchemy.orm import relationship

class User(Base):
    __tablename__ = "users"
    id = Column(Integer, primary_key=True)
    name = Column(String(50))
    addresses = relationship("Address", back_populates="user")

class Address(Base):
    __tablename__ = "addresses"
    id = Column(Integer, primary_key=True)
    email = Column(String(100))
    user_id = Column(Integer, ForeignKey("users.id"))
    user = relationship("User", back_populates="addresses")
```

**Explanation:**

* Each address is linked to one user via `ForeignKey("users.id")`.
* `relationship()` defines the ORM-level connection between models.
* `back_populates` ensures bidirectional access:

  * `user.addresses` → list of addresses for a user
  * `address.user` → user owning this address

---

## **4.6 Creating Tables from ORM Models**

Once models are defined, you can create tables in the database using:

```python
from sqlalchemy import create_engine

engine = create_engine("sqlite:///company.db")
Base.metadata.create_all(engine)
```

* `create_engine()` connects to the database.
* `Base.metadata.create_all(engine)` creates all tables defined in models.

---

### **Example: Full ORM Setup**

```python
from sqlalchemy import create_engine, Column, Integer, String, ForeignKey
from sqlalchemy.orm import declarative_base, relationship

Base = declarative_base()

class Department(Base):
    __tablename__ = "departments"
    id = Column(Integer, primary_key=True)
    name = Column(String, unique=True)

class Employee(Base):
    __tablename__ = "employees"
    id = Column(Integer, primary_key=True)
    name = Column(String)
    dept_id = Column(Integer, ForeignKey("departments.id"))
    department = relationship("Department", back_populates="employees")

Department.employees = relationship("Employee", back_populates="department")

engine = create_engine("sqlite:///company.db")
Base.metadata.create_all(engine)
print("Tables created successfully!")
```

**Result:**
This will create two tables, `departments` and `employees`, and define a relationship between them.

---

## **4.7 Quick Verification**

You can check tables using SQLite command line:

```bash
sqlite3 company.db
.tables
```

Or query them directly:

```python
from sqlalchemy import inspect
inspector = inspect(engine)
print(inspector.get_table_names())
```

---

## **4.8 Summary**

| Concept                      | Description                             |
| ---------------------------- | --------------------------------------- |
| `declarative_base()`         | Creates the base class for ORM models   |
| ORM Model                    | Python class mapped to a database table |
| Primary Key                  | Uniquely identifies each row            |
| `relationship()`             | Links models through foreign keys       |
| `Base.metadata.create_all()` | Creates all tables in the database      |

---

### ✅ **Mini Exercise**

1. Define two ORM classes: `Author` and `Book`, with a one-to-many relationship.

   * Each author can have multiple books.
   * Each book belongs to one author.

2. Create the SQLite database and generate tables using `Base.metadata.create_all()`.

---
