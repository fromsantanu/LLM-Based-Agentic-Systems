# **Chapter 9: Migrations with Alembic**

## **1. Introduction to Alembic**

When you work with SQLAlchemy ORM or Core, your database schema evolves over time ‚Äî new tables, new columns, or modified relationships. Instead of manually editing the database, **Alembic** provides a **migration framework** to manage these schema changes systematically.

Alembic is developed by the same author as SQLAlchemy and integrates seamlessly with it.

### **Key Concepts**

* **Migration:** A controlled change to the database schema.
* **Revision:** A specific migration step, stored as a Python script.
* **Upgrade:** Applying changes to move the database to a newer version.
* **Downgrade:** Reversing changes to roll back to a previous version.

### **Why Use Alembic**

‚úÖ Keeps database schema in sync with your SQLAlchemy models.
‚úÖ Allows easy rollback in case of errors.
‚úÖ Works with multiple environments and developers.
‚úÖ Provides version control for database schema.

---

## **2. Installing and Setting Up Alembic**

Before using Alembic, install it using pip:

```bash
pip install alembic
```

Then, initialize Alembic in your project directory:

```bash
alembic init alembic
```

This creates a structure like:

```
project/
‚îÇ
‚îú‚îÄ‚îÄ alembic/
‚îÇ   ‚îú‚îÄ‚îÄ env.py
‚îÇ   ‚îú‚îÄ‚îÄ script.py.mako
‚îÇ   ‚îî‚îÄ‚îÄ versions/
‚îÇ
‚îî‚îÄ‚îÄ alembic.ini
```

### **Configuration Files**

* **`alembic.ini`** ‚Üí main configuration file (database URL, logging, etc.)
* **`env.py`** ‚Üí connects Alembic to your SQLAlchemy models.
* **`versions/`** ‚Üí stores migration scripts.

---

## **3. Connecting Alembic to Your SQLAlchemy Models**

In `alembic/env.py`, locate the line where `target_metadata` is defined.
Replace it with your project‚Äôs Base metadata reference.

For example, if your models are defined in `models.py`:

```python
from models import Base  # Import your Base class
target_metadata = Base.metadata
```

Also, update your database connection string in `alembic.ini`:

```ini
sqlalchemy.url = sqlite:///example.db
```

> üí° For production, you might load the URL dynamically from environment variables or a settings file.

---

## **4. Creating Revision Scripts**

A **revision** is a versioned migration script representing one step in schema change.

### **Manual Revision**

To create an empty migration script:

```bash
alembic revision -m "create users table"
```

This creates a new Python file in `alembic/versions/`, for example:

```
alembic/versions/1234_create_users_table.py
```

Inside, you‚Äôll find:

```python
"""create users table"""
from alembic import op
import sqlalchemy as sa

# Revision identifiers
revision = '1234'
down_revision = None  # Previous revision ID
branch_labels = None
depends_on = None

def upgrade():
    pass

def downgrade():
    pass
```

You can now define your schema change manually.

Example:

```python
def upgrade():
    op.create_table(
        'users',
        sa.Column('id', sa.Integer, primary_key=True),
        sa.Column('name', sa.String(50)),
        sa.Column('email', sa.String(100), unique=True)
    )

def downgrade():
    op.drop_table('users')
```

---

## **5. Auto-Generating Migrations**

Instead of writing migrations manually, Alembic can **auto-detect** changes in your SQLAlchemy models and generate the script for you.

```bash
alembic revision --autogenerate -m "add email to users"
```

Alembic will:

* Compare `Base.metadata` with the current database schema.
* Generate an appropriate migration script.

### **Example Output**

```python
def upgrade():
    op.add_column('users', sa.Column('email', sa.String(length=100), nullable=True))

def downgrade():
    op.drop_column('users', 'email')
```

> ‚ö†Ô∏è Always review the generated script before applying it ‚Äî Alembic might miss some complex relationship or constraint differences.

---

## **6. Applying Upgrades and Downgrades**

Once your migration script is ready, apply it using:

### **Upgrade (Apply New Changes)**

```bash
alembic upgrade head
```

or to upgrade step-by-step:

```bash
alembic upgrade +1
```

### **Downgrade (Revert Changes)**

```bash
alembic downgrade -1
```

To revert to a specific revision:

```bash
alembic downgrade <revision_id>
```

---

## **7. Viewing Migration History**

List all applied and pending migrations:

```bash
alembic history
```

Show the current database version:

```bash
alembic current
```

---

## **8. Best Practices for Using Alembic**

‚úÖ **Always commit model changes before generating a migration.**
‚úÖ **Use meaningful messages** in `-m "..."` for easy history tracking.
‚úÖ **Test migrations locally** before running in production.
‚úÖ **Keep migration files version-controlled (Git).**
‚úÖ **Avoid editing old migrations** once applied ‚Äî instead, create new ones.

---

## **9. Example Workflow Summary**

1. Update or create SQLAlchemy models.
2. Generate migration:

   ```bash
   alembic revision --autogenerate -m "Added new column"
   ```
3. Review migration script under `versions/`.
4. Apply migration:

   ```bash
   alembic upgrade head
   ```
5. Roll back if needed:

   ```bash
   alembic downgrade -1
   ```

---

## **10. Quick Reference Table**

| Command                                    | Description                    |
| ------------------------------------------ | ------------------------------ |
| `alembic init alembic`                     | Initialize Alembic setup       |
| `alembic revision -m "msg"`                | Create empty migration script  |
| `alembic revision --autogenerate -m "msg"` | Auto-generate migration script |
| `alembic upgrade head`                     | Apply all pending migrations   |
| `alembic downgrade -1`                     | Revert one migration           |
| `alembic history`                          | View migration history         |
| `alembic current`                          | Show current schema version    |

---

## **11. Summary**

Alembic helps developers manage database schema evolution in a safe, version-controlled manner.
By integrating it with your SQLAlchemy models, you can ensure:

* Controlled upgrades and downgrades
* Consistent schema across environments
* Easy rollback in case of deployment issues

It‚Äôs an indispensable tool for any production-grade SQLAlchemy project.

---
