# **Chapter 2: Setting Up SQLAlchemy**

In this chapter, you’ll learn how to install SQLAlchemy, connect it to different databases, and execute your first SQL statements using the **Core** (low-level) part of SQLAlchemy.

---

## **2.1 Installing SQLAlchemy and Database Drivers**

### **Step 1: Install SQLAlchemy**

SQLAlchemy is available on PyPI and can be installed using `pip`:

```bash
pip install sqlalchemy
```

> ✅ **Tip:** If you plan to use SQLAlchemy with an ORM (Object Relational Mapper), this installation is enough — ORM is part of SQLAlchemy itself.

---

### **Step 2: Install Database Drivers**

SQLAlchemy doesn’t connect to databases directly.
It uses **database drivers (DBAPI modules)** to communicate with your chosen database.

Below are some common drivers:

| Database             | Recommended Driver          | Install Command         |
| -------------------- | --------------------------- | ----------------------- |
| SQLite (default)     | Built-in (no extra install) | -                       |
| MySQL                | `pymysql` or `mysqlclient`  | `pip install pymysql`   |
| PostgreSQL           | `psycopg2` or `asyncpg`     | `pip install psycopg2`  |
| Oracle               | `cx_Oracle`                 | `pip install cx_Oracle` |
| Microsoft SQL Server | `pyodbc`                    | `pip install pyodbc`    |

---

### **Step 3: Verify Installation**

You can verify installation by running:

```python
import sqlalchemy
print(sqlalchemy.__version__)
```

---

## **2.2 Creating a Database Engine (`create_engine()`)**

The **Engine** is the core interface to the database — it manages connections and executes SQL commands.

### **Example: Creating an Engine**

```python
from sqlalchemy import create_engine

# Create an engine connected to a local SQLite database file
engine = create_engine("sqlite:///students.db")

# Or, for in-memory (temporary) SQLite database
engine_memory = create_engine("sqlite:///:memory:")

print(engine)
```

---

### **Engine Parameters**

`create_engine()` accepts several optional parameters:

```python
engine = create_engine(
    "sqlite:///mydb.db",
    echo=True,       # Logs all SQL commands to the console
    pool_size=5,     # Number of connections to keep open
    connect_args={'timeout': 15}  # Database-specific parameters
)
```

> ⚙️ **echo=True** is useful for debugging. It prints SQL statements executed under the hood.

---

## **2.3 Understanding Database URLs**

SQLAlchemy uses a **Database URL** to identify and connect to a specific database.
The general format is:

```
dialect+driver://username:password@host:port/database
```

Let’s look at examples for popular databases:

| Database   | Example Connection URL                                       |
| ---------- | ------------------------------------------------------------ |
| SQLite     | `sqlite:///example.db`                                       |
| MySQL      | `mysql+pymysql://root:password@localhost:3306/testdb`        |
| PostgreSQL | `postgresql+psycopg2://user:secret@localhost/mydb`           |
| Oracle     | `oracle+cx_oracle://username:password@localhost:1521/dbname` |
| SQL Server | `mssql+pyodbc://username:password@dsnname`                   |

> 💡 **Note:** The part before `://` defines the database dialect and driver.

For example:

* `mysql+pymysql` → MySQL database using the PyMySQL driver
* `sqlite:///students.db` → SQLite database stored in a local file named `students.db`

---

## **2.4 Basic Connection and Executing Raw SQL**

You can connect to your database and run SQL commands directly using the Engine.

### **Example: Using `connect()`**

```python
from sqlalchemy import create_engine, text

# Create engine
engine = create_engine("sqlite:///students.db")

# Create connection
with engine.connect() as connection:
    result = connection.execute(text("SELECT sqlite_version();"))
    version = result.scalar()
    print("SQLite version:", version)
```

### **Explanation:**

* `text()` safely wraps raw SQL statements.
* `connection.execute()` runs the SQL query.
* `result.scalar()` retrieves a single value from the result.

---

### **Example: Creating a Table and Inserting Data**

```python
from sqlalchemy import create_engine, text

engine = create_engine("sqlite:///students.db")

with engine.connect() as conn:
    conn.execute(text("CREATE TABLE IF NOT EXISTS students (id INTEGER PRIMARY KEY, name TEXT, age INTEGER)"))
    conn.execute(text("INSERT INTO students (name, age) VALUES ('Alice', 21), ('Bob', 22)"))
    conn.commit()

    result = conn.execute(text("SELECT * FROM students"))
    for row in result:
        print(row)
```

**Output:**

```
(1, 'Alice', 21)
(2, 'Bob', 22)
```

---

### **Example: Using `commit()` and Transactions**

```python
from sqlalchemy import create_engine, text

engine = create_engine("sqlite:///students.db")

with engine.begin() as conn:  # begin() automatically handles transactions
    conn.execute(text("INSERT INTO students (name, age) VALUES ('Charlie', 23)"))
```

> ✅ Using `engine.begin()` is safer — it automatically commits changes or rolls back if any error occurs.

---

## **2.5 Summary**

| Concept          | Description                                             |
| ---------------- | ------------------------------------------------------- |
| **Engine**       | Central object that manages database connections        |
| **Database URL** | String defining how to connect to a specific DB         |
| **Drivers**      | Python modules that enable communication with databases |
| **connect()**    | Opens a connection to execute raw SQL                   |
| **text()**       | Safely represents SQL statements in SQLAlchemy          |

---

### **Exercise**

1. Install SQLAlchemy and `pymysql`.
2. Create a database engine connected to `mysql+pymysql://root:password@localhost/testdb`.
3. Create a table called `books` with columns `(id, title, author)`.
4. Insert two records using raw SQL.
5. Retrieve all rows and print them.

---

