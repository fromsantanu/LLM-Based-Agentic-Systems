# **Chapter 5: CRUD Operations with ORM**

In this chapter, we will learn how to perform **Create, Read, Update, and Delete (CRUD)** operations using SQLAlchemy’s **Object Relational Mapper (ORM)** interface.

The ORM layer allows you to interact with your database tables using Python objects rather than writing raw SQL queries.

---

## **5.1 Creating a Session**

A **session** in SQLAlchemy acts as the interface between your ORM-mapped objects and the database. It manages transactions, executes queries, and keeps track of object states.

### **Using sessionmaker()**

To create a session, we use the `sessionmaker()` factory.

```python
from sqlalchemy import create_engine
from sqlalchemy.orm import sessionmaker
from models import Base, User

# Create engine
engine = create_engine("sqlite:///example.db", echo=True)

# Create all tables
Base.metadata.create_all(engine)

# Create a configured "Session" class
Session = sessionmaker(bind=engine)

# Create a session instance
session = Session()
```

✅ **Explanation:**

* `sessionmaker()` returns a new session factory bound to our engine.
* Each session instance (`Session()`) represents an ongoing conversation with the database.
* It maintains changes and transactions until explicitly committed.

---

## **5.2 Inserting Records (Create)**

You can insert records using `session.add()` or `session.add_all()` followed by `session.commit()`.

### **Example 1: Using add()**

```python
new_user = User(name="John Doe", email="john@example.com")
session.add(new_user)
session.commit()
```

### **Example 2: Using add_all()**

```python
users = [
    User(name="Alice", email="alice@example.com"),
    User(name="Bob", email="bob@example.com")
]
session.add_all(users)
session.commit()
```

### **Example 3: Rollback Example**

If an error occurs, you can rollback to maintain database integrity.

```python
try:
    user = User(name="Eve", email="eve@example.com")
    session.add(user)
    session.commit()
except:
    session.rollback()
```

✅ **Key Points**

* Changes are temporary until `commit()` is called.
* Always handle exceptions using `try/except` and rollback when necessary.

---

## **5.3 Querying Records (Read)**

SQLAlchemy provides a powerful query interface through `session.query()`.

### **Example 1: Retrieve All Records**

```python
users = session.query(User).all()
for user in users:
    print(user.id, user.name, user.email)
```

### **Example 2: Filter Records**

```python
john = session.query(User).filter_by(name="John Doe").first()
print(john.id, john.email)
```

### **Example 3: Using filter() with Conditions**

```python
users = session.query(User).filter(User.id > 1).all()
for u in users:
    print(u.name)
```

### **Example 4: Combining Filters**

```python
users = session.query(User).filter(User.name.like("%o%"), User.id < 5).all()
```

✅ **filter_by() vs filter()**

* `filter_by()` → keyword-style filtering (`filter_by(name='Alice')`)
* `filter()` → allows complex conditions using SQL expressions (`filter(User.id > 5)`)

---

## **5.4 Updating Records**

To update a record:

1. Retrieve it using a query.
2. Modify the attributes.
3. Commit the changes.

### **Example: Update User’s Email**

```python
user = session.query(User).filter_by(name="Alice").first()
user.email = "alice_new@example.com"
session.commit()
```

You can also use the **bulk update** method:

```python
session.query(User).filter_by(name="Bob").update({"email": "bob_new@example.com"})
session.commit()
```

✅ **Note:**
Bulk updates do not trigger ORM events and skip object-level tracking. Use carefully.

---

## **5.5 Deleting Records**

To delete a record:

1. Query it.
2. Call `session.delete()`.
3. Commit the transaction.

### **Example 1: Delete a Single Record**

```python
user = session.query(User).filter_by(name="Eve").first()
session.delete(user)
session.commit()
```

### **Example 2: Bulk Delete**

```python
session.query(User).filter(User.id > 3).delete()
session.commit()
```

✅ **Note:**
Bulk deletes bypass object loading and can be faster, but they skip ORM-level cascade rules and event triggers.

---

## **5.6 Session Lifecycle**

Always close the session after completing operations:

```python
session.close()
```

This releases database connections back to the pool.

---

## **5.7 Summary**

| Operation  | Method                               | Example                     |
| ---------- | ------------------------------------ | --------------------------- |
| **Create** | `add()`, `add_all()`                 | `session.add(User(...))`    |
| **Read**   | `query()`, `filter()`, `filter_by()` | `session.query(User).all()` |
| **Update** | Change attributes + `commit()`       | `user.email = ...`          |
| **Delete** | `delete()` + `commit()`              | `session.delete(user)`      |

---

## **Mini Exercise**

1. Create a table named `Book` with columns: `id`, `title`, `author`, and `price`.
2. Insert at least 3 books.
3. Retrieve all books priced above 300.
4. Update the price of one book.
5. Delete any one record.
6. Verify results by printing all books after each operation.

---
