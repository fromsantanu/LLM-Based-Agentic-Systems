# Chapter 14 — Multipage Apps

**Goal:** Build a clean, MVC-ish multipage Streamlit app that shares controllers/views across pages, keeps state in sync, and uses query parameters for deep-links.

---

## 14.1 What you’ll learn

* **`pages/` folder**: how Streamlit discovers pages and how filenames control menu order & titles.
* **Cross-page state**: initializing and sharing `st.session_state` safely.
* **Query params**: creating deep links (`?patient_id=123`) and reading them on another page.

---

## 14.2 Why multipage?

Single files are great to start, but as soon as you have **dashboards + entities + admin tools**, it’s time to split concerns:

* **Root page (`app.py`)** → app-wide layout, global filters.
* **Feature pages (`pages/*.py`)** → cohesive screens that reuse **controllers** and **views**.
* **Shared layers** → `controllers/`, `services/`, `views/`, `models/` keep logic testable and UI lean.

---

## 14.3 Streamlit multipage basics

### 14.3.1 Pages folder & naming

* Create a folder named **`pages/`** beside `app.py`.
* Streamlit auto-discovers files in `pages/`.
* **Menu order** follows filename prefixes:

  * `1_Dashboard.py` → menu #1, title **Dashboard**
  * `2_Patients.py` → menu #2, title **Patients**
* The title shown in the sidebar equals the part **after** the underscore.

### 14.3.2 Cross-page state

Use `st.session_state` as your single source of truth for UI selections and loaded data.

**Rules of thumb:**

* Centralize defaults in one bootstrap function (easier to maintain).
* Never assume a key exists—**ensure** it.
* Write controllers that **accept/return plain data** and **only** mutate `session_state` in one place when needed.

### 14.3.3 Query parameters (deep-links)

You can pass context across pages using the URL:

* Set: `st.query_params["patient_id"] = "P001"`
* Read: `pid = st.query_params.get("patient_id", None)`

This enables copying/sharing a link that opens the Patients page already focused on a given record.

> Note: If your Streamlit version is older, replace with the legacy `st.experimental_{get,set}_query_params`. The patterns below use the modern `st.query_params`.

---

## 14.4 Project structure (chapter lab)

We’ll build two pages—**Dashboard** and **Patients**—that share controllers and views:

```
streamlit_mvc/
├─ app.py
├─ pages/
│  ├─ 1_Dashboard.py
│  └─ 2_Patients.py
├─ controllers/
│  ├─ state.py
│  └─ actions.py
├─ services/
│  └─ api.py
├─ views/
│  ├─ layout.py
│  └─ sections.py
├─ models/
│  └─ dto.py
└─ requirements.txt
```

---

## 14.5 Shared layers

### 14.5.1 `models/dto.py`

Simple data shapes to keep controllers/views tidy.

```python
# models/dto.py
from pydantic import BaseModel, Field
from typing import Optional

class Patient(BaseModel):
    id: str = Field(..., examples=["P001"])
    name: str
    age: int
    condition: str
    risk: str

class DashboardSummary(BaseModel):
    total_patients: int
    high_risk: int
    avg_age: float
```

### 14.5.2 `services/api.py`

Pretend this is a DB/API. Later you can wire your real repo.

```python
# services/api.py
from typing import List, Optional
from statistics import mean
from models.dto import Patient, DashboardSummary

_FAKE = [
    Patient(id="P001", name="Anita Sen", age=34, condition="Hypertension", risk="Medium"),
    Patient(id="P002", name="Ravi Das", age=61, condition="T2DM",        risk="High"),
    Patient(id="P003", name="Meera Pal", age=48, condition="Asthma",      risk="Low"),
    Patient(id="P004", name="K R Shah", age=72, condition="CAD",          risk="High"),
]

def list_patients(risk: Optional[str] = None) -> List[Patient]:
    if risk and risk != "All":
        return [p for p in _FAKE if p.risk == risk]
    return _FAKE

def get_patient(pid: str) -> Optional[Patient]:
    return next((p for p in _FAKE if p.id == pid), None)

def get_dashboard_summary() -> DashboardSummary:
    pts = _FAKE
    return DashboardSummary(
        total_patients=len(pts),
        high_risk=sum(1 for p in pts if p.risk == "High"),
        avg_age=round(mean(p.age for p in pts), 1),
    )
```

### 14.5.3 `controllers/state.py`

Central place to **init** and **guard** `session_state`.

```python
# controllers/state.py
import streamlit as st

DEFAULTS = {
    "filters": {
        "risk": "All",   # All | High | Medium | Low
    },
    "data": {
        "patients": None,        # cached list after filter
        "summary": None,         # dashboard summary
        "selected_patient_id": None,
    },
}

def ensure_state():
    if "filters" not in st.session_state:
        st.session_state["filters"] = DEFAULTS["filters"].copy()
    if "data" not in st.session_state:
        st.session_state["data"] = DEFAULTS["data"].copy()

def set_filter(key: str, value):
    ensure_state()
    st.session_state["filters"][key] = value

def get_filter(key: str, default=None):
    ensure_state()
    return st.session_state["filters"].get(key, default)

def set_data(key: str, value):
    ensure_state()
    st.session_state["data"][key] = value

def get_data(key: str, default=None):
    ensure_state()
    return st.session_state["data"].get(key, default)
```

### 14.5.4 `controllers/actions.py`

User-intent → service calls → state updates.

```python
# controllers/actions.py
from typing import Optional
from services.api import list_patients, get_dashboard_summary, get_patient
from controllers.state import set_data, get_filter, ensure_state

def load_dashboard():
    ensure_state()
    summary = get_dashboard_summary()
    set_data("summary", summary)

def apply_patient_filter_and_load():
    ensure_state()
    risk = get_filter("risk", "All")
    pts = list_patients(risk=risk)
    set_data("patients", pts)

def select_patient(pid: Optional[str]):
    ensure_state()
    set_data("selected_patient_id", pid)
    # Optionally prefetch the patient object for detail view
    if pid:
        set_data("selected_patient", get_patient(pid))
    else:
        set_data("selected_patient", None)
```

### 14.5.5 `views/layout.py`

Top-level chrome you can reuse on every page.

```python
# views/layout.py
import streamlit as st

def app_header(title: str, subtitle: str = ""):
    st.title(title)
    if subtitle:
        st.caption(subtitle)
    st.divider()
```

### 14.5.6 `views/sections.py`

Reusable pieces: filters, tables, cards.

```python
# views/sections.py
import streamlit as st
import pandas as pd
from typing import List
from models.dto import Patient, DashboardSummary

def render_risk_filter(current: str, on_change):
    risks = ["All", "High", "Medium", "Low"]
    st.selectbox(
        "Risk level",
        risks,
        index=risks.index(current) if current in risks else 0,
        key="ui_risk_select",
        on_change=lambda: on_change(st.session_state["ui_risk_select"])
    )

def render_summary_cards(summary: DashboardSummary):
    c1, c2, c3 = st.columns(3)
    c1.metric("Total Patients", summary.total_patients)
    c2.metric("High Risk", summary.high_risk)
    c3.metric("Avg Age", summary.avg_age)

def render_patient_table(patients: List[Patient]):
    if not patients:
        st.info("No patients match the current filter.")
        return
    df = pd.DataFrame([p.model_dump() for p in patients])
    st.dataframe(df, use_container_width=True)

def render_patient_profile(patient: Patient):
    st.subheader(f"{patient.name}  ·  {patient.id}")
    st.write(
        f"- **Age:** {patient.age}\n"
        f"- **Condition:** {patient.condition}\n"
        f"- **Risk:** {patient.risk}"
    )
```

---

## 14.6 Root file

### `app.py` — a simple landing page

```python
# app.py
import streamlit as st
from controllers.state import ensure_state
from views.layout import app_header

st.set_page_config(page_title="Clinic App", page_icon="🩺", layout="wide")

ensure_state()
app_header("Clinic App", "Welcome. Use the left menu to navigate.")
st.write(
    "This is the home page. Try **Dashboard** for KPIs or **Patients** to browse the registry."
)
```

---

## 14.7 Pages

### `pages/1_Dashboard.py`

* Loads summary KPIs.
* Shows a filter + table preview.
* **Deep-link** to Patients page using **query params** and also supports programmatic navigation.

```python
# pages/1_Dashboard.py
import streamlit as st
from controllers.state import ensure_state, get_filter, set_filter, get_data
from controllers.actions import load_dashboard, apply_patient_filter_and_load, select_patient
from views.layout import app_header
from views.sections import render_risk_filter, render_summary_cards, render_patient_table

st.set_page_config(page_title="Dashboard", page_icon="📊", layout="wide")
ensure_state()

# Load summary + filtered list
load_dashboard()
apply_patient_filter_and_load()

summary = get_data("summary")
patients = get_data("patients")

app_header("Dashboard", "KPIs and quick list")

# Cards
render_summary_cards(summary)

st.subheader("Quick Patient List")
def on_risk_change(new_value):
    set_filter("risk", new_value)
    apply_patient_filter_and_load()

render_risk_filter(get_filter("risk", "All"), on_change=on_risk_change)
render_patient_table(patients)

st.write("---")
st.caption("Open a focused patient view:")

# Choose a patient to view on the Patients page
ids = [p.id for p in patients] if patients else []
pid = st.selectbox("Select a patient", ids) if ids else None

col1, col2 = st.columns(2)

with col1:
    # 1) Deep-link via query params (shareable URL)
    if st.button("Open in Patients (deep-link)"):
        if pid:
            st.query_params["patient_id"] = pid
            st.switch_page("pages/2_Patients.py")
        else:
            st.warning("Pick a patient first.")

with col2:
    # 2) Navigate via session_state only (not shareable)
    if st.button("Open in Patients (session state)"):
        if pid:
            select_patient(pid)
            # Clear query param if present
            st.query_params.pop("patient_id", None)
            st.switch_page("pages/2_Patients.py")
        else:
            st.warning("Pick a patient first.")
```

### `pages/2_Patients.py`

* Reads **`patient_id`** from either **`st.query_params`** or **`session_state`**.
* Renders patient profile, with a small navigator.

```python
# pages/2_Patients.py
import streamlit as st
from controllers.state import ensure_state, get_data, set_data
from controllers.actions import apply_patient_filter_and_load, select_patient
from views.layout import app_header
from views.sections import render_patient_profile

st.set_page_config(page_title="Patients", page_icon="🧑‍⚕️", layout="wide")
ensure_state()

# Try to get patient_id from query params first (deep-link),
# otherwise fall back to session_state.
pid = st.query_params.get("patient_id", None) or get_data("selected_patient_id")

# If still nothing, offer a selector from the filtered list:
apply_patient_filter_and_load()
patients = get_data("patients") or []
ids = [p.id for p in patients]

app_header("Patients", "Browse & inspect patient records")

if not pid and ids:
    pid = st.selectbox("Pick a patient", ids, key="picker_pid")
    if pid:
        # Keep both sources in sync for future navigations & shareable links
        st.query_params["patient_id"] = pid
        select_patient(pid)

if not pid:
    st.info("No patient selected. Pick one from the list (or open via Dashboard).")
    st.stop()

# Ensure our controller caches the selected patient
select_patient(pid)
patient = get_data("selected_patient")

if not patient:
    st.error("Patient not found.")
    st.stop()

render_patient_profile(patient)

st.write("---")
c1, c2, c3 = st.columns(3)
with c1:
    if st.button("← Back to Dashboard"):
        st.switch_page("pages/1_Dashboard.py")
with c2:
    # Demonstrate clearing link context
    if st.button("Clear deep-link (keep selection)"):
        st.query_params.pop("patient_id", None)
with c3:
    # Demonstrate clearing both
    if st.button("Reset selection"):
        st.query_params.pop("patient_id", None)
        set_data("selected_patient_id", None)
        set_data("selected_patient", None)
        st.rerun()
```

---

## 14.8 How it works (flow)

1. **Dashboard loads**

   * `load_dashboard()` populates KPI summary.
   * `apply_patient_filter_and_load()` fetches the filtered list.
2. **User picks a patient**

   * **Deep-link path:** set `st.query_params["patient_id"]=...` → `st.switch_page(...)`.
   * **State path:** store in `session_state` → `st.switch_page(...)`.
3. **Patients page opens**

   * Reads `patient_id` from **query params** first (shareable URL priority), else **session_state**.
   * Calls `select_patient(pid)` to cache the object.
   * Renders the profile.

---

## 14.9 Patterns & tips

* **Prefer query params** for anything you might want to **bookmark/share**.
* **Mirror important context** to `session_state` so internal navigations remain fast and resilient.
* **Always guard state** with `ensure_state()` before reading/writing keys.
* **Keep controllers pure** (aside from coordinated state updates). Heavy I/O stays in **services**.
* **Avoid circular imports** by keeping layers clean: views never import services directly; go via controllers.

---

## 14.10 Lab

**Task A — Build the Dashboard page**

1. Create `pages/1_Dashboard.py` using the code above.
2. Verify card metrics render and the table responds to the risk filter.
3. Use **both** navigation buttons and observe URL differences.

**Task B — Build the Patients page**

1. Create `pages/2_Patients.py`.
2. Open directly with a URL like:
   `http://localhost:8501/Patients?patient_id=P002`
   (Your base URL may differ; the key is `?patient_id=...`.)
3. Try the **Reset selection** button to see how state & params clear.

**Stretch goals**

* Add **pagination** to the patient list (store the page index in query params).
* Add **search** (e.g., `?q=anita`).
* Add an **Edit** drawer (pure UI for now) and store unsaved changes in `session_state["drafts"]`.

---

## 14.11 Requirements

```
# requirements.txt
streamlit>=1.29.0
pydantic>=2.6
pandas>=2.1
```

> If you’re on an older Streamlit, replace `st.query_params` with `st.experimental_{get,set}_query_params` and remove `st.page_link` usages if you add them later.

---

## 14.12 Review checklist

* [ ] `pages/` exists, filenames have numeric prefixes for order.
* [ ] State keys always created via `ensure_state()`.
* [ ] Dashboard → Patients works with **query params** and **session_state**.
* [ ] Patients page prioritizes **query params** for deep-links.
* [ ] Controllers/services contain the data/logic; pages are thin.

---

## 14.13 Mini-exercises

1. **Add a “risk” pill in Patients header** that, when clicked, opens Dashboard with that risk pre-selected via `?risk=High`.
2. **Copy-link button**: Add a button that writes the current page’s deep-link to the clipboard (`st.code(st.experimental_get_query_params())` for legacy or display the URL to copy).
3. **Remember tab state**: If you add tabs on Patients, store the active tab in a query param (`?tab=labs`) and restore it on load.

---

**You now have a tidy multipage skeleton with real, shareable deep-links and predictable cross-page state. In Chapter 15, we’ll add authentication guards and role-scoped menus.**

