# **Chapter 18: Validation & Security**

---

#### 🎯 **Goal:**

Make your app robust and safe by validating all data inputs and enforcing strict limits.

---

## 🧩 **1. Why Validation and Security Matter**

Even small web apps are exposed to risks:

* Malicious inputs (SQL injection, XSS, etc.)
* Unexpected data (e.g., negative quantities)
* Denial-of-service via oversized queries or loops

A secure system **validates early**, **sanitizes inputs**, and **defends services** from misuse.

---

## ⚙️ **2. Defensive Programming in Services**

Think of your **service layer** as a *firewall* for business logic.

Always verify:

* Input ranges (`quantity > 0`)
* Existence checks (`product_id` must exist)
* Size and limit constraints (`limit <= 100`)

Example:

```python
# services/orders.py

from app.models import OrderCreate
from app.repositories import orders_repo
from app.exceptions import ValidationError

def create_order(order: OrderCreate):
    if order.quantity <= 0:
        raise ValidationError("Quantity must be positive.")
    if len(order.notes or "") > 500:
        raise ValidationError("Notes too long.")
    
    return orders_repo.insert(order)
```

✅ **Tip:** Perform these checks *before* calling the repository.

---

## 🧼 **3. Sanitizing Inputs**

Never trust raw user data.

**Example:**

```python
import html

def sanitize_text(text: str) -> str:
    return html.escape(text.strip())
```

Usage:

```python
clean_comment = sanitize_text(user_input.comment)
```

This prevents:

* HTML injection (`<script>`)
* Unwanted whitespace or hidden characters

---

## 🔢 **4. Limiting Query Sizes**

When users request data (e.g., list of customers or orders), always cap the number of records returned.

```python
def get_orders(limit: int = 50, offset: int = 0):
    # Clamp limit to a safe range
    limit = max(1, min(limit, 100))
    offset = max(0, offset)

    return orders_repo.list(limit=limit, offset=offset)
```

🔒 Prevents:

* Memory overloads
* Long query times
* API abuse

---

## 🧰 **5. Pydantic Validators**

Use **Pydantic** to enforce data rules automatically.

```python
from pydantic import BaseModel, Field, validator

class OrderCreate(BaseModel):
    product_id: int
    quantity: int = Field(gt=0)
    customer_id: int
    notes: str | None = None

    @validator("notes")
    def limit_notes_length(cls, v):
        if v and len(v) > 500:
            raise ValueError("Notes too long")
        return v.strip() if v else v
```

💡 This ensures that invalid data never even reaches your service functions.

---

## 🧱 **6. Handling Security Errors**

Define a consistent error response:

```python
# exceptions.py
class ValidationError(Exception):
    def __init__(self, message):
        self.message = message
```

In controller:

```python
# controllers/orders.py
import streamlit as st
from app.services import orders

try:
    orders.create_order(order)
    st.success("Order created successfully!")
except ValidationError as e:
    st.error(f"Invalid data: {e.message}")
```

---

## 🧪 **Lab: Reject Invalid Orders & Clamp Pagination**

**Goal:**
Add validations for safe input and query size.

---

### 🧠 Step 1: Update DTO

```python
# models/order_dto.py
from pydantic import BaseModel, Field

class OrderCreate(BaseModel):
    product_id: int
    quantity: int = Field(gt=0, description="Must be positive")
```

---

### ⚙️ Step 2: Service Validation

```python
# services/orders_service.py
def create_order(order: OrderCreate):
    if order.quantity <= 0:
        raise ValueError("Quantity must be positive")
    return repo.insert(order)
```

---

### 💬 Step 3: Controller Check

```python
# controllers/orders_controller.py
import streamlit as st
from app.services import orders_service

quantity = st.number_input("Quantity", min_value=0)
if st.button("Place Order"):
    try:
        orders_service.create_order(OrderCreate(product_id=1, quantity=quantity))
        st.success("Order placed successfully!")
    except ValueError as e:
        st.error(str(e))
```

---

### 🔍 Step 4: Pagination Limit

```python
# services/orders_service.py
def list_orders(limit: int = 100):
    limit = max(1, min(limit, 100))
    return repo.list(limit)
```

---

✅ **Expected Behavior**

* Rejects negative quantities.
* Prevents excessive query size.
* Sanitizes user text.
* Returns meaningful validation errors.

---

### 🧭 **Summary**

| Area           | Purpose                | Example           |
| -------------- | ---------------------- | ----------------- |
| Validation     | Prevent bad data       | `Field(gt=0)`     |
| Sanitization   | Remove unsafe text     | `html.escape()`   |
| Query Limits   | Prevent overload       | `min(limit, 100)` |
| Error Handling | User-friendly messages | `st.error()`      |

---

