# Chapter 8 — View Layer in Dash

**Goal:** Compose clean, reusable UI from `dash.html`, `dash.dcc`, and a few tiny helpers so every page stays simple to read and easy to extend.

---

## 8.1 What the View Layer Does (and doesn’t)

* **Does:** Layout + present data, capture user intent through inputs (no business logic).
* **Doesn’t:** Query databases, orchestrate workflows, or validate domain rules—push that to **controllers/services**.

> Rule of thumb: if it’s not a component or layout function returning Dash elements, it probably doesn’t belong in `views/`.

---

## 8.2 Dash Building Blocks at a Glance

* `dash.html` → semantic HTML components: `Div`, `H1`, `Section`, `Table`, …
* `dash.dcc` → interactive widgets: `Dropdown`, `Graph`, `DatePickerRange`, `Store`, …
* `dash_table.DataTable` → rich tables with sort/filter/page/export (optional import).

```python
from dash import html, dcc
from dash.dash_table import DataTable  # or: from dash import dash_table as dt
```

---

## 8.3 A Minimal View API

Keep **views** as a tiny “design system” you own:

* **atoms**: headers, text, badge, spacer
* **molecules**: card, metric tile, toolbar
* **layouts**: grid, section, two-column
* **builders**: table_builder(data, columns), card_grid(cards)

This pays off when you add new pages—most pieces are already there.

### Suggested folder

```
app/
  views/
    __init__.py
    primitives.py        # atoms (text, header, spacer)
    components.py        # card, metric, toolbar
    layouts.py           # grids, sections, page frame
    table_builder.py     # DataTable wrapper
    dashboard.py         # the page (exports a function/view)
assets/
  styles.css             # (optional) a few CSS helpers
```

> If you prefer fewer files, you can merge these into `views/dashboard.py`. Splitting keeps pieces reusable.

---

## 8.4 Reusable Primitives (`views/primitives.py`)

```python
# app/views/primitives.py
from typing import Any, Iterable
from dash import html

def H1(text: str, className: str = ""):
    return html.H1(text, className=f"v-h1 {className}")

def H2(text: str, className: str = ""):
    return html.H2(text, className=f"v-h2 {className}")

def Text(text: str, className: str = ""):
    return html.P(text, className=f"v-text {className}")

def Spacer(size: str = "md"):
    sizes = {"xs": "0.25rem", "sm": "0.5rem", "md": "1rem", "lg": "2rem"}
    h = sizes.get(size, "1rem")
    return html.Div(style={"height": h})

def Stack(children: Iterable[Any], gap: str = "1rem", className: str = ""):
    return html.Div(children, className=f"v-stack {className}",
                    style={"display": "flex", "flexDirection": "column", "gap": gap})
```

---

## 8.5 Reusable Components (`views/components.py`)

```python
# app/views/components.py
from typing import Any, Iterable, Optional
from dash import html

def Card(title: Optional[str] = None, body: Iterable[Any] = (), footer: Optional[Any] = None, className: str = ""):
    return html.Section(
        className=f"v-card {className}",
        children=[
            html.Div(title, className="v-card__header") if title else None,
            html.Div(list(body), className="v-card__body"),
            html.Div(footer, className="v-card__footer") if footer else None,
        ]
    )

def Metric(label: str, value: Any, hint: Optional[str] = None, className: str = ""):
    return html.Div(className=f"v-metric {className}", children=[
        html.Div(label, className="v-metric__label"),
        html.Div(value, className="v-metric__value"),
        html.Div(hint, className="v-metric__hint") if hint else None
    ])

def Toolbar(left: Iterable[Any] = (), right: Iterable[Any] = (), className: str = ""):
    return html.Div(className=f"v-toolbar {className}", children=[
        html.Div(list(left), className="v-toolbar__left"),
        html.Div(list(right), className="v-toolbar__right"),
    ])
```

---

## 8.6 Layout Helpers (`views/layouts.py`)

```python
# app/views/layouts.py
from typing import Iterable, Any
from dash import html

def Page(children: Iterable[Any], className: str = ""):
    return html.Main(children, className=f"v-page {className}")

def Grid(children: Iterable[Any], cols: int = 3, gap: str = "1rem", className: str = ""):
    return html.Div(list(children),
        className=f"v-grid {className}",
        style={
            "display": "grid",
            "gridTemplateColumns": f"repeat({cols}, minmax(0, 1fr))",
            "gap": gap
        })
```

---

## 8.7 A Table Builder (`views/table_builder.py`)

You’ll render tables on many pages—wrap Dash’s DataTable once with sensible defaults.

```python
# app/views/table_builder.py
from typing import List, Dict, Optional
from dash import dash_table

def build_table(
    data: List[Dict],
    columns: Optional[List[Dict]] = None,
    table_id: str = "table",
    page_size: int = 10,
    export: bool = True,
    filterable: bool = True,
    editable: bool = False,
):
    # If columns not passed, infer from keys
    if columns is None and data:
        columns = [{"name": k.replace("_", " ").title(), "id": k} for k in data[0].keys()]
    return dash_table.DataTable(
        id=table_id,
        data=data,
        columns=columns or [],
        page_size=page_size,
        sort_action="native",
        filter_action="native" if filterable else "none",
        editable=editable,
        export_format="csv" if export else None,
        style_table={"overflowX": "auto"},
        style_cell={"padding": "8px", "whiteSpace": "nowrap", "textOverflow": "ellipsis", "maxWidth": 0},
        style_header={"fontWeight": "600"},
        style_data_conditional=[],
    )
```

---

## 8.8 The Dashboard View (`views/dashboard.py`)

> **Input:** Plain data (lists/dicts/DTOs) + precomputed metrics from your **controller**.
> **Output:** A composed Dash layout (no I/O here).

```python
# app/views/dashboard.py
from typing import Dict, List
from dash import html, dcc
from .primitives import H1, Spacer, Stack, Text
from .components import Card, Metric, Toolbar
from .layouts import Page, Grid
from .table_builder import build_table

def render_dashboard(
    metrics: Dict[str, str | int | float],
    recent_orders: List[Dict],
    customers: List[Dict],
):
    """
    Compose the dashboard page from reusable building blocks.
    """
    # Metric tiles
    tiles = [
        Card(body=[Metric("Revenue (MTD)", metrics.get("revenue_mtd", "—"), hint="Month to Date")]),
        Card(body=[Metric("New Customers",  metrics.get("new_customers", "—"))]),
        Card(body=[Metric("Avg. Order Value", metrics.get("aov", "—"))]),
        Card(body=[Metric("Open Tickets", metrics.get("open_tickets", "—"))]),
    ]

    # Tables
    orders_table = Card(
        title="Recent Orders",
        body=[build_table(recent_orders, table_id="recent_orders", page_size=5)]
    )

    customers_table = Card(
        title="Top Customers",
        body=[build_table(customers, table_id="top_customers", page_size=5)]
    )

    # Optional toolbar (filters come from controller as callbacks)
    filters = Toolbar(
        left=[
            Text("Filters:"),
            dcc.Dropdown(
                id="f-time-range",
                options=[
                    {"label": "Last 7 days", "value": "7d"},
                    {"label": "Last 30 days", "value": "30d"},
                    {"label": "Year to date", "value": "ytd"},
                ],
                value="30d",
                clearable=False,
                style={"minWidth": 180}
            ),
        ],
        right=[
            dcc.Input(id="f-customer-search", placeholder="Search customers…"),
        ]
    )

    return Page([
        H1("Executive Dashboard"),
        Spacer("md"),
        filters,
        Spacer("md"),
        Grid(tiles, cols=4, gap="1rem", className="cards"),
        Spacer("lg"),
        Grid([orders_table, customers_table], cols=2, gap="1rem"),
    ])
```

---

## 8.9 Wiring It Up (Controller → View)

Your **controller** prepares data and returns a layout by calling the view function:

```python
# app/controllers/dashboard_controller.py
from dash import html
from ..services.analytics import get_dashboard_metrics, list_recent_orders, list_top_customers
from ..views.dashboard import render_dashboard

def get_dashboard_layout():
    metrics = get_dashboard_metrics()          # pure numbers/text (no html)
    recent_orders = list_recent_orders(limit=25)
    customers = list_top_customers(limit=25)
    return render_dashboard(metrics, recent_orders, customers)
```

And in `main.py` (or wherever you build the app layout):

```python
# app/main.py
from dash import Dash, html, dcc
from app.controllers.dashboard_controller import get_dashboard_layout

app = Dash(__name__, suppress_callback_exceptions=True)
app.layout = get_dashboard_layout()

server = app.server  # for gunicorn

if __name__ == "__main__":
    app.run(debug=True)
```

---

## 8.10 Optional: Lightweight CSS (drop into `assets/styles.css`)

```css
.v-page { padding: 24px; }
.v-h1   { margin: 0; font-size: 1.6rem; font-weight: 700; }
.v-text { margin: 0; color: #333; }

.v-grid.cards .v-card { min-height: 110px; }

.v-card {
  background: #fff; border: 1px solid #e8e8e8; border-radius: 12px;
  box-shadow: 0 1px 3px rgba(0,0,0,0.04); overflow: hidden;
}
.v-card__header { padding: 12px 16px; font-weight: 600; border-bottom: 1px solid #eee; }
.v-card__body   { padding: 16px; }
.v-card__footer { padding: 12px 16px; border-top: 1px solid #eee; }

.v-toolbar { display: flex; align-items: center; justify-content: space-between; gap: 1rem; }
.v-toolbar__left, .v-toolbar__right { display: flex; align-items: center; gap: .5rem; }

.v-metric__label { color: #666; font-size: .85rem; }
.v-metric__value { font-size: 1.4rem; font-weight: 700; }
.v-metric__hint  { color: #999; font-size: .8rem; }
```

---

## 8.11 Callback Stubs (keep them out of the view)

Views shouldn’t contain callbacks. Put them in `controllers/`:

```python
# app/controllers/dashboard_callbacks.py
from dash import Input, Output, State, callback, no_update
from ..views.table_builder import build_table  # not needed if table IDs are static

@callback(
    Output("recent_orders", "data"),
    Input("f-time-range", "value"),
)
def refetch_orders(range_value):
    # call a service to get filtered data
    # return new list-of-dicts (the view will re-render DataTable automatically)
    ...
```

---

## 8.12 Testing the View (smoke test)

```python
# tests/test_views_dashboard.py
from app.views.dashboard import render_dashboard

def test_render_dashboard_smoke():
    layout = render_dashboard(
        metrics={"revenue_mtd": 12345, "new_customers": 12, "aov": 89.5, "open_tickets": 3},
        recent_orders=[{"order_id": 1, "total": 99.0}],
        customers=[{"customer": "Acme", "spend": 1000.0}],
    )
    # Ensure it returns a Dash component with children
    assert hasattr(layout, "children")
```

---

## 8.13 Common Pitfalls

* **Leaking logic into the view:** If you feel the urge to filter/sort/format inside the view, move that to **services** (formatting like “₹1,24,000” can be a tiny utility in services/helpers).
* **Tight coupling with callbacks:** IDs should be stable, but callbacks belong to controllers. Views only declare structure.
* **Inconsistent tables:** Always go through `build_table()` so styling/features are uniform across pages.

---

## 8.14 Lab — Build `views/dashboard.py` with a Card Grid + Table Builder

**Goal:** Implement a clean dashboard page composed from your reusable helpers.

1. **Create files**

   * `app/views/primitives.py`, `app/views/components.py`, `app/views/layouts.py`, `app/views/table_builder.py`, `app/views/dashboard.py` (use snippets above).

2. **Add CSS**

   * Create `assets/styles.css` (copy the CSS block). Run the app—Dash auto-loads from `assets/`.

3. **Mock data (controller)**

   * In `controllers/dashboard_controller.py`, return:

     * `metrics = {"revenue_mtd": 246000, "new_customers": 28, "aov": 4850, "open_tickets": 7}`
     * `recent_orders = [{"order_id": 101, "customer": "Nestor", "total": 12999, "status": "Shipped"}, …]`
     * `customers = [{"customer": "Acme Ltd", "spend": 99600}, …]`

4. **Wire the page**

   * `app.layout = get_dashboard_layout()` in `main.py`.

5. **Stretch tasks**

   * Add a **date range filter** to the toolbar and a controller callback that reloads `recent_orders`.
   * Add **row click** on orders (DataTable `active_cell`) to open a side panel card.
   * Extract a **Section(title, children)** helper for titled blocks.

**Acceptance checks**

* Loads without errors.
* Tiles render with your metrics.
* Orders and customers tables paginate and sort.
* No service/controller imports inside `views/`.

---

## 8.15 Takeaways

* Treat `views/` like a tiny design system: a few atoms + molecules + layouts.
* Keep all layout code **pure** and **declarative**—inputs in, Dash nodes out.
* Centralize table rendering via a builder for consistency.
* The payoff is massive when you add more pages (reports, admin, settings): most UI pieces are already done.

