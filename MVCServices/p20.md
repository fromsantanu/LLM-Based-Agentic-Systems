# **Chapter 20 – CI/CD & Quality Gates**

### 🎯 **Goal**

Ensure code reliability and maintainability with automated testing, linting, and static analysis integrated into continuous integration (CI) pipelines.

---

## **1. Introduction to CI/CD**

**CI/CD** (Continuous Integration / Continuous Deployment) automates code validation and delivery.

* **Continuous Integration (CI):**

  * Every commit is tested automatically.
  * Ensures the main branch is always working.
* **Continuous Deployment (CD):**

  * Automatically deploys changes to staging or production once CI passes.

✅ *Benefit:* No “it works on my machine” issues.

---

## **2. Core Quality Tools**

| Category      | Tool              | Purpose                                     |
| ------------- | ----------------- | ------------------------------------------- |
| Testing       | `pytest`          | Run unit and integration tests              |
| Coverage      | `coverage.py`     | Measure how much code is tested             |
| Linting       | `ruff` / `flake8` | Detect style issues & bad patterns          |
| Type Checking | `mypy`            | Verify type hints at build time             |
| Hooks         | `pre-commit`      | Run checks automatically before each commit |

---

## **3. Setting up Pytest**

### Installation

```bash
pip install pytest
```

### Example test file – `tests/test_services.py`

```python
from app.services import calculate_invoice_totals

def test_calculate_invoice_totals():
    result = calculate_invoice_totals(
        [{"price": 100, "qty": 2}], tax_rate=0.1
    )
    assert result["total"] == 220
```

### Run tests

```bash
pytest -v
```

---

## **4. Measuring Test Coverage**

### Install coverage

```bash
pip install coverage
```

### Run coverage

```bash
coverage run -m pytest
coverage report -m
coverage html   # generates a detailed HTML report
```

**Quality Gate Tip:**
Set minimum coverage percentage in CI:

```bash
coverage run -m pytest && coverage report --fail-under=80
```

---

## **5. Linting with Ruff or Flake8**

### Ruff (fast modern linter)

```bash
pip install ruff
ruff check .
```

### Flake8 (classic)

```bash
pip install flake8
flake8 app/
```

Common issues caught:

* Unused imports
* Indentation/style violations (PEP8)
* Unreachable code

---

## **6. Type Checking with Mypy**

### Install

```bash
pip install mypy
```

### Run

```bash
mypy app/
```

### Example issue

```python
def add(a: int, b: int) -> int:
    return a + b

add("1", 2)
```

👉 Mypy detects: *“Argument 1 to ‘add’ has incompatible type ‘str’; expected ‘int’”*

---

## **7. Pre-Commit Hooks**

**Automate local checks before each git commit.**

### Install

```bash
pip install pre-commit
pre-commit install
```

### `.pre-commit-config.yaml`

```yaml
repos:
  - repo: https://github.com/psf/black
    rev: 23.9.1
    hooks:
      - id: black
  - repo: https://github.com/astral-sh/ruff-pre-commit
    rev: v0.1.3
    hooks:
      - id: ruff
  - repo: https://github.com/pre-commit/mirrors-mypy
    rev: v1.5.1
    hooks:
      - id: mypy
```

Now whenever you commit:

```bash
git commit -m "Fix service bug"
```

→ it auto-runs `black`, `ruff`, and `mypy`.

---

## **8. GitHub Actions for CI/CD**

### Folder structure

```
.github/
 └── workflows/
      └── ci.yml
```

### `ci.yml` example

```yaml
name: CI Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest coverage ruff mypy

      - name: Run linters
        run: ruff check .

      - name: Run type checks
        run: mypy app/

      - name: Run tests with coverage
        run: |
          coverage run -m pytest
          coverage report --fail-under=80
```

✅ This workflow:

* Runs automatically on pushes/PRs.
* Fails if lint/type/test checks fail.
* Keeps `main` branch production-ready.

---

## **9. Optional: Deployment Step**

Add a second job to deploy automatically once tests pass:

```yaml
  deploy:
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    steps:
      - name: Deploy to server
        run: |
          echo "Deploying to production..."
          # Example: scp build to server or call `uvicorn`
```

---

## **10. Lab Exercise 🧪**

**Goal:** Add CI/CD quality gates to your project.

**Steps:**

1. Add `pytest` tests under `/tests`.
2. Measure coverage → enforce `--fail-under=80`.
3. Add `ruff` + `mypy` configs.
4. Configure `.pre-commit-config.yaml`.
5. Create `.github/workflows/ci.yml`.
6. Push to GitHub → observe automated pipeline.

---

## **✅ Summary**

| Tool              | Purpose                  | Run Command                    |
| ----------------- | ------------------------ | ------------------------------ |
| `pytest`          | Run all tests            | `pytest`                       |
| `coverage.py`     | Measure test coverage    | `coverage run -m pytest`       |
| `ruff` / `flake8` | Style and lint checks    | `ruff check .`                 |
| `mypy`            | Static type analysis     | `mypy app/`                    |
| `pre-commit`      | Auto check before commit | `pre-commit run --all-files`   |
| `GitHub Actions`  | Automate all above steps | via `.github/workflows/ci.yml` |

---
