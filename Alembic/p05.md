# **Lesson 5: Integrating Alembic with SQLAlchemy Models**

---

## **1. Purpose of Integration**

Alembic is used to keep your **database schema** in sync with your **SQLAlchemy models**.
Whenever you make changes in `models.py`, such as adding a new column or table, Alembic helps you **generate migration scripts** that apply those changes safely to the database.

---

## **2. How It Works**

1. **SQLAlchemy models** define your database structure in Python code.
2. **Alembic** reads these models through the configuration in `env.py`.
3. When you run `alembic revision --autogenerate -m "message"`, Alembic:

   * Compares the current models with the actual database.
   * Generates a migration file under `alembic/versions/`.
4. You can review and apply these migrations using `alembic upgrade head`.

---

## **3. Steps to Reflect Model Changes**

**Example file:** `app/models.py`

```python
from sqlalchemy import Column, Integer, String
from app.db import Base

class User(Base):
    __tablename__ = "users"
    id = Column(Integer, primary_key=True, index=True)
    name = Column(String(50))
    email = Column(String(120), unique=True, index=True)
```

Now suppose you **add a new column** later:

```python
# Add a new column
age = Column(Integer, nullable=True)
```

To update your database with this change:

```bash
alembic revision --autogenerate -m "Add age column to users table"
alembic upgrade head
```

Alembic automatically generates the migration script for the new `age` column.

---

## **4. Ensuring Consistency**

To maintain consistency between models and database:

* Always **run Alembic migrations** instead of directly altering the database manually.
* **Avoid editing old migration files** once applied.
* Use **autogenerate** to detect changes, then **review** the generated script before applying.

---

## **5. Example: Adding a New Table**

```python
class Product(Base):
    __tablename__ = "products"
    id = Column(Integer, primary_key=True, index=True)
    name = Column(String(100))
    price = Column(Integer)
```

Then create a migration:

```bash
alembic revision --autogenerate -m "Add products table"
alembic upgrade head
```

Alembic will generate SQL commands to create the new `products` table in the database.

---

## **6. Summary**

| Action                  | Command                                        | Description                    |
| ----------------------- | ---------------------------------------------- | ------------------------------ |
| Detect model changes    | `alembic revision --autogenerate -m "message"` | Generates migration file       |
| Apply migration         | `alembic upgrade head`                         | Applies all pending migrations |
| Rollback migration      | `alembic downgrade -1`                         | Undo last migration            |
| Check migration history | `alembic history`                              | View all migration scripts     |

---

**Key Idea:**
Alembic keeps your **models** and **database** in sync by generating and applying migrations whenever your schema changes. Always let Alembic handle these updates to prevent inconsistencies.

