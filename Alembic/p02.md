# Lesson 2: Setting Up Alembic in a FastAPI Project

## 1) Installing Alembic

Alembic is the tool that creates and runs database migrations for SQLAlchemy models.

**Install (inside your virtual environment):**

```bash
pip install alembic sqlalchemy
# If you use Postgres: pip install psycopg2-binary
# If you use MySQL:   pip install pymysql
# For SQLite you don't need an extra driver.
```

---

## 2) Folder & File Structure Overview

When you initialize Alembic, it creates a few important files/folders:

```
fastapi-app/
  app/
    __init__.py
    main.py
    db.py             # SQLAlchemy engine/session
    models.py         # Your SQLAlchemy models (Base = declarative_base())
  alembic/
    env.py            # Alembic environment script (loads DB & models metadata)
    script.py.mako    # Template for new migration files
    versions/         # Auto-generated migration files live here
  alembic.ini         # Alembic config (DB URL, logging, etc.)
  .env.example        # put DATABASE_URL here (optional but recommended)
```

* **`alembic.ini`**: Main config file. You can set or override the database URL here (or read from environment variables).
* **`alembic/env.py`**: Tells Alembic how to connect to the database and where to find your models’ `Base.metadata`.
* **`alembic/versions/`**: Every migration (revision) is a Python file inside this folder.

---

## 3) Initializing Alembic in a FastAPI Project

### Step A — Run the init command

From your project root (where `pyproject.toml` or `requirements.txt` lives):

```bash
alembic init alembic
```

This creates `alembic.ini` and the `alembic/` folder.

### Step B — Set the database URL

You can keep your DB URL in an environment variable (recommended), e.g. in `.env`:

```
DATABASE_URL=sqlite:///./app.db
# Examples:
# DATABASE_URL=postgresql+psycopg2://user:pass@localhost:5432/mydb
# DATABASE_URL=mysql+pymysql://user:pass@localhost:3306/mydb
```

In **`alembic.ini`**, leave the default and let `env.py` read from `os.environ`, or set it directly:

```ini
# alembic.ini
# (Option 1: leave empty and load from env in env.py)
sqlalchemy.url =

# (Option 2: hard-code it for quick start — not recommended for prod)
# sqlalchemy.url = sqlite:///./app.db
```

### Step C — Make sure your models expose `Base`

In `app/models.py`:

```python
from sqlalchemy.orm import DeclarativeBase, Mapped, mapped_column
from sqlalchemy import Integer, String

class Base(DeclarativeBase):
    pass

class User(Base):
    __tablename__ = "users"
    id: Mapped[int] = mapped_column(Integer, primary_key=True)
    name: Mapped[str] = mapped_column(String(100))
```

> If you already use `from sqlalchemy.orm import declarative_base; Base = declarative_base()`, that’s fine too.

### Step D — Point Alembic to your models’ metadata

Edit **`alembic/env.py`** so Alembic knows how to load the DB URL and `target_metadata`:

```python
# alembic/env.py
from __future__ import annotations
from logging.config import fileConfig
import os

from sqlalchemy import engine_from_config, pool
from alembic import context

# Interpret the config file for Python logging.
config = context.config
if config.config_file_name is not None:
    fileConfig(config.config_file_name)

# ---- Load DATABASE_URL from environment (fallback to alembic.ini) ----
database_url = os.getenv("DATABASE_URL")
if database_url:
    config.set_main_option("sqlalchemy.url", database_url)

# ---- Import your models' Base ----
# Adjust import path to where your Base is defined
from app.models import Base  # <- make sure this import works
target_metadata = Base.metadata

def run_migrations_offline() -> None:
    url = config.get_main_option("sqlalchemy.url")
    context.configure(
        url=url,
        target_metadata=target_metadata,
        literal_binds=True,
        dialect_opts={"paramstyle": "named"},
    )
    with context.begin_transaction():
        context.run_migrations()

def run_migrations_online() -> None:
    connectable = engine_from_config(
        config.get_section(config.config_ini_section),
        prefix="sqlalchemy.",
        poolclass=pool.NullPool,
    )
    with connectable.connect() as connection:
        context.configure(connection=connection, target_metadata=target_metadata)
        with context.begin_transaction():
            context.run_migrations()

if context.is_offline_mode():
    run_migrations_offline()
else:
    run_migrations_online()
```

> Tip: If Python can’t find `app.models`, ensure your working directory is the project root and that `app/` is a proper package (has `__init__.py`).

### Step E — Quick verification (optional but useful)

Create your **first migration** from your existing models:

```bash
alembic revision --autogenerate -m "init tables"
```

Apply it:

```bash
alembic upgrade head
```

* If using SQLite, a file like `app.db` will be created with the new tables.
* If using Postgres/MySQL, check your database to see the tables.

---

## That’s it!

You’ve installed Alembic, understood the key files, and wired it into your FastAPI project so migrations can be **autogenerated from your SQLAlchemy models** and applied safely. 
