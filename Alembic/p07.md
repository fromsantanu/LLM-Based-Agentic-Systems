# **Lesson 7: Best Practices for Alembic in FastAPI Projects**

---

### ðŸ§© 1. Version Control Strategies for Migrations

* **Keep migrations under version control (Git)**
  Always commit the `alembic/versions/` folder to your Git repository.
  This ensures that every team member has the same database migration history.

* **Create one migration per change set**
  Each time you change your SQLAlchemy models (add a column, table, or relationship), generate a separate migration.
  This makes it easier to trace what changed and when.

* **Use branching carefully**
  When multiple developers create migrations simultaneously, Alembic may generate **branch heads** (multiple latest revisions).
  Run:

  ```bash
  alembic heads
  ```

  to see if there are multiple heads, and use

  ```bash
  alembic merge <revision1> <revision2> -m "merge branch heads"
  ```

  to combine them.

* **Use consistent environments**
  All developers should use the same database URL and configuration for development, to avoid mismatches between local migrations.

---

### ðŸ§¾ 2. Naming Conventions and Meaningful Migration Messages

* **Descriptive filenames**
  Alembic automatically names migration files with timestamps and random strings.
  Add clear messages for human readability:

  ```bash
  alembic revision -m "add user_profile table"
  alembic revision -m "add email field to users table"
  ```

* **Follow a pattern**
  Use consistent verbs for migration names:

  * `add_...` â†’ when adding new columns/tables
  * `remove_...` â†’ when deleting columns/tables
  * `modify_...` or `alter_...` â†’ when changing existing structures

* **Document important schema changes**
  In larger teams, describe changes in the migration message or in a changelog to help others understand the impact.

---

### ðŸ§± 3. Common Issues and Troubleshooting

| Issue                            | Cause                                                                                                                        | Solution                                                                            |
| -------------------------------- | ---------------------------------------------------------------------------------------------------------------------------- | ----------------------------------------------------------------------------------- |
| **Autogenerate misses a change** | Alembic compares models to the database, but some changes (like server defaults or custom constraints) are not auto-detected | Edit the migration file manually and add the missing changes.                       |
| **Downgrade fails**              | Some operations (like dropping a column with data) canâ€™t be easily reversed                                                  | Write a safe downgrade manually or note that downgrade is not supported.            |
| **Multiple heads detected**      | Parallel migrations from different branches                                                                                  | Merge using `alembic merge` command.                                                |
| **Wrong database URL**           | Mismatch between `.env` and `alembic.ini`                                                                                    | Ensure both use the same connection string or configure it dynamically in `env.py`. |
| **Migrations not applied**       | Forgot to upgrade                                                                                                            | Run `alembic upgrade head` to apply all pending migrations.                         |

---

### ðŸ’¡ 4. Additional Best Practices

* **Use Alembic autogenerate cautiously:**
  Always review the autogenerated migration script before applying it to production.

* **Back up production databases before upgrade:**
  Always take a snapshot or backup before applying migrations in production.

* **Keep development and production databases in sync:**
  Avoid schema drift by always running migrations through Alembic, never manual SQL changes.

* **Tag your production releases:**
  You can tag specific migration revisions to mark release points:

  ```bash
  alembic stamp <revision_id>
  ```

---

### âœ… Summary

Alembic migrations are like version control for your database.
Following consistent naming, proper version control, and cautious review helps you keep your database schema clean, traceable, and in sync across all environments.

---
