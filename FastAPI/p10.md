# Chapter 10: Middleware

In FastAPI, **middleware** is a function that runs **before** and **after** each request.
It allows you to process requests globallyâ€”for example, adding security headers, logging requests, measuring execution time, or handling CORS.

---

## 1. What is Middleware?

Middleware sits between the client and your route handlers:

* **Before request** â†’ modify/inspect the request.
* **Pass to route handler**.
* **After response** â†’ modify/inspect the response.

FastAPI is built on **Starlette**, so we can use its middleware system directly.

---

## 2. Creating Custom Middleware

You can define custom middleware using `@app.middleware("http")`.

```python
from fastapi import FastAPI, Request
import time

app = FastAPI()

@app.middleware("http")
async def add_process_time_header(request: Request, call_next):
    start_time = time.time()
    response = await call_next(request)  # Process request
    process_time = time.time() - start_time
    response.headers["X-Process-Time"] = str(process_time)
    return response

@app.get("/")
async def root():
    return {"message": "Hello with Middleware!"}
```

ðŸ‘‰ This middleware:

* Runs before the request reaches the endpoint.
* Calls the endpoint via `call_next(request)`.
* Runs after the response is generated.
* Adds a custom header showing execution time.

---

## 3. CORS (Cross-Origin Resource Sharing) Setup

When your frontend (e.g., React, Angular, Vue) calls your FastAPI backend from a different domain, the browser enforces **CORS policies**.

FastAPI provides a built-in CORS middleware.

```python
from fastapi.middleware.cors import CORSMiddleware

origins = [
    "http://localhost:3000",   # React frontend
    "http://127.0.0.1:5500",   # Local HTML testing
    "https://myfrontend.com"   # Production frontend
]

app.add_middleware(
    CORSMiddleware,
    allow_origins=origins,       # Specific origins
    allow_credentials=True,
    allow_methods=["*"],         # Allow all methods (GET, POST, etc.)
    allow_headers=["*"],         # Allow all headers
)
```

ðŸ‘‰ Without this, browsers may block your frontend requests with
**CORS error: "Access to fetch at ... has been blocked by CORS policy"**.

---

## 4. Logging Middleware

Logging is a common use-case for middleware.
You may want to log request method, path, and execution time.

```python
import time
import logging
from fastapi import FastAPI, Request

logging.basicConfig(level=logging.INFO)

app = FastAPI()

@app.middleware("http")
async def log_requests(request: Request, call_next):
    start_time = time.time()
    
    response = await call_next(request)
    
    duration = time.time() - start_time
    logging.info(
        f"Method: {request.method} | Path: {request.url.path} | "
        f"Status: {response.status_code} | Duration: {duration:.4f}s"
    )
    
    return response

@app.get("/hello")
async def hello():
    return {"message": "Hello, Middleware Logging!"}
```

ðŸ“Œ Sample log output:

```
INFO:root:Method: GET | Path: /hello | Status: 200 | Duration: 0.0005s
```

---

## 5. Example: Logging Request Execution Time

Letâ€™s combine everything into a **full working example**:

```python
from fastapi import FastAPI, Request
from fastapi.middleware.cors import CORSMiddleware
import time
import logging

logging.basicConfig(level=logging.INFO)

app = FastAPI()

# 1. Add CORS Middleware
app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],  # Allow all origins (use carefully in production!)
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)

# 2. Add Logging Middleware
@app.middleware("http")
async def log_and_time_requests(request: Request, call_next):
    start_time = time.time()
    response = await call_next(request)
    duration = time.time() - start_time
    logging.info(f"{request.method} {request.url.path} completed in {duration:.4f}s")
    response.headers["X-Execution-Time"] = str(duration)
    return response

# 3. Routes
@app.get("/")
async def home():
    return {"message": "Middleware in action!"}

@app.get("/items/{item_id}")
async def get_item(item_id: int):
    return {"item_id": item_id, "status": "fetched"}
```

âœ… Features:

* Handles CORS for external clients.
* Logs request method, path, duration.
* Adds custom response header `X-Execution-Time`.

---

## âœ… Summary

* Middleware runs before and after every request.
* Use **custom middleware** for adding headers, timing, or request modifications.
* Use **CORS middleware** to allow frontend apps from different domains.
* Logging middleware helps monitor API performance.

---

