# Chapter 16 — FastAPI with Frontend

**Goal:** Render HTML with Jinja2, serve static assets (CSS/JS/images), and build a tiny blog UI.

---

## 16.1 Why templates + static files?

* **Templates** let you reuse layouts and inject server-side data safely (auto-escaped).
* **Static files** (CSS/JS/images) are best served from a dedicated folder mounted by FastAPI/Starlette.

---

## 16.2 Install & project layout

```bash
pip install fastapi "uvicorn[standard]" jinja2 python-multipart
```

**Recommended structure**

```
fastapi-frontend/
├─ app.py
├─ templates/
│  ├─ base.html
│  ├─ index.html
│  ├─ post_detail.html
│  └─ new_post.html
└─ static/
   ├─ styles.css
   └─ app.js
```

* `templates/` holds Jinja2 templates
* `static/` holds CSS/JS/images

---

## 16.3 Minimal setup: Jinja2 + StaticFiles

```python
# app.py
from fastapi import FastAPI, Request, Form
from fastapi.responses import HTMLResponse, RedirectResponse
from fastapi.staticfiles import StaticFiles
from fastapi.templating import Jinja2Templates
from typing import Optional
from datetime import datetime

app = FastAPI()

# 1) Mount static files at /static
app.mount("/static", StaticFiles(directory="static"), name="static")

# 2) Configure templates
templates = Jinja2Templates(directory="templates")

# In-memory "database"
POSTS = [
    {"id": 1, "title": "Hello FastAPI", "slug": "hello-fastapi",
     "body": "FastAPI is fast and developer-friendly!", "created_at": datetime(2025, 9, 1)},
    {"id": 2, "title": "Templates with Jinja2", "slug": "templates-jinja2",
     "body": "Jinja2 + FastAPI = simple and powerful.", "created_at": datetime(2025, 9, 10)}
]

def get_post_by_slug(slug: str):
    return next((p for p in POSTS if p["slug"] == slug), None)

@app.get("/", response_class=HTMLResponse)
def home(request: Request, q: Optional[str] = None):
    # simple search by title
    posts = POSTS
    if q:
        posts = [p for p in POSTS if q.lower() in p["title"].lower()]
    return templates.TemplateResponse("index.html", {"request": request, "posts": posts, "q": q})

@app.get("/post/{slug}", response_class=HTMLResponse)
def post_detail(request: Request, slug: str):
    post = get_post_by_slug(slug)
    if not post:
        return templates.TemplateResponse("post_detail.html", {"request": request, "post": None}, status_code=404)
    return templates.TemplateResponse("post_detail.html", {"request": request, "post": post})

@app.get("/new", response_class=HTMLResponse)
def new_post_form(request: Request):
    return templates.TemplateResponse("new_post.html", {"request": request})

@app.post("/new")
def create_post(title: str = Form(...), slug: str = Form(...), body: str = Form(...)):
    # naive uniqueness check
    if get_post_by_slug(slug):
        # redirect back with a query flag (simple UX)
        return RedirectResponse(url="/new?error=slug-taken", status_code=303)
    POSTS.append({"id": len(POSTS) + 1, "title": title, "slug": slug, "body": body, "created_at": datetime.utcnow()})
    return RedirectResponse(url=f"/post/{slug}", status_code=303)
```

**Run:**

```bash
uvicorn app:app --reload
```

---

## 16.4 Templates

### `templates/base.html`

Shows how to include CSS/JS, define blocks, and use `url_for` via the injected `request`.

```html
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>{% block title %}My FastAPI Blog{% endblock %}</title>
  <link rel="stylesheet" href="{{ request.url_for('static', path='styles.css') }}">
</head>
<body>
  <header class="site-header">
    <a class="brand" href="{{ request.url_for('home') }}">FastAPI Blog</a>
    <nav>
      <a href="{{ request.url_for('home') }}">Home</a>
      <a href="{{ request.url_for('new_post_form') }}">New Post</a>
      <a href="https://fastapi.tiangolo.com/" target="_blank" rel="noopener">Docs</a>
    </nav>
  </header>

  <main class="container">
    {% block content %}{% endblock %}
  </main>

  <script src="{{ request.url_for('static', path='app.js') }}"></script>
</body>
</html>
```

> **Note:** `request` **must** be in the context so `url_for` works inside templates.

---

### `templates/index.html`

List posts and provide a simple search.

```html
{% extends "base.html" %}
{% block title %}Home · My FastAPI Blog{% endblock %}

{% block content %}
<h1>Latest Posts</h1>

<form method="get" action="{{ request.url_for('home') }}" class="search">
  <input type="text" name="q" placeholder="Search title…" value="{{ q or '' }}">
  <button type="submit">Search</button>
</form>

<ul class="post-list">
  {% for p in posts %}
    <li>
      <a class="post-title" href="{{ request.url_for('post_detail', slug=p.slug) }}">{{ p.title }}</a>
      <div class="meta">
        <time datetime="{{ p.created_at.isoformat() }}">{{ p.created_at.strftime("%b %d, %Y") }}</time>
      </div>
      <p class="excerpt">{{ p.body[:120] }}{% if p.body|length > 120 %}…{% endif %}</p>
    </li>
  {% else %}
    <li>No posts found.</li>
  {% endfor %}
</ul>
{% endblock %}
```

---

### `templates/post_detail.html`

Show one post or a 404 message.

```html
{% extends "base.html" %}
{% block title %}{{ post.title if post else "Not found" }} · My FastAPI Blog{% endblock %}

{% block content %}
{% if post %}
  <article class="post">
    <h1>{{ post.title }}</h1>
    <div class="meta">
      <time datetime="{{ post.created_at.isoformat() }}">{{ post.created_at.strftime("%b %d, %Y") }}</time>
    </div>
    <div class="body">
      {{ post.body }}
    </div>
  </article>
{% else %}
  <h1>404 — Post not found</h1>
  <p>We couldn’t locate that post. <a href="{{ request.url_for('home') }}">Go back home</a>.</p>
{% endif %}
{% endblock %}
```

---

### `templates/new_post.html`

Simple form using `Form` data captured by the `/new` POST route.

```html
{% extends "base.html" %}
{% block title %}New Post · My FastAPI Blog{% endblock %}

{% block content %}
<h1>Create a new post</h1>

{% set error = request.query_params.get("error") %}
{% if error == "slug-taken" %}
  <p class="error">Slug is already taken. Choose a different one.</p>
{% endif %}

<form method="post" action="{{ request.url_for('create_post') }}" class="post-form">
  <label>Title
    <input type="text" name="title" required>
  </label>

  <label>Slug (e.g., "my-first-post")
    <input type="text" name="slug" pattern="^[a-z0-9-]+$" required>
  </label>

  <label>Body
    <textarea name="body" rows="8" required></textarea>
  </label>

  <button type="submit">Publish</button>
</form>
{% endblock %}
```

---

## 16.5 Static assets

### `static/styles.css`

(very small, just to see things working)

```css
body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 0; }
.site-header { display:flex; align-items:center; justify-content:space-between; padding:12px 20px; border-bottom:1px solid #eee; }
.brand { font-weight:700; text-decoration:none; }
.container { max-width: 880px; margin: 24px auto; padding: 0 16px; }
.post-list { list-style: none; padding: 0; display: grid; gap: 16px; }
.post-title { font-size: 1.1rem; font-weight: 600; text-decoration: none; }
.meta { color: #666; font-size: 0.9rem; margin: 6px 0 8px; }
.search { margin: 8px 0 16px; display:flex; gap: 8px; }
.search input { flex: 1; padding: 6px 8px; }
.post-form label { display:block; margin: 10px 0; }
.post-form input, .post-form textarea { width: 100%; padding: 8px; }
.error { color: #b00020; margin: 8px 0; }
```

### `static/app.js`

```javascript
// placeholder JS
console.log("FastAPI Blog frontend loaded.");
```

---

## 16.6 Key concepts & best practices

1. **Use `TemplateResponse`**

   * Always include the `request` object in the context: `{"request": request, ...}`.
   * Jinja2 auto-escapes variables in HTML by default—safe against injection if you avoid using `|safe` on untrusted data.

2. **Mount static files once**

   ```python
   app.mount("/static", StaticFiles(directory="static"), name="static")
   ```

   * Reference them with `request.url_for('static', path='...')` inside templates.

3. **Template inheritance**

   * Create a `base.html` and extend it—keeps layouts DRY.

4. **POST forms**

   * Add `python-multipart` to parse form data.
   * Use `Form(...)` parameters in your handler.

5. **Redirect after POST (PRG pattern)**

   * After creating a resource, `RedirectResponse(..., status_code=303)` avoids double submissions.

6. **URLs in templates**

   * Use `request.url_for("route_name", **params)`; route name defaults to the function name unless `name="..."` is set on the decorator.

7. **SEO & usability**

   * Unique `<title>` per page, semantic headings, `<time>` elements with ISO `datetime`.

---

## 16.7 (Optional) Named routes for clarity

You can name routes to decouple view function names from URL building:

```python
@app.get("/", response_class=HTMLResponse, name="home")
def home(request: Request): ...
```

In templates: `request.url_for('home')`.

---

## 16.8 (Optional) Serving a favicon

Place `static/favicon.ico` and add:

```python
from fastapi.responses import FileResponse

@app.get("/favicon.ico", include_in_schema=False)
def favicon():
    return FileResponse("static/favicon.ico")
```

(Or just link `<link rel="icon" href="{{ request.url_for('static', path='favicon.ico') }}">`.)

---

## 16.9 (Optional) Template filters & globals

You can register custom filters:

```python
# after templates = Jinja2Templates(...)
def human_date(dt):
    return dt.strftime("%d %b %Y")

templates.env.filters["human_date"] = human_date
```

Use in template: `{{ post.created_at|human_date }}`.

---

## 16.10 Putting it all together (what you now have)

* A homepage that lists posts and supports a simple title search.
* A detail page per post `/post/{slug}` with 404 handling.
* A new-post form that creates content and redirects to the detail page.
* Static CSS & JS served from `/static`.

---

## 16.11 Next steps

* Persist posts in a **database** (see Chapter 8) and fetch with an ORM.
* Add **auth** for authoring (Chapter 7 JWT sessions or cookie-based).
* Add **Flash messages/CSRF** if you move toward full forms (use `starlette-wtf` or your preferred CSRF approach).
* Add pagination, tags, categories, and a search box that hits your DB.

---

### Quick test checklist

* Open `http://127.0.0.1:8000/` → see list.
* Click a post → detail shows.
* Visit `/new` → create a post → redirected to `/post/{slug}`.
* Check the browser console → “FastAPI Blog frontend loaded.”

You now have a clean baseline for **FastAPI + Jinja2 + static files**—perfect for dashboards, admin panels, or small content sites.

