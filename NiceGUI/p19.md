# **Lesson 19: Prefilling Forms with Previous Visit Records**

*(Useful for a ‚Äúpatient revisit workflow‚Äù)*

### **What you will learn**

In this lesson, you will learn how to show a form where some fields are **already filled in** using data from the patient‚Äôs last visit.

This is very useful in real clinics where:

* the patient comes for a revisit
* the doctor wants to see last visit notes
* some fields stay the same (name, age, chronic conditions, medicines)
* only the latest complaints change

You will learn how NiceGUI can fetch this old data from a FastAPI backend and automatically fill the form.

---

## üè• **Real-life example**

Imagine you visited a doctor 10 days ago for cough, and now you revisit for follow-up.

When the doctor opens your form:

* Your **name**, **age**, and **earlier symptoms** should already be filled.
* Only the **new symptoms** need to be added.

This makes work faster and reduces mistakes.

---

# -----------------------------------

# **PART 1 ‚Äî FastAPI Backend**

# -----------------------------------

We will make two API endpoints:

1. **GET /visit/{patient_id}**
   ‚Üí fetch last visit details
2. **POST /visit/save**
   ‚Üí save new visit details

We will use SQLite for simplicity.

---

# **backend.py (FastAPI + SQLite)**

```python
from fastapi import FastAPI
from pydantic import BaseModel
import sqlite3

app = FastAPI()

# Create database
conn = sqlite3.connect('visits.db', check_same_thread=False)
cursor = conn.cursor()

# Create table
cursor.execute('''
CREATE TABLE IF NOT EXISTS visits (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    patient_id INTEGER,
    name TEXT,
    age INTEGER,
    symptoms TEXT,
    diagnosis TEXT
)
''')
conn.commit()

# Model for saving data
class Visit(BaseModel):
    patient_id: int
    name: str
    age: int
    symptoms: str
    diagnosis: str = ''

# -----------------------------
# GET LAST VISIT
# -----------------------------
@app.get('/visit/{patient_id}')
def get_last_visit(patient_id: int):
    cursor.execute(
        "SELECT name, age, symptoms, diagnosis FROM visits WHERE patient_id=? ORDER BY id DESC LIMIT 1",
        (patient_id,)
    )
    row = cursor.fetchone()

    if row:
        return {
            "name": row[0],
            "age": row[1],
            "symptoms": row[2],
            "diagnosis": row[3]
        }
    return {"message": "No previous visit"}

# -----------------------------
# SAVE CURRENT VISIT
# -----------------------------
@app.post('/visit/save')
def save_visit(v: Visit):
    cursor.execute(
        "INSERT INTO visits (patient_id, name, age, symptoms, diagnosis) VALUES (?, ?, ?, ?, ?)",
        (v.patient_id, v.name, v.age, v.symptoms, v.diagnosis)
    )
    conn.commit()
    return {"message": "Visit saved"}
```

---

# **Simple explanation**

* Database table `visits` stores each visit.
* When NiceGUI asks for `/visit/1`, FastAPI returns the **most recent** visit of patient 1.
* When NiceGUI submits new visit data to `/visit/save`, FastAPI stores it.

This is like the clinic storing each visit in a register.

---

# -----------------------------------

# **PART 2 ‚Äî NiceGUI Frontend**

# -----------------------------------

The NiceGUI form will:

1. Ask for patient ID
2. Fetch their last visit from backend
3. Pre-fill the fields
4. Allow editing
5. Save the new visit

---

# **frontend.py (NiceGUI Form with Prefill)**

```python
from nicegui import ui
import requests

ui.label('Patient Revisit Form').classes('text-h5')

patient_id = ui.input('Enter Patient ID')

# Form fields
name = ui.input('Name')
age = ui.input('Age')
prev_symptoms = ui.textarea('Previous Symptoms')
diagnosis = ui.textarea('Previous Diagnosis')
new_symptoms = ui.textarea('New Symptoms (for today)')

# -----------------------------------
# LOAD PREVIOUS VISIT DATA
# -----------------------------------
def load_previous():
    pid = patient_id.value

    response = requests.get(f"http://localhost:8000/visit/{pid}")
    data = response.json()

    if "message" in data:
        ui.notify("No previous visit found", color='red')
    else:
        name.value = data['name']
        age.value = str(data['age'])
        prev_symptoms.value = data['symptoms']
        diagnosis.value = data['diagnosis']
        ui.notify("Previous visit loaded", color='green')

ui.button('Load Previous Visit', on_click=load_previous)

# -----------------------------------
# SAVE NEW VISIT
# -----------------------------------
def save_visit():
    data = {
        "patient_id": int(patient_id.value),
        "name": name.value,
        "age": int(age.value),
        "symptoms": new_symptoms.value,
        "diagnosis": diagnosis.value
    }

    response = requests.post("http://localhost:8000/visit/save", json=data)

    if response.status_code == 200:
        ui.notify('Visit saved successfully', color='green')
    else:
        ui.notify('Error saving visit', color='red')

ui.button('Save New Visit', on_click=save_visit)

ui.run()
```

---

# **Line-by-line explanation**

### **Form Fields**

* `patient_id` ‚Üí ID of the patient
* `name`, `age` ‚Üí prefilled from last visit
* `prev_symptoms` ‚Üí info from last visit
* `new_symptoms` ‚Üí info for today's visit

### **load_previous()**

* Calls FastAPI `/visit/{id}`
* If found ‚Üí fills all fields
* If not found ‚Üí shows error

### **save_visit()**

* Sends today‚Äôs new symptoms and existing patient details
* Stored in database as new visit record

### **ui.run()**

Starts the NiceGUI app.

---

# **How to run it**

### Step 1: Start backend

```
uvicorn backend:app --reload
```

### Step 2: Start frontend

```
python frontend.py
```

Then open:
**[http://localhost:8080](http://localhost:8080)**

---

# **Tips & Best Practices**

### ‚≠ê Tip 1

Always separate **old symptoms** and **new symptoms**.
Doctors need to compare changes.

### ‚≠ê Tip 2

Show a message like *‚ÄúPrevious visit loaded‚Äù* so the doctor knows data is correct.

---

