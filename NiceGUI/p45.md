# Lesson 46: Using Nginx for Production Deployment

In this lesson you’ll learn how to put **Nginx in front of your NiceGUI + FastAPI app** for a more **“production-style”** setup.

Think of it like this:

* **uvicorn + NiceGUI + FastAPI** → the **restaurant kitchen**
* **Nginx** → the **gate + front desk**
* **Browser (users)** → the **customers**

Customers never walk into the kitchen directly.
They first reach the gate/front desk → that’s Nginx.

---

## 1. What we want to achieve

Your app will work like this:

**Browser → Nginx (port 80) → uvicorn (port 8000) → NiceGUI + FastAPI app**

Why do this?

* You can use **port 80** (normal HTTP) or **443** (HTTPS)
* Nginx can handle **many users efficiently**
* You can easily add SSL later (Let’s Encrypt)

---

## 2. Prerequisites

We assume:

1. You already have your app (from Lesson 44 or 45), something like:

   ```python
   # main.py
   from fastapi import FastAPI
   from nicegui import ui

   app = FastAPI()

   @app.get('/api/hello')
   def hello():
       return {'message': 'Hello from FastAPI!'}

   @ui.page('/')
   def index_page():
       ui.label('Hello from NiceGUI behind Nginx')
       ui.button('Click me', on_click=lambda: ui.notify('Nginx works!'))

   ui.run_with(app, title='NiceGUI + FastAPI with Nginx')
   ```

2. You can run it with uvicorn on your server:

   ```bash
   uvicorn main:app --host 0.0.0.0 --port 8000
   ```

3. You are on a Linux server (for example Ubuntu) with `sudo` access.

---

## 3. Step 1 – Install Nginx

On Ubuntu:

```bash
sudo apt update
sudo apt install nginx
```

Check if Nginx is running:

```bash
systemctl status nginx
```

If it shows “active (running)”, it’s fine.

Open a browser and go to your server’s IP:

```text
http://your_server_ip/
```

You should see the default “Welcome to Nginx” page.

---

## 4. Step 2 – Keep uvicorn running

For now, we keep it simple and just run:

```bash
cd /path/to/your/app
uvicorn main:app --host 0.0.0.0 --port 8000
```

Later you can use **systemd**, **pm2**, **supervisor**, or **Docker** to keep it always running.

For testing, keep this terminal open so uvicorn keeps running.

---

## 5. Step 3 – Create Nginx config for your app

We will create a separate Nginx “site” for the app.

### 5.1 Create a new config file

```bash
sudo nano /etc/nginx/sites-available/nicegui_app
```

Put this content inside:

```nginx
server {
    listen 80;
    server_name your_domain.com;  # or your_server_ip

    # Forward all requests to uvicorn / NiceGUI
    location / {
        proxy_pass         http://127.0.0.1:8000;
        proxy_set_header   Host $host;
        proxy_set_header   X-Real-IP $remote_addr;
        proxy_set_header   X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header   X-Forwarded-Proto $scheme;

        # (optional) increase timeouts if needed
        proxy_read_timeout 300;
        proxy_connect_timeout 300;
    }
}
```

Explanation in simple words:

* `listen 80;` → Nginx listens on normal HTTP port 80
* `server_name your_domain.com;` → replace with your real domain or server IP
* `location /` → all paths (`/`, `/api/hello`, etc.)
* `proxy_pass http://127.0.0.1:8000;` → send requests to uvicorn running on port 8000

### 5.2 Enable this site

Create a symbolic link:

```bash
sudo ln -s /etc/nginx/sites-available/nicegui_app /etc/nginx/sites-enabled/
```

Optional: remove the default site so it doesn’t conflict:

```bash
sudo rm /etc/nginx/sites-enabled/default
```

### 5.3 Test and reload Nginx

Check if the config is OK:

```bash
sudo nginx -t
```

If it says `syntax is ok` and `test is successful`, reload:

```bash
sudo systemctl reload nginx
```

---

## 6. Step 4 – Test in browser

Now:

1. Make sure uvicorn is still running on port 8000.
2. In your browser, go to:

   ```text
   http://your_domain.com/
   ```

   or

   ```text
   http://your_server_ip/
   ```

You should see your **NiceGUI page**.

Try:

```text
http://your_domain.com/api/hello
```

You should see the **FastAPI JSON**.

Now users are talking to **Nginx**, and Nginx is talking to your **NiceGUI app**.

---

## 7. Optional – Using Nginx with Docker

If your NiceGUI app is running inside Docker on port 8000, from Nginx’s point of view it’s almost the same:

* Your `proxy_pass` still points to `http://127.0.0.1:8000;` (if port 8000 is published to host).
* You just run Docker like:

  ```bash
  docker run -d -p 8000:8000 nicegui-demo
  ```

Then Nginx sends traffic to `localhost:8000`, which forwards to the Docker container.

For more complex setups, you can:

* Run Nginx also in Docker
* Use `docker-compose` to connect them inside a Docker network

But the **basic idea stays the same**:
Nginx → your app (uvicorn) → NiceGUI.

---

## 8. Tips & best practices

### Tip 1: Add HTTPS later

For real users, you should use HTTPS.
You can use **Certbot + Nginx** to get free SSL certificates (Let’s Encrypt).

### Tip 2: Keep uvicorn supervised

Use:

* `systemd`
* or `supervisor`
* or Docker

…to make sure uvicorn restarts if the server reboots.

### Tip 3: Use a domain name

Instead of IP, map a domain like:

```nginx
server_name clinic.yourdomain.com;
```

This looks more professional and is required for easy HTTPS.

---
