# **Lesson 12: Building a Medical Diagnostic Chatbot UI**

*(Your main use-case: doctor enters symptoms ‚Üí AI asks questions ‚Üí diagnosis suggestions ‚Üí test suggestions ‚Üí treatment plan)*

In this lesson, you will build a **simple but powerful** chat interface that supports the basic workflow of a medical assistant:

1. Doctor types symptoms or observations
2. Chatbot replies with relevant follow-up questions
3. Chatbot narrows down possibilities
4. Chatbot suggests diagnosis + tests + treatment direction
5. Doctor continues the conversation with context memory

We will keep everything simple so a beginner can understand it easily.

---

# üåø Real-life picture

Imagine a doctor examining a patient.

* Doctor: ‚ÄúPatient has fever, cough, and body ache.‚Äù
* Assistant: ‚ÄúPlease ask if the patient has breathlessness.‚Äù
* Doctor: ‚ÄúYes, mild.‚Äù
* Assistant: ‚ÄúPossible causes: Viral infection, pneumonia‚Ä¶ Perform chest auscultation, consider CBC, CRP‚Ä¶‚Äù

Our chatbot will do this same step-by-step ‚Äúreasoning conversation‚Äù.

---

# ‚≠ê What we will build

**A simple NiceGUI page:**

* a title
* a panel that shows **chat history**
* an input box where the doctor enters clinical notes
* a ‚ÄúSend‚Äù button
* the chatbot replies intelligently
* the AI uses **conversation memory** and **role = doctor**

The UI will look like a small WhatsApp-style doctor console.

---

# ‚≠ê PART A ‚Äî Frontend (NiceGUI)

We will start with a clean, simple UI.

---

## üíª Code: NiceGUI Medical Chat UI

Save as: **diagnostic_ui.py**

```python
from nicegui import ui
import requests
import asyncio

BACKEND_URL = "http://localhost:8000/diagnose"

# session-based conversation memory
ui.session_state.setdefault("chat_history", [])

async def send_message():
    doctor_text = input_box.value

    if not doctor_text.strip():
        return

    # add doctor message
    ui.session_state.chat_history.append(
        {"role": "doctor", "content": doctor_text}
    )
    refresh_chat()
    input_box.value = ""

    # typing indicator
    typing = ui.label("AI is thinking...").classes("text-gray-500 italic")
    await asyncio.sleep(0.1)

    # call backend
    try:
        response = requests.post(
            BACKEND_URL,
            json={"history": ui.session_state.chat_history},
            timeout=20,
        )
        data = response.json()
        reply = data.get("reply", "No reply.")
    except Exception as e:
        reply = f"Error: {e}"

    typing.delete()

    # add AI response
    ui.session_state.chat_history.append(
        {"role": "assistant", "content": reply}
    )
    refresh_chat()


def refresh_chat():
    chat_area.clear()

    for msg in ui.session_state.chat_history:
        if msg["role"] == "doctor":
            bubble = ui.label(f"Doctor: {msg['content']}", parent=chat_area)
            bubble.classes("bg-blue-100 p-2 rounded w-fit")
        else:
            bubble = ui.label(f"AI: {msg['content']}", parent=chat_area)
            bubble.classes("bg-green-100 p-2 rounded w-fit")


with ui.column().classes("w-1/2 q-pa-md"):
    ui.label("Medical Diagnostic Chatbot").classes("text-h5")

    ui.label("Enter patient symptoms, observations, and test results.").classes(
        "text-gray-600 text-sm q-mb-md"
    )

    chat_area = ui.column().classes(
        "border rounded p-4 h-64 overflow-y-auto bg-white"
    )

    with ui.row().classes("w-full items-center q-pt-md"):
        input_box = ui.input(
            placeholder="Describe symptoms..."
        ).classes("w-full")
        ui.button("Send", on_click=send_message)

ui.run()
```

---

# üßæ Explanation (Frontend)

### ‚úî A clean layout (column ‚Üí title ‚Üí chat box ‚Üí input row)

This makes the UI simple and professional.

---

### ‚úî Session memory

```python
ui.session_state.setdefault("chat_history", [])
```

Keeps conversation across messages.

---

### ‚úî Doctor messages stored as:

```python
{"role": "doctor", "content": doctor_text}
```

---

### ‚úî AI messages stored as:

```python
{"role": "assistant", "content": reply}
```

---

### ‚úî Typing indicator

Shows:

```
AI is thinking...
```

while waiting for backend.

---

### ‚úî Chat bubbles

Doctors ‚Üí blue
AI ‚Üí green

Makes the interface visually clear.

---

---

# ‚≠ê PART B ‚Äî Backend (FastAPI for medical reasoning)

We now build a simple diagnostic engine using OpenAI.

---

## üíª Backend Code

Save as: **diagnostic_backend.py**

```python
import os
from fastapi import FastAPI
from pydantic import BaseModel
from openai import OpenAI

app = FastAPI()
client = OpenAI(api_key=os.getenv("OPENAI_API_KEY"))

class Message(BaseModel):
    role: str
    content: str

class Conversation(BaseModel):
    history: list[Message]

class Response(BaseModel):
    reply: str

@app.post("/diagnose", response_model=Response)
def diagnose(request: Conversation):

    # create a very powerful medical system instruction
    system_prompt = (
        "You are an expert clinical assistant that helps doctors do differential "
        "diagnosis. You must:\n"
        "- Interpret symptoms step-by-step\n"
        "- Ask focused follow-up questions\n"
        "- Suggest differential diagnoses logically\n"
        "- Suggest tests only when needed\n"
        "- Explain your reasoning simply\n"
        "- Avoid giving treatment without evaluating properly\n"
    )

    # build message list
    messages = [{"role": "system", "content": system_prompt}]

    for msg in request.history:
        if msg.role == "doctor":
            messages.append({"role": "user", "content": f"DOCTOR: {msg.content}"})
        else:
            messages.append({"role": "assistant", "content": msg.content})

    # call OpenAI
    completion = client.chat.completions.create(
        model="gpt-4o-mini",
        messages=messages,
    )

    ai_reply = completion.choices[0].message["content"]
    return Response(reply=ai_reply)
```

---

# üßæ Explanation (backend)

### ‚úî System prompt describes how AI should behave

This is crucial for medical workflow.

It tells AI to:

* think methodically
* ask good questions
* avoid unsafe shortcuts
* suggest tests only when necessary

---

### ‚úî The doctor‚Äôs message is labeled clearly:

```
DOCTOR: Patient has body ache and dry cough.
```

This helps the AI understand the context.

---

### ‚úî The entire conversation is sent every time

So the AI remembers all previous answers.

---

### ‚úî The AI model suggests

* differential diagnoses
* follow-up questions
* red-flag warnings
* recommended tests

This matches your real diagnostic workflow.

---

---

# ‚ñ∂Ô∏è How to Run the Whole System

## Step 1: Start backend

```bash
uvicorn diagnostic_backend:app --reload
```

## Step 2: Start frontend

```bash
python diagnostic_ui.py
```

## Step 3: Open browser

```
http://localhost:8080
```

---

# üåø Try an example conversation

### Doctor:

Patient has fever, headache, and body ache.

### AI:

Does the patient also have cough, rash, or neck stiffness?
Is fever continuous or comes and goes?

---

### Doctor:

No cough. Slight neck pain. Fever comes and goes.

### AI:

Possible causes: Dengue, viral fever, meningitis (less likely).
Please check platelet count, CBC, and look for rash or vomiting.

---

This is exactly how a real diagnostic assistant works.

---

# üí° Tips & Best Practices

### ‚úî Tip 1 ‚Äî Add doctor ID / patient ID later

For your real system.

---

### ‚úî Tip 2 ‚Äî Attach structured JSON outputs later

For prescription builder or test-ordering system.

---

### ‚úî Tip 3 ‚Äî Add ‚Äústop and generate prescription‚Äù button

We can do this in a future lesson.

---

### ‚úî Tip 4 ‚Äî Add pages for patient history, lab results, imaging

NiceGUI supports multi-page apps easily.

---

# üéâ Summary

In this lesson you learned how to:

* build a clean medical chat UI
* store conversation context
* send full history to backend
* use a medical system prompt
* get structured diagnostic replies
* imitate real doctor‚Äìassistant workflow

Your chatbot is now a **mini diagnostic assistant**, ready to grow into your full medical assistant system.

---


