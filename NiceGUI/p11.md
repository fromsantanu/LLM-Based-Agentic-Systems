# **Lesson 11: Adding User Roles (Doctor, Patient, Admin) in Chat**

In this lesson, youâ€™ll learn how to let your chatbot know **who is talking**.

Until now, your chat had only one type of user:
**â€œUserâ€**

But in real systems (especially medical systems), there are different people using the chat:

* **Doctor** â†’ asks medical questions
* **Patient** â†’ gives symptoms
* **Admin** â†’ checks system status, users, logs

Each role may need **different instructions**, **different permissions**, and **different conversation flows**.

We will learn how to send this role information from NiceGUI â†’ FastAPI â†’ OpenAI.

---

## ğŸ§  Real-life example

Think of a hospital:

* A **doctor** can ask medical questions.
* A **patient** explains symptoms.
* An **admin** manages registrations and reports.

If all of them talk through the same chatbot, the system must know **who is speaking** so it can behave properly.

This lesson teaches you exactly how to do that.

---

# â­ What we will build

1. A dropdown selector on the NiceGUI page:

   * Choose: **Doctor**, **Patient**, or **Admin**
2. The selected role will be sent to FastAPI
3. FastAPI will pass the role to the AI model
4. The AI will reply differently depending on the role

This is an important step for your medical chatbot system.

---

# â­ PART A â€” Updating the NiceGUI frontend

We add a small dropdown (select box) on top of the chat.

---

## ğŸ’» Code: NiceGUI frontend with user roles

Create file: **chat_frontend_roles.py**

```python
from nicegui import ui
import requests
import asyncio

BACKEND_URL = "http://localhost:8000/chat"

ui.session_state.setdefault("chat_history", [])

async def send_message():
    user_text = input_box.value
    role = role_selector.value   # doctor / patient / admin

    if not user_text.strip():
        return

    # add user message with role
    ui.session_state.chat_history.append(
        {"role": "user", "content": user_text, "user_role": role}
    )

    refresh_chat()

    input_box.value = ""

    # show typing indicator
    typing_label = ui.label("Assistant is typing...").classes('text-gray-500 italic')
    await asyncio.sleep(0.1)

    # call backend
    try:
        response = requests.post(
            BACKEND_URL,
            json={
                "history": ui.session_state.chat_history,
                "current_role": role
            },
            timeout=15
        )
        data = response.json()
        reply = data.get("reply", "No reply.")
    except Exception as e:
        reply = f"Error: {e}"

    typing_label.delete()

    # add assistant reply
    ui.session_state.chat_history.append(
        {"role": "assistant", "content": reply}
    )

    refresh_chat()


def refresh_chat():
    chat_area.clear()
    for msg in ui.session_state.chat_history:
        display_role = msg.get("user_role", msg['role'])
        label_text = f"{display_role.capitalize()}: {msg['content']}"
        ui.label(label_text, parent=chat_area)


with ui.column().classes('w-1/2 q-pa-md'):

    ui.label("Chat with User Roles (Doctor, Patient, Admin)").classes('text-h5')

    # dropdown to choose role
    role_selector = ui.select(
        options=["doctor", "patient", "admin"],
        value="patient",
        label="Select Role"
    )

    chat_area = ui.column().classes(
        'border rounded p-4 h-64 overflow-y-auto bg-white'
    )

    with ui.row().classes('w-full items-center q-pt-md'):
        input_box = ui.input(
            placeholder="Type your message..."
        ).classes('w-full')
        ui.button("Send", on_click=send_message)

ui.run()
```

---

# ğŸ§¾ Explanation (frontend)

### âœ” Dropdown for selecting role

```python
role_selector = ui.select(
    options=["doctor", "patient", "admin"],
    value="patient",
    label="Select Role"
)
```

The user can now choose who they are.

---

### âœ” Each message now includes the role:

```python
{"role": "user", "content": user_text, "user_role": role}
```

(The backend will use this.)

---

### âœ” Sending role to backend:

```python
json={
    "history": ui.session_state.chat_history,
    "current_role": role
}
```

So the backend knows:

* The full history
* The role of the current speaker

---

### âœ” Displaying role in chat:

```python
display_role = msg.get("user_role", msg['role'])
```

This shows clear labels like:

* Doctor: Please describe your symptoms
* Patient: I have fever
* Admin: Show system logs

---

# â­ PART B â€” Updating FastAPI to handle roles

Now we update the backend so the role influences the AI reply.

---

## ğŸ’» FastAPI backend with role support

Create file: **backend_chat_roles.py**

```python
import os
from fastapi import FastAPI
from pydantic import BaseModel
from openai import OpenAI

app = FastAPI()
client = OpenAI(api_key=os.getenv("OPENAI_API_KEY"))

class ChatMessage(BaseModel):
    role: str
    content: str
    user_role: str | None = None  # doctor/patient/admin (only for user messages)

class ChatRequest(BaseModel):
    history: list[ChatMessage]
    current_role: str

class ChatResponse(BaseModel):
    reply: str

@app.post("/chat", response_model=ChatResponse)
def chat_endpoint(request: ChatRequest):

    # Customize the system message based on the role
    if request.current_role == "doctor":
        system_instruction = "You are an AI medical assistant helping a doctor. Use medical reasoning. Be precise."
    elif request.current_role == "patient":
        system_instruction = "You are an AI assistant helping a patient. Use simple words. Be supportive."
    elif request.current_role == "admin":
        system_instruction = "You are an AI admin assistant. Provide system or workflow related answers."
    else:
        system_instruction = "You are a general assistant."

    # Convert history to OpenAI format
    messages = [{"role": "system", "content": system_instruction}]

    for msg in request.history:
        if msg.role == "assistant":
            messages.append({"role": "assistant", "content": msg.content})
        else:
            # include role inside the message for clarity
            user_prefix = f"{msg.user_role.upper()}: " if msg.user_role else ""
            messages.append({
                "role": "user",
                "content": user_prefix + msg.content
            })

    # call AI
    reply = client.chat.completions.create(
        model="gpt-4o-mini",
        messages=messages
    )

    return ChatResponse(reply=reply.choices[0].message["content"])
```

---

# ğŸ§¾ Explanation (backend)

### âœ” Role-based system messages

```python
if request.current_role == "doctor":
    system_instruction = "You are an AI medical assistant..."
```

This changes the AIâ€™s personality depending on selected role.

* Doctor â†’ clinical, detailed
* Patient â†’ simple, clear
* Admin â†’ system-focused

---

### âœ” History messages include the role

```python
user_prefix = f"{msg.user_role.upper()}: "
```

Example message sent to OpenAI:

```
DOCTOR: The patient is complaining of dizziness.
PATIENT: I feel weak.
ADMIN: Show today's reports.
```

This makes the conversation very structured.

---

### âœ” Final messages sent to OpenAI:

```
system: "You are an AI assistant helping a doctor..."
user: "DOCTOR: The patient has a headache."
assistant: "You may ask about fever or nausea."
user: "DOCTOR: No nausea."
assistant: ...
```

This produces clean, predictable responses.

---

# â–¶ï¸ Running the system

1. Start backend:

```bash
uvicorn backend_chat_roles:app --reload
```

2. Start frontend:

```bash
python chat_frontend_roles.py
```

3. Open browser:

```
http://localhost:8080
```

Try switching roles:

### Patient mode

> â€œI have chest pain.â€
> Bot answers simple, friendly.

### Doctor mode

> â€œPatient has fever, shortness of breath.â€
> Bot replies medically:

> â€œPlease check oxygen saturation and presence of pneumonia signs.â€

### Admin mode

> â€œShow user statistics.â€
> Bot returns:

> â€œSystem logs, user summary, or admin toolsâ€¦â€

---

# ğŸ’¡ Tips & Best Practices

### âœ” Tip 1 â€” Use roles to control AI behavior

This is one of the strongest tools for building medical assistants.

---

### âœ” Tip 2 â€” You can add more roles

For example:

* Receptionist
* Nurse
* Pharmacist

---

### âœ” Tip 3 â€” Store roles in database for real apps

In real use:

* doctor logs in
* patient logs in
* admin logs in

Their role is auto-loaded.

---

# ğŸ‰ Summary

In this lesson, you learned how to:

* add user roles to the NiceGUI chat
* display role labels in the chat
* send user roles to FastAPI
* customize the AI behavior for each role
* maintain these roles inside the conversation context

Your chatbot is now **multi-role aware**, which is essential for medical workflows.

---
