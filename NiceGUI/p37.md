# Lesson 37 – Building a **Diagnostic Workflow UI** in NiceGUI

*(Ask symptoms → get questions → rule out diseases)*

In this lesson you will build a simple **doctor helper screen**:

* Doctor types symptoms and answers collected so far
* Clicks a button: **“Suggest next questions”**
* An AI assistant suggests:

  * Next questions to ask the patient
  * Possible conditions to consider (not a final diagnosis)

> ⚠️ **Important:**
> This is only for **learning and prototyping**, not for real medical use.
> A real doctor must always make the final decision.

---

## 1. What we are going to build

The UI will have:

1. A big text box:
   **“Symptoms & answers so far”**

   * Doctor writes:

     * Chief complaints
     * Answers to previous questions
     * Any important findings

2. A button:
   **“Suggest next questions”**

3. A second text box:
   **“AI assistant output”**

   * AI will suggest:

     * Next questions
     * Possible conditions
     * Red-flag checks

The doctor can:

* Paste or type new patient answers into the first box
* Click the button again
* Repeat this as a **workflow** until they’re satisfied

---

## 2. Simple mental picture (story)

Think of the process like a **detective case**:

* The doctor is the detective
* The patient’s symptoms are the clues
* The AI assistant is an intern:

  * It reads all notes so far
  * Suggests:

    * “Ask about X, Y, Z next”
    * “These 3–4 diseases might fit, but we must check more”

We will use **OpenAI** to play the role of this helper intern.

---

## 3. Install what you need

In your virtual environment:

```bash
pip install nicegui openai
```

Set your OpenAI API key as an environment variable:

**Windows (PowerShell):**

```bash
setx OPENAI_API_KEY "your_api_key_here"
```

**Linux/macOS (bash):**

```bash
export OPENAI_API_KEY="your_api_key_here"
```

---

## 4. Full example code – Diagnostic Workflow UI

Save this as `main.py`:

```python
import os
from openai import OpenAI
from nicegui import ui

# Create OpenAI client using API key from environment
client = OpenAI(api_key=os.getenv("OPENAI_API_KEY"))

# System prompt to control AI behaviour
SYSTEM_PROMPT = """
You are a clinical reasoning assistant helping a qualified doctor.
You DO NOT replace the doctor and you DO NOT give final diagnoses or prescriptions.

Given the symptoms and answers collected so far, you must:

1) Suggest 3-5 next focused questions to ask the patient.
2) List 3-5 possible conditions to consider (differential diagnosis).
3) List any important "red flag" symptoms or signs to check.

Use simple, clear language.
Do not give drug names, doses, or treatment plans.
Always remind that this is only a decision-support tool for the doctor.
"""


def suggest_next_questions():
    """Called when the button is clicked."""
    history_text = history_box.value

    if not history_text.strip():
        ai_box.value = 'Please enter some symptoms or notes first.'
        return

    ai_box.value = 'Thinking... analysing the information so far.'

    try:
        response = client.chat.completions.create(
            model='gpt-4.1-mini',
            messages=[
                {'role': 'system', 'content': SYSTEM_PROMPT},
                {
                    'role': 'user',
                    'content': (
                        "Here is the information gathered so far from the patient:\n\n"
                        f"{history_text}\n\n"
                        "Based on this, suggest:\n"
                        "1) Next questions to ask (max 5)\n"
                        "2) Possible conditions to consider (not a final diagnosis)\n"
                        "3) Red flags to check.\n"
                    )
                },
            ],
        )

        ai_reply = response.choices[0].message.content
        ai_box.value = ai_reply

    except Exception as e:
        ai_box.value = f'Error while calling AI: {e}'


# --------- NiceGUI UI ---------

with ui.card():
    ui.label('Diagnostic Workflow Assistant (Prototype)').classes('text-h6')

    ui.label(
        'Step 1: Type symptoms and patient answers below. '
        'Step 2: Click "Suggest next questions". '
        'Step 3: Add new answers and repeat.'
    ).style('font-size: 0.9rem;')

    # Text area for the full symptom + answer history
    history_box = ui.textarea(
        label='Symptoms & answers so far',
        placeholder=(
            'Example:\n'
            '- Chief complaint: headache for 3 days\n'
            '- Location: left side, above eye\n'
            '- No nausea, no vomiting\n'
            '- Worse with screen use\n'
            '- Some stress at work'
        ),
    ).props('autogrow')

    ui.button('Suggest next questions', on_click=suggest_next_questions)

    # Text area to show AI output (read-only for the user)
    ai_box = ui.textarea(
        label='AI assistant output',
        placeholder='AI suggestions will appear here...',
    ).props('autogrow')

    # Make AI box read-only so user doesn’t accidentally change it
    ai_box.props('readonly')

# Run the app
ui.run()
```

---

## 5. Step-by-step explanation (in simple words)

### 5.1 Imports and client

```python
import os
from openai import OpenAI
from nicegui import ui
```

* `os` → to read the API key from environment
* `OpenAI` → to talk to OpenAI models
* `ui` → to create NiceGUI components (text boxes, buttons, etc.)

```python
client = OpenAI(api_key=os.getenv("OPENAI_API_KEY"))
```

* Reads `OPENAI_API_KEY` from environment
* Creates a `client` object that we will use for all AI calls

---

### 5.2 System prompt (how we control the AI)

```python
SYSTEM_PROMPT = """
You are a clinical reasoning assistant helping a qualified doctor.
...
"""
```

This tells the AI:

* You are **not** the main doctor
* Do **not** give final diagnosis
* Do **not** give drug names or treatment
* Always treat this as **decision support only**

And we tell it how to format its answers:

1. Next questions
2. Possible conditions
3. Red flags

---

### 5.3 The main function: `suggest_next_questions`

```python
def suggest_next_questions():
    history_text = history_box.value
```

* Reads whatever is in the “Symptoms & answers so far” box

```python
    if not history_text.strip():
        ai_box.value = 'Please enter some symptoms or notes first.'
        return
```

* If the doctor has typed nothing, we show a helpful message and stop

```python
    ai_box.value = 'Thinking... analysing the information so far.'
```

* Shows a temporary message while waiting for the AI

---

### 5.4 Calling the OpenAI model

```python
    response = client.chat.completions.create(
        model='gpt-4.1-mini',
        messages=[
            {'role': 'system', 'content': SYSTEM_PROMPT},
            {
                'role': 'user',
                'content': (
                    "Here is the information gathered so far from the patient:\n\n"
                    f"{history_text}\n\n"
                    "Based on this, suggest:\n"
                    "1) Next questions to ask (max 5)\n"
                    "2) Possible conditions to consider (not a final diagnosis)\n"
                    "3) Red flags to check.\n"
                )
            },
        ],
    )
```

* We send two messages:

  * **system** → our control instructions (behaviour rules)
  * **user** → the actual symptom history and what we want back
* We use `gpt-4.1-mini` (you can change to another available model)

```python
    ai_reply = response.choices[0].message.content
    ai_box.value = ai_reply
```

* Takes the first AI response from `choices[0]`
* Puts the text into `ai_box`, so the doctor can read it

If something goes wrong:

```python
except Exception as e:
    ai_box.value = f'Error while calling AI: {e}'
```

* Catches errors and shows a simple error message instead of crashing

---

### 5.5 NiceGUI UI layout

```python
with ui.card():
    ui.label('Diagnostic Workflow Assistant (Prototype)').classes('text-h6')
```

* Creates a card (a neat box)
* Adds a heading label inside

```python
    ui.label(
        'Step 1: Type symptoms and patient answers below. '
        'Step 2: Click "Suggest next questions". '
        'Step 3: Add new answers and repeat.'
    ).style('font-size: 0.9rem;')
```

* Small instruction text to guide the doctor

```python
    history_box = ui.textarea(
        label='Symptoms & answers so far',
        placeholder=(
            'Example:\n'
            '- Chief complaint: headache for 3 days\n'
            '- Location: left side, above eye\n'
            '- No nausea, no vomiting\n'
            '- Worse with screen use\n'
            '- Some stress at work'
        ),
    ).props('autogrow')
```

* Large multi-line text box
* `label` shows above the box
* `placeholder` gives an example
* `.props('autogrow')` makes it expand with more text

```python
    ui.button('Suggest next questions', on_click=suggest_next_questions)
```

* Button that calls `suggest_next_questions` when clicked

```python
    ai_box = ui.textarea(
        label='AI assistant output',
        placeholder='AI suggestions will appear here...',
    ).props('autogrow')

    ai_box.props('readonly')
```

* Second text box where AI output is shown
* `.props('readonly')` → user cannot type here by mistake

Finally:

```python
ui.run()
```

* Starts the NiceGUI server (web app)

---

## 6. How to run and test

1. Install required packages:

   ```bash
   pip install nicegui openai
   ```

2. Set your `OPENAI_API_KEY` in environment.

3. Save the code as `main.py`.

4. Run:

   ```bash
   python main.py
   ```

5. Open the link in your browser (usually `http://127.0.0.1:8080`).

6. Try this test:

   * In **“Symptoms & answers so far”**, paste:

     ```text
     Chief complaint: burning sensation during urination for 3 days.
     No visible blood in urine.
     Mild lower abdominal discomfort.
     No fever reported.
     Patient is male, 45 years old.
     ```

   * Click **“Suggest next questions”**

   * The AI should respond with:

     * Next questions (e.g., frequency, urgency, discharge, sexual history, past UTIs, etc.)
     * Possible conditions (e.g., UTI, prostatitis, etc., but not final)
     * Red flags (e.g., high fever, flank pain, blood in urine)

7. Now ask the patient (in real life, or imagine answers), then:

   * Append answers to the **same** text box
   * Click the button again
   * See how the questions and possibilities evolve

This creates a **simple diagnostic workflow loop**.

---

## 7. Tips & best practices

### Tip 1 – Always remind: this is support, not decision

In real use:

* Show a small message at the bottom like:
  *“This tool only supports clinical reasoning. Final diagnosis and treatment must be done by a qualified doctor.”*

You can add:

```python
ui.label(
    'Note: This assistant is only for decision support. '
    'Doctors must use their own judgement for final diagnosis and treatment.'
).style('font-size: 0.8rem; color: gray;')
```

---

### Tip 2 – Make it more powerful over time

Later you can:

* Save each step to a **database** (visit history)
* Add a **“Generate summary”** button
* Connect to **LangChain** and tools (labs, guidelines, etc.)
* Integrate with your **FastAPI backend** and patient records

---
