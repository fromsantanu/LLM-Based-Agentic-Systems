# Lesson 51: Connecting NiceGUI Frontend with n8n Workflows

In this lesson, you’ll learn how to make your **NiceGUI app talk to an n8n workflow**.

Think of it like this:

* **NiceGUI** = the “face” (UI) where the user types messages or fills forms.
* **n8n** = the “brain” (workflow) that receives the data, calls AI or other APIs, and sends back a reply.

We’ll build a **small chat-style page** where:

1. User types a message in NiceGUI.
2. NiceGUI sends the message to an **n8n webhook** (HTTP POST).
3. n8n returns a reply as JSON.
4. NiceGUI shows the reply in the chat area.

Later, you can reuse this pattern for:

* Diagnostic chat
* Customer support
* Any “agent” workflow in n8n.

---

## 1. Basic idea of the integration

We will use:

* **n8n Webhook node** → gives you a URL like
  `http://localhost:5678/webhook/diagnostic_chat`
* NiceGUI will call this URL using a normal HTTP request (POST), sending JSON.
* n8n will run its workflow and return a JSON response, for example:

```json
{
  "reply": "This is the AI diagnosis."
}
```

We will assume n8n returns a JSON object with a field called `"reply"`.

You can change that easily if your output is different.

---

## 2. Full Example Code (Single File)

Save this file as: **`nicegui_n8n_chat.py`**

```python
from nicegui import ui
import requests  # we use this to call the n8n webhook

# -----------------------------------
# CONFIG: your n8n webhook URL here
# -----------------------------------
# Example: http://localhost:5678/webhook/diagnostic_chat
N8N_WEBHOOK_URL = 'http://localhost:5678/webhook/demo_chat'


# -----------------------------------
# Helper function to call n8n
# -----------------------------------
def call_n8n_workflow(user_message: str) -> str:
    """Send the user's message to n8n and get a reply."""
    try:
        # Prepare JSON payload to send to n8n
        payload = {
            'message': user_message,
            # You can add more fields here:
            # 'doctor_id': 'D123',
            # 'patient_id': 'P456',
        }

        # Make POST request to n8n webhook
        response = requests.post(N8N_WEBHOOK_URL, json=payload, timeout=20)

        # Raise error if status is not 200 OK
        response.raise_for_status()

        data = response.json()

        # We expect n8n to return JSON with a "reply" field
        # Example: { "reply": "Hello from n8n" }
        reply_text = data.get('reply', 'No "reply" field found in n8n response.')
        return reply_text

    except Exception as e:
        # If something goes wrong, show error message
        return f'Error talking to n8n: {e}'


# -----------------------------------
# Main NiceGUI page
# -----------------------------------
chat_history = []  # list of {'sender': 'User'/'Bot', 'text': '...'}


@ui.page('/')
def main_page() -> None:
    # Header
    with ui.header().classes('bg-blue-700 text-white'):
        ui.label('NiceGUI + n8n Chat').classes('text-xl font-bold')
        ui.space()
        ui.label('Frontend connected to n8n workflow')

    # Center content
    with ui.column().classes('w-full items-center p-4'):
        ui.label('Chat with n8n-powered bot').classes('text-lg font-bold mb-2')

        # Chat area
        chat_container = ui.column().classes(
            'border rounded w-full max-w-3xl h-[70vh] p-3 overflow-y-auto bg-gray-50'
        )

        # Function to redraw chat messages
        def refresh_chat():
            chat_container.clear()
            for msg in chat_history:
                ui.chat_message(
                    msg['text'],
                    name=msg['sender'],
                    sent=(msg['sender'] == 'User'),
                )

        # Input area
        with ui.row().classes('w-full max-w-3xl mt-3 items-center'):
            user_input = ui.input(
                placeholder='Type your message...'
            ).classes('w-full').props('type=textarea autogrow')
            send_button = ui.button('Send')

        # Handler to send message to n8n
        def send_to_n8n():
            text = (user_input.value or '').strip()
            if not text:
                ui.notify('Please type something.')
                return

            # Add user message to chat
            chat_history.append({'sender': 'User', 'text': text})
            user_input.value = ''
            refresh_chat()

            # Show small "thinking" spinner
            with chat_container:
                spinner = ui.spinner(size='md').classes('mt-2')
            ui.update()

            # Call n8n workflow
            reply = call_n8n_workflow(text)

            # Remove spinner and add bot reply
            spinner.delete()
            chat_history.append({'sender': 'Bot', 'text': reply})
            refresh_chat()

        # Connect button and Enter key
        send_button.on('click', lambda e: send_to_n8n())

        @user_input.on('keydown.enter')
        async def _enter(event):
            # prevent extra newline and send
            send_to_n8n()

        # Initial welcome message
        chat_history.append({
            'sender': 'Bot',
            'text': 'Hello! I am connected to an n8n workflow. How can I help you?'
        })
        refresh_chat()


# -----------------------------------
# Run the app
# -----------------------------------
ui.run(title='NiceGUI + n8n Demo')
```

---

## 3. How this works (step by step, in simple words)

### 3.1 `N8N_WEBHOOK_URL`

```python
N8N_WEBHOOK_URL = 'http://localhost:5678/webhook/demo_chat'
```

* This should match the **Webhook node URL** in your n8n workflow.
* If your n8n is running on another server, change it, e.g.
  `https://myserver.com/webhook/diagnostic_chat`

---

### 3.2 `call_n8n_workflow()`

```python
payload = {'message': user_message}
response = requests.post(N8N_WEBHOOK_URL, json=payload, timeout=20)
data = response.json()
reply_text = data.get('reply', '...')
```

* We send a JSON body with a `"message"` field.
* n8n will receive this in the Webhook node as JSON.
* n8n should process it (call LLM, etc.) and return JSON like:
  `{"reply": "AI-generated response"}`
* We read this `"reply"` and send it back to the UI.

If anything fails (n8n not running, wrong URL, error in workflow), we catch the exception and show an error message in the chat.

---

### 3.3 NiceGUI UI

* **`chat_history`** is a list of messages.
* Each message has:

  * `sender`: `"User"` or `"Bot"`
  * `text`: message content

```python
def refresh_chat():
    chat_container.clear()
    for msg in chat_history:
        ui.chat_message(
            msg['text'],
            name=msg['sender'],
            sent=(msg['sender'] == 'User'),
        )
```

* We clear the chat area and redraw everything.
* User messages appear on the right (`sent=True`).
* Bot messages appear on the left.

---

### 3.4 Sending the message and calling n8n

```python
def send_to_n8n():
    text = (user_input.value or '').strip()
    ...
    chat_history.append({'sender': 'User', 'text': text})
    ...
    reply = call_n8n_workflow(text)
    chat_history.append({'sender': 'Bot', 'text': reply})
    refresh_chat()
```

Steps:

1. Read input text.
2. Add user message to chat.
3. Show spinner (thinking…).
4. Call `call_n8n_workflow(text)` → talks to n8n.
5. Remove spinner.
6. Add bot reply message to chat.

You can trigger this by:

* Clicking **Send** button
* Pressing **Enter** in the input box

---

## 4. How to run and test

### Step 1: Create an n8n workflow

1. In n8n, create a new workflow.

2. Add a **Webhook** node:

   * Method: `POST`
   * Path: `demo_chat` (or anything you like)
   * That gives you a URL like:
     `http://localhost:5678/webhook/demo_chat`

3. After the Webhook node, add some nodes to process the input.

4. At the end, return JSON like:

   Example using a simple **Function** node:

   ```javascript
   // In n8n Function node
   const message = $json["message"] || "No message";
   return [
     {
       json: {
         reply: `You said: "${message}". This reply came from n8n workflow.`,
       }
     }
   ];
   ```

5. **Activate** the workflow.

---

### Step 2: Run NiceGUI app

1. Install NiceGUI and requests (if not yet):

```bash
pip install nicegui requests
```

2. Save the code as:

```text
nicegui_n8n_chat.py
```

3. Run:

```bash
python nicegui_n8n_chat.py
```

4. Open browser at:

```text
http://localhost:8080
```

5. Type a message and send.

   * You should see:

     * Your message as User
     * n8n’s reply as Bot

If you see an error in the chat:
`Error talking to n8n: ...`
→ check your webhook URL, workflow activation, or n8n server.

---

## 5. Useful tips and next steps

### Tip 1: Send more fields

Instead of sending only `"message"`, you can send:

```python
payload = {
    'message': user_message,
    'doctor_id': 'D123',
    'patient_id': 'P456',
    'conversation_id': 'C789',
}
```

Then in n8n, you can:

* Save logs in DB
* Use conversation_id to continue context
* Pass all this to your LLM.

---

### Tip 2: Support long conversations

You can send **chat_history** (or last few turns) to n8n as well:

```python
payload = {
    'message': user_message,
    'history': chat_history,
}
```

n8n can then feed `history` into the LLM prompt.

---

### Tip 3: Asynchronous / non-blocking

Right now we use `requests.post`, which blocks until n8n replies.

Later, you can:

* Switch to **httpx** async client
* Or use a job ID pattern:

  * First request starts job (n8n), returns job_id
  * Second periodic request asks for status/result

(But for learning, current blocking version is perfectly okay.)

---
