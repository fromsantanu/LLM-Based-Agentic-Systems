# **Lesson 39 – Visualizing AI Reasoning Steps Behind a Diagnosis**

*(Show how the AI is thinking → step-by-step reasoning → summary + next actions)*

In this lesson, you will build a simple UI that shows:

1. **Doctor’s input** – symptoms / answers
2. **AI summary** – short explanation
3. **AI reasoning steps** – why the AI asked certain questions
4. **Possible condition paths** – simple tree-like explanation
5. **Red-flag checks** – what must be ruled out urgently

Think of this as a **transparent glass window** inside the AI’s mind.
Instead of just giving suggestions, the AI explains *why* it is saying those things.

This builds trust and helps doctors review the reasoning.

---

# **1. What we are going to build**

We will create a dashboard with:

### **Left Panel → Doctor Input**

* Text area: **Symptoms & answers so far**
* Button: **“Show AI reasoning”**

### **Right Panel → Output**

* Section 1: **Short Summary**
* Section 2: **Reasoning Steps** (simple, friendly explanation)
* Section 3: **Diagnostic Paths** (like small branches)
* Section 4: **Red Flags**
* Section 5: **Notes for Doctor**

Everything is shown in a clean, readable format.

---

# **2. Simple mental picture**

Imagine you're watching a detective solve a case:

* The detective says:
  **“Because clue A and B exist, I suspect C. But we must check D and E.”**

This lesson creates a small tool where the AI talks like this detective:

* **Summarizes** the case
* **Explains the thinking steps**
* Shows **why certain questions matter**
* Shows **which diseases are being ruled out**
* Marks **danger signs**

This helps the doctor follow the logic.

---

# **3. Install what you need**

In your virtual environment:

```bash
pip install nicegui openai
```

Set your OpenAI key:

**Windows (PowerShell):**

```bash
setx OPENAI_API_KEY "your_api_key"
```

**Linux/macOS:**

```bash
export OPENAI_API_KEY="your_api_key"
```

---

# **4. Full Example Code – Reasoning Visualizer**

Save as `main.py`:

```python
import os
from openai import OpenAI
from nicegui import ui

client = OpenAI(api_key=os.getenv("OPENAI_API_KEY"))

SYSTEM_PROMPT = """
You are a clinical reasoning assistant for a qualified medical doctor.
You DO NOT diagnose finally or prescribe medicines.

Your job is to explain reasoning.

Given patient symptoms and answers, produce the following sections:

1) SHORT SUMMARY (2-3 lines)
   - What is happening so far?

2) REASONING STEPS
   - Explain step-by-step how a doctor thinks.
   - Keep each step simple (like: "Because X, I checked Y").

3) DIAGNOSTIC PATHS
   - List 3–5 possible condition paths.
   - For each path:
       - Why it is possible?
       - What evidence supports it?
       - What questions can confirm or reject it?

4) RED FLAGS TO CHECK
   - Important dangers the doctor must rule out immediately.

5) NOTE FOR DOCTOR
   - Remind that this is only reasoning support.
   - All decisions belong to the doctor.

Do NOT give medicines, drug names, or dose suggestions.
"""


def show_reasoning():
    text = symptom_box.value.strip()

    if not text:
        output_box.value = "Please enter symptoms or patient answers."
        return

    output_box.value = "Analysing reasoning..."

    try:
        response = client.chat.completions.create(
            model="gpt-4.1-mini",
            messages=[
                {"role": "system", "content": SYSTEM_PROMPT},
                {
                    "role": "user",
                    "content": (
                        "Here are the symptoms and answers collected so far:\n\n"
                        f"{text}\n\n"
                        "Please show your reasoning using the structure given earlier."
                    ),
                },
            ],
        )

        ai_reply = response.choices[0].message.content
        output_box.value = ai_reply

    except Exception as e:
        output_box.value = f"Error: {str(e)}"


# -------- NICEGUI UI --------

ui.label("AI Reasoning Visualizer (Diagnostic Support)").classes("text-h5")

with ui.row().classes("w-full"):
    # LEFT PANEL
    with ui.card().classes("w-1/2"):
        ui.label("Input From Doctor").classes("text-h6")

        symptom_box = ui.textarea(
            label="Symptoms & answers so far",
            placeholder=(
                "Example:\n"
                "- Burning urination for 3 days\n"
                "- Mild lower abdominal pain\n"
                "- No fever\n"
                "- Normal appetite\n"
                "- Symptoms worse in the evening"
            ),
        ).props("autogrow")

        ui.button("Show AI reasoning", on_click=show_reasoning)

    # RIGHT PANEL
    with ui.card().classes("w-1/2"):
        ui.label("AI Reasoning Output").classes("text-h6")

        output_box = ui.textarea(
            label="Explanation",
            placeholder="The AI's reasoning will appear here...",
        ).props("autogrow")

ui.run()
```

---

# **5. Step-by-step explanation (simple language)**

### **Imports**

```python
from openai import OpenAI
from nicegui import ui
```

* `OpenAI` → talk to the AI
* `ui` → create the web interface

---

### **System prompt**

```python
SYSTEM_PROMPT = """ ... """
```

This tells the AI:

* Explain the medical reasoning in simple steps
* Do *not* give medicines
* Create clear sections:

  * Summary
  * Reasoning steps
  * Diagnostic paths
  * Red flags
  * Doctor note

---

### **Main function: show_reasoning()**

```python
def show_reasoning():
    text = symptom_box.value.strip()
```

* Reads doctor’s typed notes

```python
if not text:
    output_box.value = "Please enter symptoms..."
```

* If empty → show warning

```python
output_box.value = "Analysing reasoning..."
```

* Temporary message while waiting

---

### **Calling the model**

```python
response = client.chat.completions.create(
    model="gpt-4.1-mini",
    messages=[
        {"role": "system", "content": SYSTEM_PROMPT},
        {"role": "user", "content": ...},
    ],
)
```

* Sends:

  * **system message**: rules
  * **user message**: actual symptoms

```python
ai_reply = response.choices[0].message.content
output_box.value = ai_reply
```

* Extracts the text the AI wrote
* Shows it in the right-side output area

---

### **NiceGUI UI layout**

```python
with ui.row().classes("w-full"):
```

* Split into two vertical halves:

  * Left → doctor input
  * Right → reasoning output

Each side uses a card:

```python
with ui.card().classes("w-1/2"):
```

This keeps the design clean and neat.

---

# **6. How to run and test**

1. Install packages:

   ```bash
   pip install nicegui openai
   ```

2. Save as `main.py`.

3. Run:

   ```bash
   python main.py
   ```

4. Open the link (`http://127.0.0.1:8080`).

5. Try entering:

```
- Headache for 3 days  
- Location: above right eye  
- Worsens with screen use  
- No nausea  
- No fever  
- Mild stress  
```

Click **Show AI reasoning**.

You will see:

* **Short summary**
* **Reasoning steps**
* **Diagnostic paths** like:

  * Migraine-like
  * Eye strain
  * Sinus possibility
* **Red flags**
* **Doctor note**

---

# **7. Tips & Best Practices**

### **Tip 1 — Show the reasoning in collapsible sections**

You can replace the output text area with NiceGUI **expansion panels**.

Example:

* “Summary” (click to open)
* “Reasoning Steps”
* “Diagnostic Paths”
* “Red Flags”

This feels more like a real doctor dashboard.

---

### **Tip 2 — Add a “Download reasoning as PDF” button**

This helps doctors attach the reasoning to the patient record.

---

### **Tip 3 — Combine with Lesson 37**

You can send the reasoning output into the **diagnostic workflow UI**, making it a continuous loop.

---
