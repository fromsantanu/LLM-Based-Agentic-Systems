# Lesson 35 – Calling OpenAI models inside a NiceGUI app

In this lesson you will learn how to:

* Add a simple text box and button in NiceGUI
* Send the user’s text to an OpenAI model (like a chatbot)
* Show the AI’s reply on the page

Think of it like this:
Your NiceGUI page is the **shop counter**, the user is the **customer**, and OpenAI is the **assistant in the storeroom**.
The customer talks at the counter → you pass the question to the assistant → bring back the answer and show it.

---

## 1. What we are going to build

We’ll build a very simple page:

* A text area where the user types a question
* A button: **“Ask AI”**
* A box that shows the AI reply

Something like:

> [ Question text area ]
> (Ask AI button)
> Answer: “...AI reply...”

---

## 2. Basic idea of the code

We will:

1. Create a NiceGUI page
2. Add UI elements (text area, button, label)
3. When the button is clicked:

   * Read the text from the text area
   * Call OpenAI’s API in Python
   * Put the reply text into a label

---

## 3. Install what you need

In your virtual environment:

```bash
pip install nicegui openai
```

You also need your **OpenAI API key**.

Set it as an environment variable (safer than hard-coding):

On Windows (PowerShell):

```bash
setx OPENAI_API_KEY "your_api_key_here"
```

On Linux/macOS (bash):

```bash
export OPENAI_API_KEY="your_api_key_here"
```

Close and reopen your terminal so it takes effect.

---

## 4. Simple NiceGUI + OpenAI example

Save this file as `main.py`:

```python
import os
from openai import OpenAI
from nicegui import ui

# Create the OpenAI client using your API key from environment
client = OpenAI(api_key=os.getenv('OPENAI_API_KEY'))

# This function will be called when the button is clicked
def ask_ai():
    user_text = prompt_input.value  # get text from the text area

    if not user_text.strip():
        answer_label.text = 'Please type something first.'
        return

    answer_label.text = 'Thinking... please wait.'

    # Call the OpenAI model
    response = client.chat.completions.create(
        model='gpt-4.1-mini',   # you can change to another model you have access to
        messages=[
            {'role': 'user', 'content': user_text}
        ]
    )

    ai_reply = response.choices[0].message.content
    answer_label.text = ai_reply  # show the reply on the page


# ----- NiceGUI UI -----

with ui.card():
    ui.label('Simple AI Chat inside NiceGUI')

    # Text area for user question
    global prompt_input  # so we can use it in ask_ai()
    prompt_input = ui.textarea(
        label='Your question to AI',
        placeholder='Type your question here...',
    ).props('autogrow')  # makes the box grow with text

    # Button to send question
    ui.button('Ask AI', on_click=ask_ai)

    # Label to show AI answer
    global answer_label
    answer_label = ui.label('AI answer will appear here.')

# Run the app
ui.run()
```

---

## 5. Line-by-line explanation (in simple words)

### Imports

```python
import os
from openai import OpenAI
from nicegui import ui
```

* `os` → lets us read the API key from environment variables
* `OpenAI` → official Python client to talk to OpenAI
* `ui` → main entry to create NiceGUI components (buttons, text areas, etc.)

---

### Create the OpenAI client

```python
client = OpenAI(api_key=os.getenv('OPENAI_API_KEY'))
```

* `os.getenv('OPENAI_API_KEY')` gets your key from environment
* `OpenAI(...)` creates a helper object that knows how to talk to OpenAI
* We store it in `client` so we can reuse it in our function

---

### Define the button click function

```python
def ask_ai():
    user_text = prompt_input.value  # get text from the text area
```

* `ask_ai` is a function that runs when the button is clicked
* `prompt_input.value` reads whatever the user typed

```python
    if not user_text.strip():
        answer_label.text = 'Please type something first.'
        return
```

* If the user kept it empty (just spaces), we show a message and stop

```python
    answer_label.text = 'Thinking... please wait.'
```

* Show a “loading” message while we talk to OpenAI

```python
    response = client.chat.completions.create(
        model='gpt-4.1-mini',
        messages=[
            {'role': 'user', 'content': user_text}
        ]
    )
```

* We call the **chat completions** endpoint
* `model='gpt-4.1-mini'` chooses the model (you can change it later)
* `messages` is a list; here we send only one message: the user’s text

```python
    ai_reply = response.choices[0].message.content
```

* OpenAI returns several possible replies as “choices”
* We take the first one: `choices[0]`
* Then get its text via `.message.content`

```python
    answer_label.text = ai_reply  # show the reply on the page
```

* Finally we put the reply text into the label on the page

---

### Build the UI with NiceGUI

```python
with ui.card():
    ui.label('Simple AI Chat inside NiceGUI')
```

* `ui.card()` creates a box with a small border and padding
* Inside the card, we add a title label

```python
    global prompt_input
    prompt_input = ui.textarea(
        label='Your question to AI',
        placeholder='Type your question here...',
    ).props('autogrow')
```

* `ui.textarea` creates a multi-line text box
* `label` is the small text above the box
* `placeholder` is the faint hint inside the box
* `.props('autogrow')` makes it grow as you type more lines
* We store it in `prompt_input` so `ask_ai()` can read `.value`

```python
    ui.button('Ask AI', on_click=ask_ai)
```

* Creates a button with text “Ask AI”
* When clicked, it runs the `ask_ai` function

```python
    global answer_label
    answer_label = ui.label('AI answer will appear here.')
```

* Creates a label where we’ll show the AI’s reply
* At first, it just shows a default message

---

### Start the app

```python
ui.run()
```

* This starts the NiceGUI web server
* After this, you open the browser and use the app

---

## 6. How to run and test

1. Make sure you installed the packages:

   ```bash
   pip install nicegui openai
   ```

2. Make sure `OPENAI_API_KEY` is set in your environment.

3. Run the app:

   ```bash
   python main.py
   ```

4. You should see something like:

   ```
   NiceGUI running on http://0.0.0.0:8080
   ```

   or

   ```
   http://127.0.0.1:8080
   ```

5. Open that link in your browser.

6. Type a question like:

   > “Explain diabetes in simple language.”

7. Click **Ask AI**.
   You should see:

   * “Thinking... please wait.”
     then
   * The AI’s answer.

---

## 7. A few simple tips / best practices

1. **Never expose your API key in the browser**

   * Always keep the key on the server side (like we did here)
   * Do not put API key inside HTML or JavaScript sent to the user

2. **Add basic error handling**

   * Sometimes the network fails
   * You can wrap the OpenAI call in `try/except` and show a friendly error message

3. **Limit user input length at first**

   * For beginners, limit very long inputs to avoid big token usage and cost
   * You can check `len(user_text)` before sending

---
