# Lesson 38 – Creating a **Prescription Generator Dashboard** (Structure Only)

In this lesson, you’ll build a small **dashboard** where a doctor can:

* Enter basic patient details
* Write a short diagnosis / assessment
* Write some planning notes
* Click a button: **“Generate draft prescription layout”**
* Get a **well-formatted text** that the doctor can edit, print, or copy

> ⚠️ **Very important:**
> This is only a **formatting / documentation helper**.
> The AI must **NOT** choose medicines, doses, or treatment.
> Only a qualified doctor should decide medicines and final plan.

We will make the AI act like a **“medical documentation assistant”**, not like a doctor.

---

## 1. What we are going to build

The dashboard will have:

**Left side – Input area**

* Patient name
* Age
* Chief complaint
* Assessment / probable diagnosis
* Notes for plan (e.g., “diabetic, avoid XYZ”, “prefers syrup”, etc.)

**Right side – Output area**

* Big text area showing a **draft prescription layout**

  * Sections like:

    * Patient details
    * Visit summary
    * Patient instructions
    * Placeholders for medicines
    * Follow-up advice
  * Doctor can edit this before using

---

## 2. Simple mental picture

Imagine:

* Doctor quickly types:
  “Mr. X, 45 years, burning urine for 3 days, suspected UTI, diabetic, avoid NSAIDs, follow-up after urine report.”

* Clicks: **“Generate draft prescription layout”**

The AI then returns something like:

* Patient details
* Short visit summary for record
* Simple language instructions for the patient
* List like:

  * `[Medicine 1 – to be filled by doctor]`
  * `[Test 1 – to be filled by doctor]`

So AI only helps with **structure and wording**, not actual treatment.

---

## 3. Install what you need

In your virtual environment:

```bash
pip install nicegui openai
```

Set your OpenAI API key:

**Windows (PowerShell):**

```bash
setx OPENAI_API_KEY "your_api_key_here"
```

**Linux/macOS (bash):**

```bash
export OPENAI_API_KEY="your_api_key_here"
```

---

## 4. Full example code – Prescription Generator Dashboard

Save as `main.py`:

```python
import os
from openai import OpenAI
from nicegui import ui

# Create OpenAI client from environment key
client = OpenAI(api_key=os.getenv('OPENAI_API_KEY'))

# System prompt: we restrict the AI strongly
SYSTEM_PROMPT = """
You are a medical documentation assistant helping a licensed doctor.
You DO NOT prescribe medicines and you DO NOT choose drug names, doses, or treatment plans.

Your job:
- Take the doctor’s notes about the patient and visit.
- Create a clear, well-structured prescription / visit summary text.

Rules:
- Do NOT suggest specific drug names or doses.
- Instead, use placeholders like:
  [Medicine 1 – to be filled by doctor]
  [Test 1 – to be filled by doctor]
- Focus on structure, clarity, and patient-friendly wording.
- Always remind that medicines and tests must be filled by the doctor.

Output sections (in this order):
1) Patient details
2) Visit summary (doctor language)
3) Patient instructions (simple language)
4) Medicines (as placeholders only)
5) Tests / investigations (placeholders only)
6) Follow-up plan and warning signs
7) Note about doctor responsibility
"""


def generate_prescription():
    """Called when the button is clicked."""
    name = patient_name.value.strip()
    age = patient_age.value.strip()
    complaint = chief_complaint.value.strip()
    assessment = assessment_box.value.strip()
    plan_notes = plan_notes_box.value.strip()

    if not (name and age and complaint):
        output_box.value = 'Please fill at least patient name, age, and chief complaint.'
        return

    output_box.value = 'Preparing draft prescription layout...'

    # Build a simple text summary to send to the AI
    doctor_input = f"""
Patient name: {name}
Age: {age}

Chief complaint:
{complaint}

Doctor's assessment / working diagnosis:
{assessment}

Planning notes / constraints for prescription:
{plan_notes}

Please create a structured prescription layout using the rules given in the system prompt.
Remember: do NOT choose real medicines or doses; use placeholders.
"""

    try:
        response = client.chat.completions.create(
            model='gpt-4.1-mini',
            messages=[
                {'role': 'system', 'content': SYSTEM_PROMPT},
                {'role': 'user', 'content': doctor_input},
            ],
        )

        ai_reply = response.choices[0].message.content
        output_box.value = ai_reply

    except Exception as e:
        output_box.value = f'Error while calling AI: {e}'


# --------- NiceGUI UI ---------

ui.label('Prescription Generator Dashboard (Structure Only)').classes('text-h5')

ui.label(
    'Prototype to help doctors format prescriptions. '
    'This tool does NOT choose medicines or doses. '
    'Doctors must fill medicines and tests themselves.'
).style('font-size: 0.9rem; color: gray;')

with ui.row().classes('w-full'):
    # LEFT SIDE: INPUTS
    with ui.card().classes('w-1/2'):
        ui.label('Visit Input').classes('text-h6')

        patient_name = ui.input(
            label='Patient name',
            placeholder='e.g., Mr. Ramesh Sharma',
        )

        patient_age = ui.input(
            label='Age',
            placeholder='e.g., 45 years',
        )

        chief_complaint = ui.textarea(
            label='Chief complaint',
            placeholder='e.g., Burning urination for 3 days, mild lower abdominal pain...',
        ).props('autogrow')

        assessment_box = ui.textarea(
            label='Assessment / probable diagnosis (doctor language)',
            placeholder='e.g., Suspected uncomplicated lower UTI in a 45-year-old male...',
        ).props('autogrow')

        plan_notes_box = ui.textarea(
            label='Planning notes / constraints for prescription',
            placeholder=(
                'e.g., Diabetic, avoid nephrotoxic drugs;\n'
                'Prefers tablets; No known drug allergies;\n'
                'Consider cost-effective options.'
            ),
        ).props('autogrow')

        ui.button('Generate draft prescription layout', on_click=generate_prescription)

    # RIGHT SIDE: OUTPUT
    with ui.card().classes('w-1/2'):
        ui.label('Draft Prescription (edit before use)').classes('text-h6')

        output_box = ui.textarea(
            label='Generated layout',
            placeholder='Draft prescription layout will appear here...',
        ).props('autogrow')

        # Doctor can edit this, so we keep it writable
        ui.label(
            'Note: Edit this text as needed. '
            'Medicines, doses, and tests must be filled by the doctor.'
        ).style('font-size: 0.8rem; color: gray;')

ui.run()
```

---

## 5. Step-by-step explanation (simple words)

### 5.1 Imports and client

```python
import os
from openai import OpenAI
from nicegui import ui
```

* `os` → read environment variables
* `OpenAI` → talk to the OpenAI models
* `ui` → create NiceGUI UI elements

```python
client = OpenAI(api_key=os.getenv('OPENAI_API_KEY'))
```

* Reads your API key from `OPENAI_API_KEY`
* Creates a `client` so we can call the model

---

### 5.2 System prompt: control the AI

```python
SYSTEM_PROMPT = """
You are a medical documentation assistant...
"""
```

Here we clearly tell the AI:

* You only help with **layout and wording**

* You do **not** pick:

  * drug names
  * doses
  * real treatment

* Use placeholders like `[Medicine 1 – to be filled by doctor]`

* Output must follow fixed sections:

  * Patient details
  * Visit summary
  * Patient instructions
  * Placeholder medicines
  * Placeholder tests
  * Follow-up & warning signs
  * Note about doctor responsibility

This keeps the behaviour safe and predictable.

---

### 5.3 The main function: `generate_prescription`

```python
def generate_prescription():
    name = patient_name.value.strip()
    age = patient_age.value.strip()
    complaint = chief_complaint.value.strip()
    assessment = assessment_box.value.strip()
    plan_notes = plan_notes_box.value.strip()
```

* Reads all the values from the input fields

```python
    if not (name and age and complaint):
        output_box.value = 'Please fill at least patient name, age, and chief complaint.'
        return
```

* We require 3 things before generating:

  * name
  * age
  * chief complaint

```python
    output_box.value = 'Preparing draft prescription layout...'
```

* Temporary message while AI is working

```python
    doctor_input = f"""
    ...
    """
```

* We build a single text string containing:

  * patient details
  * complaint
  * assessment
  * planning notes

This goes as the **user** message to the AI.

```python
        response = client.chat.completions.create(
            model='gpt-4.1-mini',
            messages=[
                {'role': 'system', 'content': SYSTEM_PROMPT},
                {'role': 'user', 'content': doctor_input},
            ],
        )
```

* We send:

  * system message → rules
  * user message → doctor’s notes
* Model: `gpt-4.1-mini` (can be changed)

```python
        ai_reply = response.choices[0].message.content
        output_box.value = ai_reply
```

* Takes the AI’s reply and shows it on the right side

If any error:

```python
    except Exception as e:
        output_box.value = f'Error while calling AI: {e}'
```

* Displays the error message in the output box

---

### 5.4 NiceGUI layout – two columns

```python
ui.label('Prescription Generator Dashboard (Structure Only)').classes('text-h5')
```

* App title at the top

```python
ui.label(
    'Prototype to help doctors format prescriptions. '
    ...
).style('font-size: 0.9rem; color: gray;')
```

* A small safety note

```python
with ui.row().classes('w-full'):
```

* A horizontal row, full width
* Inside this, we put two cards: left and right

#### Left card – inputs

```python
with ui.card().classes('w-1/2'):
    ui.label('Visit Input').classes('text-h6')
```

* Left half of the screen
* Title: “Visit Input”

Then we add:

* `patient_name = ui.input(...)`
* `patient_age = ui.input(...)`
* `chief_complaint = ui.textarea(...)`
* `assessment_box = ui.textarea(...)`
* `plan_notes_box = ui.textarea(...)`

Each with labels and placeholders.

Finally:

```python
ui.button('Generate draft prescription layout', on_click=generate_prescription)
```

* Main button that triggers AI call

#### Right card – output

```python
with ui.card().classes('w-1/2'):
    ui.label('Draft Prescription (edit before use)').classes('text-h6')

    output_box = ui.textarea(
        label='Generated layout',
        placeholder='Draft prescription layout will appear here...',
    ).props('autogrow')
```

* Big text area for the generated text
* Doctor can edit this before using

We also show a note:

```python
ui.label(
    'Note: Edit this text as needed. '
    'Medicines, doses, and tests must be filled by the doctor.'
).style('font-size: 0.8rem; color: gray;')
```

---

## 6. How to run and test

1. Install packages:

   ```bash
   pip install nicegui openai
   ```

2. Set `OPENAI_API_KEY` in your environment.

3. Save the code to `main.py`.

4. Run:

   ```bash
   python main.py
   ```

5. Open the link in your browser (usually `http://127.0.0.1:8080`).

6. Try a test case, for example:

   * **Patient name:**
     `Mr. Ramesh Sharma`
   * **Age:**
     `52 years`
   * **Chief complaint:**
     `Burning urination for 3 days, mild lower abdominal discomfort, no visible blood in urine.`
   * **Assessment / probable diagnosis:**
     `Suspected uncomplicated lower urinary tract infection in a 52-year-old male.`
   * **Planning notes / constraints:**
     `Diabetic; monitor kidney function; avoid nephrotoxic drugs; prefers tablets.`

7. Click **“Generate draft prescription layout”**.

8. You should see:

   * Patient details section
   * Visit summary (doctor language)
   * Simple patient instructions
   * Placeholder lines for medicines & tests
   * Follow-up plan and warning signs
   * Note that doctor must fill medicines/tests

Doctor can then **edit** this text and use it for printing or copying into another system.

---

## 7. Tips & best practices

### Tip 1 – Add a “Copy to clipboard” or “Download” feature later

Once this works, you can:

* Add a “Copy text” button (NiceGUI has clipboard helpers)
* Or generate a simple text/PDF file

### Tip 2 – Combine with your diagnostic workflow

You can connect this with your earlier lessons:

* From the **diagnostic workflow UI**, send the final summary into:

  * `assessment_box` and `plan_notes_box`
* Then generate a structured prescription layout in **one click**

---
