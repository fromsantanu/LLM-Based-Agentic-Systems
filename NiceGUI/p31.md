# **Lesson 31 — Using Background Tasks to Call External Agents (n8n / LangChain)**

### **What you will learn**

In this lesson, you will learn how to let NiceGUI run a long task **in the background** while the user waits calmly on the screen.
This is useful when you call something slow, like:

* an **n8n workflow**
* a **LangChain agent**
* a **remote API** that takes time

You will learn how to:

1. Start a background task
2. Call an external service (n8n or LangChain API)
3. Show a “working…” message
4. Update the UI when the task finishes

---

## **1. Why background tasks are important**

Think of it like ordering food at a restaurant.

* You place an order (this is your NiceGUI button click).
* The kitchen cooks the food (this is your n8n or LangChain agent).
* You do **not** want the waiter (NiceGUI page) to stand frozen waiting for the kitchen.
* Instead, the waiter says, “Please wait while we prepare your food,” and continues serving others.

This is exactly what background tasks do for your app.

---

## **2. Step-by-step plan**

1. User clicks a button on NiceGUI.
2. NiceGUI starts a background task.
3. This task calls an external service (e.g., n8n webhook or LangChain API).
4. When the result arrives, the label on the screen updates.

---

## **3. Example External Agent Endpoint (n8n or LangChain)**

Assume your external agent accepts a POST request:

```
POST http://localhost:5678/webhook/ai-agent
Body: {"message": "hello"}
Reply: {"reply": "AI says hello back!"}
```

(You can replace this with your LangChain API or n8n webhook.)

---

## **4. NiceGUI Code (with Background Task)**

Save this as **`main.py`**.

```python
from nicegui import ui, background_tasks
import requests
import time

def start_task():
    result_label.set_text("Working... please wait")
    background_tasks.create(task_runner)

def task_runner():
    # Pretend the external agent takes time
    time.sleep(1)

    response = requests.post(
        "http://localhost:5678/webhook/ai-agent",
        json={"message": input_box.value}
    )

    reply = response.json().get("reply", "No reply")

    result_label.set_text(f"Agent Reply: {reply}")

ui.label("Enter your question:")
input_box = ui.input()

ui.button("Ask Agent", on_click=start_task)

result_label = ui.label("Waiting for reply...")

ui.run()
```

---

## **5. Line-by-line Explanation (simple words)**

* `background_tasks.create(...)`
  Starts a separate worker to do the slow work.
  This keeps the main screen free and smooth.

* `task_runner()`
  This is where we call the external agent.

* `requests.post(...)`
  Sends your message to n8n or LangChain.

* `result_label.set_text(...)`
  Updates the UI after the background work is done.

* `time.sleep(1)`
  Just simulates delay so you understand what happens during waiting.

---

## **6. How to run and test**

### **Step 1: Run your external agent**

Example:

```
http://localhost:5678/webhook/ai-agent
```

Test it using Postman or browser to ensure it replies.

### **Step 2: Run NiceGUI**

```
python main.py
```

### **Step 3: Open browser**

Visit:

```
http://localhost:8080
```

### **Test it**

1. Type a message
2. Click **Ask Agent**
3. You will see:

   * “Working… please wait”
   * Then the final reply from the agent

This shows background tasks working correctly.

---

## **7. Tips & Best Practices**

### **Tip 1: Always keep agent calls in background tasks**

Never directly call slow APIs inside button handlers.
Otherwise your page freezes like a stuck phone.

### **Tip 2: Add error handling**

External agents sometimes fail.
You can wrap your code like:

```python
try:
    ...
except Exception as e:
    result_label.set_text("Something went wrong")
```

### **Tip 3: Avoid long UI freezes**

If a service takes more than a few seconds, always show a “loading…” message.

---
