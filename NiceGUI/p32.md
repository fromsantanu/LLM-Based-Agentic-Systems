# Lesson 32 — Session Management

**Keeping track of user, patient, and conversation**

---

### 1. What you will learn

In this lesson, you will learn how to **remember things** for each person using your NiceGUI app, such as:

* Who is using the app (user name)
* Which patient they are working with (patient ID)
* The conversation they are having (messages)

This is called **session management**.

You can think of a **session** like a separate notebook for each person:

* When a user opens your app → you give them their own notebook
* In that notebook, you store: user name, patient ID, chat history, etc.
* When they come back to the page → you read from the same notebook

NiceGUI gives us a simple place to store this “notebook”.

---

### 2. Simple real-life example

Imagine you are a doctor using a web app:

* You type **your name**
* You type **patient ID** (for example: PAT123)
* You start typing messages about this patient
* The app should remember:

  * Who you are
  * Which patient you are talking about
  * All the messages you have typed in this session

If another doctor opens the same app on **their own computer**, they should get **their own notebook** and not see your data.

This is what we will build now.

---

### 3. Step-by-step plan

1. Use **NiceGUI storage** to store data for each user
2. Ask for:

   * User name
   * Patient ID
3. Show this information at the top of the page
4. Let the user type messages
5. Save each message into a **conversation list**
6. Display the whole conversation for that session

---

### 4. Code example — Session with user, patient, conversation

Save this as **`main.py`**.

```python
from nicegui import ui, app

def init_session():
    """Make sure the storage has the keys we need."""
    app.storage.user.setdefault('user_name', '')
    app.storage.user.setdefault('patient_id', '')
    app.storage.user.setdefault('conversation', [])

def save_header():
    """Save user and patient info into session storage."""
    app.storage.user['user_name'] = name_input.value
    app.storage.user['patient_id'] = patient_input.value

    header_label.set_text(
        f"User: {app.storage.user['user_name']} | Patient: {app.storage.user['patient_id']}"
    )

def refresh_conversation():
    """Redraw the chat area from stored conversation."""
    chat_column.clear()
    for item in app.storage.user.get('conversation', []):
        sender = item['sender'].capitalize()
        text = item['text']
        with chat_column:
            ui.label(f"{sender}: {text}")

def send_message():
    """Add a new message to the conversation."""
    text = message_input.value.strip()
    if not text:
        return  # do nothing if empty

    # Get the current conversation list from storage
    conversation = app.storage.user.setdefault('conversation', [])

    # Add new message
    conversation.append({
        'sender': 'doctor',
        'text': text,
    })

    # Clear the input box
    message_input.value = ''

    # Update the chat display
    refresh_conversation()


# ---------- UI LAYOUT ----------

# Make sure session storage is ready
init_session()

# Top section: show current user and patient
header_label = ui.label("User: (not set) | Patient: (not set)")

with ui.row():
    name_input = ui.input("Your name")
    patient_input = ui.input("Patient ID")
    ui.button("Save Session Info", on_click=save_header)

ui.separator()

ui.label("Conversation for this user & patient:")

# Area to show conversation
with ui.column() as chat_column:
    pass  # will be filled by refresh_conversation()

# Message input and send button
with ui.row():
    message_input = ui.input("Type message here", on_submit=send_message)
    ui.button("Send", on_click=send_message)

# Load any existing conversation (if already in storage)
refresh_conversation()

ui.run()
```

---

### 5. Explanation in simple words

#### `app.storage.user`

* Think of `app.storage.user` as a **small box of memory** for each user.
* Each user (each browser) gets **its own box**.
* We store:

  * `user_name`
  * `patient_id`
  * `conversation` (a list of messages)

#### `init_session()`

```python
app.storage.user.setdefault('user_name', '')
app.storage.user.setdefault('patient_id', '')
app.storage.user.setdefault('conversation', [])
```

* `setdefault` means:

  * “If this key does not exist, create it with this value.”
  * If it already exists, leave it as it is.

So if the user reloads the page, we **keep** their stored data.

#### `save_header()`

* Takes the values from `name_input` and `patient_input`
* Saves them into `app.storage.user`
* Updates the `header_label` text so the user can see who and which patient they are working with.

#### `conversation` storage

We keep conversation as a **list of dictionaries**:

```python
{
  'sender': 'doctor',
  'text': 'Patient has mild fever for 3 days'
}
```

Multiple such items form a list like:

```python
[
  {'sender': 'doctor', 'text': 'First message'},
  {'sender': 'doctor', 'text': 'Second message'},
]
```

#### `send_message()`

* Reads the text from the input box
* Skips if it is empty
* Appends a new item to `conversation`
* Clears the input box
* Calls `refresh_conversation()` to redraw the chat area

#### `refresh_conversation()`

* Clears `chat_column` (so it does not duplicate old lines)
* Reads the conversation list from storage
* For each message, shows a label like:
  `Doctor: text here`

---

### 6. How to run and test it

1. Make sure NiceGUI is installed:

   ```bash
   pip install nicegui
   ```

2. Save the code in a file called `main.py`.

3. Run the app:

   ```bash
   python main.py
   ```

4. Open your browser and go to:

   ```
   http://localhost:8080
   ```

5. Test it:

   * Type your name in **Your name**
   * Type a patient ID in **Patient ID**
   * Click **Save Session Info**
   * Type a few messages and click **Send** each time
   * You will see the conversation appear in the chat area

6. Open the same URL in **another browser** (or incognito window).

   * You will see that this “new user” has an **empty session**
   * They can enter **their own user name, patient ID, and conversation**

Each one is separate.

---

### 7. Tips & Best Practices

**Tip 1: Keep session data small**
Use session storage for:

* IDs
* Names
* Small history (recent messages)

For large data (many patients, many visits), use a **database**, not session.

---

**Tip 2: Always initialize storage first**
Before using `app.storage.user`, call a function like `init_session()` to make sure keys exist.
This avoids errors like “key not found”.

---

