
# **Chapter 10. Advanced Topics**

ChromaDB is highly flexible and goes beyond standard text embeddings. Once you are comfortable with basic usage, CRUD operations, querying, and persistence, you can explore advanced techniques that extend Chroma’s capabilities to custom use cases. This chapter covers **custom embedding functions, hybrid search, multi-modal embeddings, and fine-tuning** for domain-specific tasks.

---

## 10.1 Custom Embedding Functions

ChromaDB allows you to plug in your own embedding functions instead of relying solely on OpenAI or Hugging Face defaults. This is useful when:

* You want to use an **offline embedding model** (e.g., Sentence Transformers).
* You need embeddings optimized for a **specific language** or **domain**.
* You want to integrate a **custom-trained model**.

### Example: Using Sentence Transformers

```python
from chromadb.utils.embedding_functions import EmbeddingFunction
from sentence_transformers import SentenceTransformer
import chromadb

# Define custom embedding function
class MyEmbeddingFunction(EmbeddingFunction):
    def __init__(self):
        self.model = SentenceTransformer("all-MiniLM-L6-v2")

    def __call__(self, texts):
        return self.model.encode(texts).tolist()

# Setup Chroma client
client = chromadb.Client()
collection = client.create_collection(
    name="custom_embeddings",
    embedding_function=MyEmbeddingFunction()
)

# Insert documents
collection.add(
    documents=["Quantum computing is the future.", "ChromaDB supports custom embeddings."],
    ids=["q1", "q2"]
)
```

**Key idea:** By subclassing `EmbeddingFunction`, you can plug in *any embedding pipeline* that outputs vectors.

---

## 10.2 Hybrid Search (Text + Vectors)

Pure vector search works well for semantic similarity, but sometimes **keyword matching** is also critical (e.g., medical terms, product IDs). Hybrid search combines:

* **Lexical search** (TF-IDF, BM25, keyword match).
* **Vector similarity** (semantic embeddings).

### Strategies for Hybrid Search

1. **Two-step search**:

   * Use keyword search to narrow down candidates.
   * Re-rank results using vector similarity.
2. **Weighted scoring**:

   * Combine lexical and vector scores with a weighted formula.

### Example: Hybrid Pipeline

```python
import chromadb
from rank_bm25 import BM25Okapi

# Step 1: Keyword filtering (BM25)
documents = ["Heart disease symptoms include chest pain.",
             "Diabetes requires long-term monitoring.",
             "Asthma is a chronic lung condition."]

bm25 = BM25Okapi([doc.split() for doc in documents])
keywords = "chest pain"
candidate_indices = bm25.get_top_n(keywords.split(), documents, n=2)

# Step 2: Re-rank with ChromaDB similarity
client = chromadb.Client()
collection = client.create_collection(name="hybrid_demo")
collection.add(documents=documents, ids=["d1", "d2", "d3"])
results = collection.query(query_texts=[keywords], n_results=2)

print("Hybrid Search Results:", results)
```

Hybrid search is particularly useful in **healthcare, legal, and e-commerce** domains where both **precise terms** and **semantic context** matter.

---

## 10.3 Multi-Modal Data (Images, Audio Embeddings)

ChromaDB is not limited to text embeddings—you can store **embeddings for images, audio, or video**. This enables **cross-modal search**, such as:

* Find text descriptions similar to an image.
* Retrieve audio clips that match a query phrase.

### Example: Image Embeddings with CLIP

```python
from sentence_transformers import SentenceTransformer
import chromadb
from PIL import Image

# Load CLIP model
clip_model = SentenceTransformer("clip-ViT-B-32")

# Convert image to embedding
img = Image.open("cat.jpg")
img_embedding = clip_model.encode([img], convert_to_numpy=True).tolist()

# Store in ChromaDB
client = chromadb.Client()
collection = client.create_collection(name="image_embeddings")

collection.add(
    embeddings=img_embedding,
    documents=["A cute cat sitting on a chair."],
    ids=["img1"]
)

# Query with text
query = "feline animal on furniture"
results = collection.query(query_texts=[query], n_results=1)
print("Best match:", results)
```

Multi-modal use cases:

* **E-commerce:** search for products using text or images.
* **Medical imaging:** find similar X-rays or MRI scans.
* **Media archives:** match spoken words with transcripts and videos.

---

## 10.4 Fine-Tuning Embeddings for Domain-Specific Tasks

Pretrained embeddings (OpenAI, Hugging Face) are general-purpose, but **fine-tuning improves performance in specialized domains**:

* Healthcare (medical terms, symptoms).
* Legal documents (contracts, case laws).
* Scientific papers (chemistry, biology).

### Approaches

1. **Domain-specific models:** Use Hugging Face models trained on biomedical/legal corpora (e.g., BioBERT, LegalBERT).
2. **Fine-tuning Sentence Transformers:** Train on domain-specific pairs (e.g., question → answer, paper → abstract).
3. **Supervised fine-tuning with contrastive loss:** Adjust embeddings to cluster relevant documents closer.

### Example: Fine-Tuning Workflow

```python
from sentence_transformers import SentenceTransformer, InputExample, losses
from torch.utils.data import DataLoader

# Step 1: Prepare dataset (pairs of related texts)
train_examples = [
    InputExample(texts=["Hypertension is high blood pressure.", "High BP is hypertension."], label=1.0),
    InputExample(texts=["Diabetes is a metabolic disorder.", "Asthma affects the lungs."], label=0.0),
]

# Step 2: Setup model
model = SentenceTransformer("all-MiniLM-L6-v2")

# Step 3: Training
train_dataloader = DataLoader(train_examples, shuffle=True, batch_size=2)
train_loss = losses.CosineSimilarityLoss(model)
model.fit(train_objectives=[(train_dataloader, train_loss)], epochs=1)

# Step 4: Save and integrate with ChromaDB
model.save("fine_tuned_model")
```

Fine-tuned embeddings can then be loaded as a **custom embedding function** in ChromaDB (as shown in section 10.1).

---

## ✅ Key Takeaways

* **Custom embeddings** let you bring your own models into ChromaDB.
* **Hybrid search** improves retrieval accuracy by combining keyword and semantic search.
* **Multi-modal embeddings** extend ChromaDB to images, audio, and cross-modal tasks.
* **Fine-tuning embeddings** enhances accuracy in specialized domains like medicine, law, and research.

---
