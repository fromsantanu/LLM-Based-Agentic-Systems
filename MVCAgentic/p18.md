# **Chapter 18: Case Study — Business Analytics Chatbot**

### **Objective**

In this chapter, we will design and implement a **Business Analytics Chatbot** capable of converting **natural language queries into SQL queries**, retrieving data from a **PostgreSQL database**, and **visualizing results interactively** using Dash.

---

## **18.1. System Overview**

### **Architecture Layers**

| Layer                  | Technology                              | Purpose                                                             |
| ---------------------- | --------------------------------------- | ------------------------------------------------------------------- |
| **Backend API**        | FastAPI                                 | Handle user input and route requests                                |
| **Database**           | PostgreSQL                              | Store business datasets (e.g., sales, customers, products)          |
| **LangServe Agent**    | LangChain + SQL Toolkit                 | Convert natural language queries to SQL, fetch results              |
| **Frontend Dashboard** | Dash                                    | Provide an interactive web interface for querying and visualization |
| **Integration Flow**   | FastAPI ↔ LangServe ↔ PostgreSQL ↔ Dash | Unified workflow between user, LLM, and data                        |

---

## **18.2. Database Setup (PostgreSQL)**

We’ll use a simple **Sales Analytics Dataset**.

### **Table: sales**

| Column   | Type               | Description          |
| -------- | ------------------ | -------------------- |
| id       | SERIAL PRIMARY KEY | Record ID            |
| date     | DATE               | Date of sale         |
| region   | VARCHAR(50)        | Sales region         |
| product  | VARCHAR(100)       | Product name         |
| quantity | INT                | Number of units sold |
| revenue  | FLOAT              | Total revenue        |

### **Sample Data**

```sql
INSERT INTO sales (date, region, product, quantity, revenue) VALUES
('2024-01-10', 'East', 'Laptop', 10, 50000),
('2024-01-15', 'West', 'Mouse', 50, 5000),
('2024-02-05', 'North', 'Keyboard', 25, 7500),
('2024-02-18', 'South', 'Monitor', 15, 22500);
```

---

## **18.3. FastAPI Routes**

### **app/main.py**

```python
from fastapi import FastAPI
from fastapi.middleware.cors import CORSMiddleware
from routes.chatbot import router as chatbot_router

app = FastAPI(title="Business Analytics Chatbot API")

app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)

app.include_router(chatbot_router, prefix="/api/chatbot")

@app.get("/")
def root():
    return {"message": "Welcome to Business Analytics Chatbot API"}
```

---

## **18.4. Chatbot Route (LangServe Integration)**

### **app/routes/chatbot.py**

```python
from fastapi import APIRouter
from langchain_community.agent_toolkits import create_sql_agent
from langchain_community.utilities import SQLDatabase
from langchain_openai import ChatOpenAI
from langserve import add_routes

router = APIRouter()

# Database Connection
db = SQLDatabase.from_uri("postgresql+psycopg2://user:password@localhost:5432/analytics_db")

# LLM Agent with SQL Toolkit
llm = ChatOpenAI(model="gpt-4-turbo", temperature=0)
sql_agent = create_sql_agent(llm=llm, db=db, verbose=True)

# LangServe Integration
add_routes(router, sql_agent, path="/query")
```

✅ **Endpoint:** `/api/chatbot/query`
This endpoint accepts a **JSON request** with a **natural language question** and returns **SQL results**.

---

## **18.5. Example Query Flow**

### **User Input**

> “Show me the total revenue by region for January 2024.”

### **LangServe Agent Converts To**

```sql
SELECT region, SUM(revenue) 
FROM sales 
WHERE date BETWEEN '2024-01-01' AND '2024-01-31'
GROUP BY region;
```

### **Response**

```json
[
  {"region": "East", "sum": 50000},
  {"region": "West", "sum": 5000}
]
```

---

## **18.6. Dash Frontend for Visualization**

### **dash_app.py**

```python
import dash
from dash import html, dcc, Input, Output, State, dash_table
import requests
import pandas as pd

app = dash.Dash(__name__)
server = app.server  # Expose to FastAPI if needed

API_URL = "http://127.0.0.1:8000/api/chatbot/query/invoke"

app.layout = html.Div([
    html.H1("Business Analytics Chatbot", style={'textAlign': 'center'}),
    dcc.Input(id='query_input', type='text', placeholder='Ask about sales data...', style={'width': '70%'}),
    html.Button('Submit', id='submit_btn'),
    html.Div(id='response_output'),
    dash_table.DataTable(id='result_table'),
    dcc.Graph(id='result_graph')
])

@app.callback(
    [Output('result_table', 'data'),
     Output('result_graph', 'figure')],
    [Input('submit_btn', 'n_clicks')],
    [State('query_input', 'value')]
)
def query_data(n_clicks, query_text):
    if not n_clicks:
        return [], {}
    payload = {"input": query_text}
    response = requests.post(API_URL, json=payload)
    result = response.json()["output"]
    df = pd.DataFrame(result)
    fig = {
        'data': [{'x': df[df.columns[0]], 'y': df[df.columns[1]], 'type': 'bar'}],
        'layout': {'title': 'Query Result'}
    }
    return df.to_dict('records'), fig

if __name__ == "__main__":
    app.run_server(debug=True)
```

---

## **18.7. Workflow Summary**

| Step | Action                                   | Component               |
| ---- | ---------------------------------------- | ----------------------- |
| 1    | User enters a natural language query     | Dash UI                 |
| 2    | Request sent to FastAPI endpoint         | FastAPI                 |
| 3    | LangServe agent interprets query         | LangServe + SQL Toolkit |
| 4    | SQL generated and executed on PostgreSQL | PostgreSQL              |
| 5    | Results returned to Dash frontend        | Dash Visualization      |

---

## **18.8. Enhancements**

* **Caching Layer** (e.g., Redis) to avoid repeated query computation.
* **Authentication** via OAuth2 for access control.
* **Logging** using LangFuse for tracking query and reasoning traces.
* **Additional Dash Features** — Filters, Date Pickers, Export to CSV.
* **Multi-Agent Expansion** — Include agents for Forecasting, Inventory, etc.

---

## **18.9. Example Queries**

| User Query                          | SQL Generated                                                | Chart Type     |
| ----------------------------------- | ------------------------------------------------------------ | -------------- |
| “Show top 5 products by revenue”    | `SELECT product, SUM(revenue)... ORDER BY SUM DESC LIMIT 5;` | Bar Chart      |
| “Monthly revenue trend in 2024”     | `SELECT DATE_TRUNC('month', date)...`                        | Line Chart     |
| “Total sales in North region”       | `SELECT SUM(quantity)... WHERE region='North';`              | Card Summary   |
| “Which region had highest revenue?” | `SELECT region, SUM(revenue)... ORDER BY SUM DESC LIMIT 1;`  | Text/Highlight |

---

## **18.10. Key Learning Points**

* LangServe easily connects LangChain reasoning pipelines with FastAPI routes.
* SQL Toolkit allows **LLM-based querying over structured data**.
* Dash provides an excellent **low-code visualization interface**.
* Combining these, we can deploy **intelligent data assistants** for real-world analytics.

---

## **✅ Summary**

This case study demonstrates a **complete Business Analytics Chatbot** pipeline:

> **Dash (UI)** → **FastAPI (Router)** → **LangServe (LLM Agent)** → **PostgreSQL (Data Source)** → **Visualization**

It lays the foundation for future **multi-agent business intelligence systems** integrating:

* Natural language understanding
* Data-driven reasoning
* Real-time visualization and reporting

---
