# **Chapter 13: Configuration & Environment Management**

### **Overview**

As projects grow, managing configuration details (like database URLs, API keys, and mode switches between development and production) becomes essential.
This chapter explains how to manage configuration safely and flexibly using environment files (`.env`) and **Pydantic Settings**, ensuring that sensitive data never leaks into your codebase.

---

### **13.1 Why Configuration Management Matters**

In small prototypes, it’s common to hard-code database URLs or API keys directly into code.
However, in scalable applications, **this is dangerous** and **not maintainable**.

**Problems with hard-coding:**

* API keys and secrets can leak into GitHub repositories.
* Changing environments (dev → test → prod) becomes difficult.
* Local development may use different credentials or endpoints.

**Solution:**
Use a `.env` file with **Pydantic BaseSettings** to load environment-specific configurations dynamically.

---

### **13.2 Setting Up Environment Files**

1. Create a file named `.env` in your project root:

```bash
project_root/
│
├── app/
│   ├── main.py
│   ├── config.py
│   └── ...
│
└── .env
```

2. Example `.env` content:

```bash
# Application environment
APP_ENV=development
DEBUG=True

# Database URL
DATABASE_URL=sqlite:///./app.db

# OpenAI / LangChain keys
OPENAI_API_KEY=sk-xxxxxxxxxxxxxxxxxxxxxxxxxxxx

# Server settings
HOST=127.0.0.1
PORT=8000
```

⚠️ **Important:** Add `.env` to `.gitignore` to prevent accidental leaks.

```bash
# .gitignore
.env
__pycache__/
```

---

### **13.3 Loading Environment Variables with Pydantic Settings**

Create a file: `app/config.py`

```python
from pydantic_settings import BaseSettings, SettingsConfigDict

class Settings(BaseSettings):
    app_env: str = "development"
    debug: bool = True
    database_url: str
    openai_api_key: str
    host: str = "127.0.0.1"
    port: int = 8000

    model_config = SettingsConfigDict(env_file=".env", env_file_encoding="utf-8")


settings = Settings()
```

Now, you can import and use these values anywhere in your app:

```python
from app.config import settings

print(settings.database_url)
print(settings.openai_api_key)
```

---

### **13.4 Using Environment Variables in FastAPI**

In `main.py`, you can initialize your app differently based on the environment.

```python
from fastapi import FastAPI
from app.config import settings

app = FastAPI(
    title="LangServe + FastAPI App",
    debug=settings.debug
)

@app.get("/")
def home():
    return {
        "message": "Welcome to the Unified LLM Dashboard",
        "environment": settings.app_env
    }
```

---

### **13.5 Switching Between Environments**

You can maintain separate `.env` files for each environment:

```
.env.dev
.env.test
.env.prod
```

And load them conditionally in `config.py`:

```python
import os
from pydantic_settings import BaseSettings, SettingsConfigDict

ENV = os.getenv("APP_ENV", "development")

class Settings(BaseSettings):
    app_env: str = ENV
    debug: bool = (ENV == "development")
    database_url: str
    openai_api_key: str
    host: str = "127.0.0.1"
    port: int = 8000

    model_config = SettingsConfigDict(env_file=f".env.{ENV}", env_file_encoding="utf-8")

settings = Settings()
```

Then, to switch environment:

```bash
# For testing
set APP_ENV=test

# For production
set APP_ENV=prod
```

---

### **13.6 Environment Variables for API Keys (OpenAI, LangChain, etc.)**

Most LLM-based services require API keys (e.g., OpenAI, Anthropic, Hugging Face).
Never embed these directly in code.

Instead, store them in `.env`:

```bash
OPENAI_API_KEY=sk-xxxxx
ANTHROPIC_API_KEY=sk-xxxxx
LANGCHAIN_TRACING_V2=true
LANGCHAIN_ENDPOINT="https://api.smith.langchain.com"
```

And access them dynamically:

```python
import os
from langchain_openai import ChatOpenAI

api_key = os.getenv("OPENAI_API_KEY")
llm = ChatOpenAI(model="gpt-4o", api_key=api_key)
```

---

### **13.7 Integration with LangServe and Streamlit/Dash**

#### **A. LangServe**

When deploying a LangServe app, ensure that your `.env` values are loaded before app startup.

Example in `main.py`:

```python
from fastapi import FastAPI
from langserve import add_routes
from app.config import settings
from app.chains import summarize_chain

app = FastAPI(debug=settings.debug)
add_routes(app, summarize_chain, path="/api/summarize")
```

#### **B. Streamlit**

In `streamlit_app.py`:

```python
import streamlit as st
import os

api_key = os.getenv("OPENAI_API_KEY")

if not api_key:
    st.error("API key not set! Please configure your .env file.")
else:
    st.success("API key loaded successfully.")
```

#### **C. Dash**

In Dash, environment variables can be read directly using `os.getenv()` during app initialization.

---

### **13.8 Deployment and Security Best Practices**

| Environment     | Purpose       | Key Recommendations                                      |
| --------------- | ------------- | -------------------------------------------------------- |
| **Development** | Local testing | Use `.env.dev`, enable debug logs                        |
| **Testing**     | CI/CD and QA  | Use `.env.test`, use dummy keys                          |
| **Production**  | Live system   | Load secrets from server environment, disable debug mode |

**Do’s:**

* Never push `.env` files to GitHub.
* Use Docker secrets or environment variables in production.
* Validate all environment configs using `Pydantic` validation.

---

### **13.9 Example Directory Structure**

```
langserve_app/
│
├── app/
│   ├── main.py
│   ├── config.py
│   ├── chains/
│   │   └── summarize_chain.py
│   └── routes/
│       └── users.py
│
├── .env.dev
├── .env.test
├── .env.prod
├── requirements.txt
└── README.md
```

---

### **13.10 Quick Demo: Validating Configuration**

```python
from app.config import settings

def show_config():
    print("Environment:", settings.app_env)
    print("Database URL:", settings.database_url)
    print("Debug Mode:", settings.debug)
    print("OpenAI Key Available:", bool(settings.openai_api_key))

if __name__ == "__main__":
    show_config()
```

**Output Example:**

```
Environment: development
Database URL: sqlite:///./app.db
Debug Mode: True
OpenAI Key Available: True
```

---

### ✅ **Summary**

In this chapter, you learned how to:

* Use `.env` and **Pydantic Settings** to centralize configuration.
* Manage multiple environments (dev/test/prod).
* Securely load API keys and credentials.
* Integrate environment management into FastAPI, LangServe, Streamlit, and Dash.

---

### **Next Chapter Preview**

**Chapter 14: Logging & Monitoring**

You’ll learn:

* Structured logging with `loguru`
* Logging API calls and errors
* Integrating with LangFuse for tracing LLM calls
* Dashboards for monitoring LangServe endpoints

