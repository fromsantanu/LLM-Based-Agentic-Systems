# 8. Schema Generation for Inter-Agent Contracts

When multiple agents interact in a production workflow, it is crucial to establish **well-defined contracts** for data exchange. Without clear contracts, agents may misinterpret or reject messages, leading to failed handoffs or incorrect actions.

Pydantic provides automatic **JSON Schema generation** from models. These schemas act as **contracts** between agents (or external systems like HIS – Hospital Information System, LIS – Laboratory Information System), ensuring consistency in structure and validation across all interactions.

---

## Why Schema Generation Matters

* **Interoperability**: Different agents or external systems can validate requests and responses against the same schema.
* **Documentation**: JSON schemas serve as self-documenting API contracts.
* **Validation at the boundaries**: Ensures that malformed or incomplete requests are caught before entering the system.
* **Standardization**: Promotes reusability and consistent interpretation across teams and vendors.

---

## Generating JSON Schema from Pydantic Models

Every `BaseModel` in Pydantic can generate its JSON schema using `.model_json_schema()`.

### Example: TestOrderPlacer Agent

Suppose we have an **agent** responsible for placing test orders into an external HIS/LIS.

```python
from typing import Literal, Optional
from pydantic import BaseModel, Field
from datetime import date

class TestOrderPlacerInput(BaseModel):
    patient_id: str = Field(..., description="Unique hospital identifier for the patient")
    test_code: str = Field(..., description="Standardized test code (LOINC, internal code, etc.)")
    order_date: date = Field(..., description="Date when the test is ordered")
    priority: Literal["routine", "urgent", "stat"] = Field(
        "routine", description="Priority of the order"
    )
    clinical_notes: Optional[str] = Field(None, description="Supporting clinical notes")

# Generate JSON schema
schema = TestOrderPlacerInput.model_json_schema()

import json
print(json.dumps(schema, indent=2))
```

---

## Output JSON Schema (excerpt)

The generated schema looks like this (truncated for clarity):

```json
{
  "title": "TestOrderPlacerInput",
  "type": "object",
  "properties": {
    "patient_id": {
      "title": "Patient Id",
      "type": "string",
      "description": "Unique hospital identifier for the patient"
    },
    "test_code": {
      "title": "Test Code",
      "type": "string",
      "description": "Standardized test code (LOINC, internal code, etc.)"
    },
    "order_date": {
      "title": "Order Date",
      "type": "string",
      "format": "date",
      "description": "Date when the test is ordered"
    },
    "priority": {
      "title": "Priority",
      "enum": ["routine", "urgent", "stat"],
      "type": "string",
      "description": "Priority of the order"
    },
    "clinical_notes": {
      "title": "Clinical Notes",
      "type": "string",
      "description": "Supporting clinical notes"
    }
  },
  "required": ["patient_id", "test_code", "order_date", "priority"]
}
```

---

## Using Schema in Multi-Agent Systems

1. **Agent-to-Agent Validation**

   * When the **QueueManager Agent** forwards an order to the **TestOrderPlacer Agent**, it validates the message against this schema before sending.

2. **External HIS/LIS Integration**

   * The schema can be shared with external vendors so their systems know exactly how to format requests.
   * Example: A LIS can reject malformed test orders before processing.

3. **Dynamic Documentation**

   * Schemas can be exported to **OpenAPI** or **FastAPI** docs, automatically exposing the contract to API consumers.

---

## Example in Agent Workflow

Imagine a request arrives from an external HIS:

```json
{
  "patient_id": "H12345",
  "test_code": "LBC-001",
  "order_date": "2025-09-24",
  "priority": "urgent",
  "clinical_notes": "History of chronic cough, rule out TB"
}
```

* The **TestOrderPlacer Agent** checks this payload against the schema.
* If valid, it proceeds to place the order in the LIS.
* If invalid (e.g., missing `patient_id`), the agent rejects the request with a schema validation error.

---

## Key Takeaways

* JSON Schema = **contract** between agents and external systems.
* Pydantic automatically generates schemas from models.
* Contracts reduce ambiguity, increase reliability, and provide documentation for system integrations.
* In healthcare workflows, schemas ensure safety and compliance when exchanging sensitive information.

---

✅ **In the next chapter, we’ll explore how to integrate these schemas into API documentation (e.g., FastAPI + OpenAPI) for smooth deployment of agentic workflows.**

---
