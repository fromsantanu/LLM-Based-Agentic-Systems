# **Lesson 5: Refresh Tokens and Expiration Strategy**

*(Explained in simple and non-technical language)*

---

## **1. Why do access tokens expire quickly?**

When a user logs in, the system gives them a **token** (like a digital pass) to access the app.
But for security reasons, this pass — called the **access token** — usually lasts only for a short time (like 15 or 30 minutes).

This is done so that:

* If someone steals the token, it becomes useless after a short while.
* It helps protect sensitive user data.

So, short expiry = **better safety**.

---

## **2. What happens when the access token expires?**

When the access token expires, the user can’t continue using the protected parts of the app.
But it would be annoying to ask the user to log in again every time, right?

That’s where **refresh tokens** come in.

---

## **3. What is a refresh token?**

A **refresh token** is like a long-term key that helps get a new access token without asking the user to log in again.
It usually lasts much longer — sometimes **days or weeks**.

Here’s the idea:

* When a user first logs in, the system gives **two tokens**:

  1. **Access token** — short-lived (example: 15 minutes)
  2. **Refresh token** — long-lived (example: 7 days)
* When the access token expires, the app quietly sends the refresh token to get a new access token.

---

#### **4. How refresh tokens work (simple flow):**

1. **User logs in**

   * System checks the username and password.
   * If correct → generates both access token and refresh token.
   * Sends both back to the user.

2. **User uses access token**

   * While the token is valid, user can access protected routes (like `/profile`, `/dashboard`).

3. **Access token expires**

   * User sends the refresh token to a special endpoint (like `/refresh`).

4. **Server validates refresh token**

   * If it’s valid, it issues a **new access token** (and sometimes a new refresh token).
   * If it’s invalid or expired, the user must log in again.

---

## **5. Example in FastAPI (simplified)**

Here’s an easy-to-understand example:

```python
from fastapi import FastAPI, Depends, HTTPException
from datetime import datetime, timedelta
import jwt

app = FastAPI()
SECRET_KEY = "mysecret"
ALGORITHM = "HS256"

# Function to create tokens
def create_token(data, expires_in_minutes):
    payload = data.copy()
    payload["exp"] = datetime.utcnow() + timedelta(minutes=expires_in_minutes)
    return jwt.encode(payload, SECRET_KEY, algorithm=ALGORITHM)

@app.post("/login")
def login(username: str, password: str):
    # ✅ Check user credentials (simplified)
    if username == "santanu" and password == "1234":
        access_token = create_token({"sub": username}, 15)   # 15 mins
        refresh_token = create_token({"sub": username}, 60*24*7)  # 7 days
        return {"access_token": access_token, "refresh_token": refresh_token}
    else:
        raise HTTPException(status_code=401, detail="Invalid username or password")

@app.post("/refresh")
def refresh_token(refresh_token: str):
    try:
        payload = jwt.decode(refresh_token, SECRET_KEY, algorithms=[ALGORITHM])
        username = payload.get("sub")
        new_access_token = create_token({"sub": username}, 15)
        return {"access_token": new_access_token}
    except jwt.ExpiredSignatureError:
        raise HTTPException(status_code=401, detail="Refresh token expired. Please log in again.")
    except jwt.InvalidTokenError:
        raise HTTPException(status_code=401, detail="Invalid refresh token.")
```

---

## **6. Summary**

| Concept           | Meaning                             | Lifetime             |
| ----------------- | ----------------------------------- | -------------------- |
| **Access Token**  | Used to access secure routes        | Short (e.g., 15 min) |
| **Refresh Token** | Used to get a new access token      | Long (e.g., 7 days)  |
| **Why Needed**    | To balance security and convenience | —                    |

---

✅ **In short:**
Access tokens keep your app secure.
Refresh tokens keep your users happy by avoiding frequent logins.

---

